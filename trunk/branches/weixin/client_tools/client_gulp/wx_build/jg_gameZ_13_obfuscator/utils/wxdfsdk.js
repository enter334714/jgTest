var Z=wx.$L;import _0x50f672 from"./log";import _0x252543 from"./sdkhttp";!function(){"use strict";function a(){function _0x339023(){this.prefix="df_wxgame_",this.log=new _0x50f672(1)}this.create=function(e){return this.sdk||(this.sdk=new _0x339023,this.sdk.init(e)),this},this.login=function(e=null){this.checkInit()&&this.sdk.login(e)},this.submitData=function(e,a=null){this.checkInit()&&this.sdk.submitData(e,a)},this.pay=function(e,a=null){this.checkInit()&&this.sdk.pay(e,a)},this.messageCheck=function(e,a=null){this.sdk.msgSecCheck(e,a)},this.openCustomerService=function(e=null,a=null){this.sdk.openCustomerService(e,a)},this.onShareAppMessage=function(){this.sdk.onShareAppMessage()},this.shareAppMessage=function(e=null){this.sdk.shareAppMessage(e)},this.onShareTimeline=function(){this.sdk.onShareTimeline()},this.gotoSpecificPage=function(e){this.sdk.gotoSpecificPage(e)},this.requestSubscribe=function(e,a=null){this.sdk.requestSubscribe(e,a)},a.prototype.checkInit=function(){return!!this.sdk||(console.error("\u8bf7\u5148\u4f7f\u7528create\u65b9\u6cd5\u521d\u59cb\u5316"),!1)},_0x339023.prototype.init=function(e){this.opts=this.extend({},{gameId:0,release:!0},e),this.log.info("\u521d\u59cb\u5316\u5b8c\u6210\uff0c\u5f53\u524d\u6e38\u620f\u4e3a\uff1a"+this.opts.gameId),this.cache={};var t=this;return wx.onShow(e=>{e=e.query;var a=e.gdt_vid;a&&(t.cache.gdt_vid=a);let r=e.weixinadinfo;r&&(a=r.split(".")[0],t.cache.gdt_aid=a),e&&(t.cache.game_query=e)}),wx.showShareMenu(),_0x252543.init({data:{game_id:t.opts.gameId}}).then(e=>{var r,s;0==e.code&&(e.data.share_info&&(t.cache.share_info=e.data.share_info),(r=e.data.template_ids)&&0<Object.keys(r).length&&(s={},Object.keys(r).forEach(e=>{let a=r[e];a&&a.hasOwnProperty("template_id")&&(s[e]=a.template_id)}),t.cache.template_ids=s))},e=>{t.log.error(e)}),this},_0x339023.prototype.extend=function(){var e=arguments;var s=function(e){if("object"!=typeof e)return e;if(null==e)return e;var a=new Object;for(var r in e)a[r]=s(e[r]);return a};if(!(e.length<1)){if(e.length<2)return e[0];var a=s(e[0]);for(var r=1;r<e.length;r++)for(var t in e[r])a[t]=e[r][t];return a}},_0x339023.prototype.buildResult=function(e,a="",r=null){e={status:e,msg:a};return r&&(e.data=r),e},_0x339023.prototype.onCallback=function(e,a=0,r="",s=null){e&&"function"==typeof e&&e(this.buildResult(a,r,s))},_0x339023.prototype.showMessage=function(e,a="none"){wx.showToast({title:e,icon:a,duration:2e3})},_0x339023.prototype.showSuccess=function(e){this.showMessage(e,"success")},_0x339023.prototype.showError=function(e){this.showMessage(e,"error")},_0x339023.prototype.saveStorage=function(a,e){try{wx.setStorageSync(this.prefix+a+this.opts.gameId,e)}catch(e){console.error("save "+a+" error")}},_0x339023.prototype.getStorage=function(a,e=""){try{return wx.getStorageSync(this.prefix+a+this.opts.gameId)}catch(e){console.error("get "+a+" error")}return e},_0x339023.prototype.showLoading=function(e){wx.showLoading({title:e})},_0x339023.prototype.hideLoading=function(){wx.hideLoading()},_0x339023.prototype.getOS=function(){var e=2;try{-1<wx.getSystemInfoSync().system.toLowerCase().indexOf("android")&&(e=3)}catch(e){}return e},_0x339023.prototype.login=function(s=null){var t=this;t.log.debug("\u53d1\u8d77\u767b\u5f55"),wx.login({success(e){var a;e.code?(a={},t.cache.game_query&&(a=t.cache.game_query),t.cache.gdt_vid&&(a.gdt_vid=t.cache.gdt_vid),t.cache.gdt_aid&&(a.gdt_aid=t.cache.gdt_aid),a.js_code=e.code,a.game_id=t.opts.gameId,a.os=t.getOS(),_0x252543.auth({data:a}).then(e=>{var a,r;0==e.code?(a=e.data,t.userInfo=a,r=t.cache.template_ids?Object.keys(t.cache.template_ids):[],a.template_ids&&(r=a.template_ids),t.onCallback(s,1,"success",{user_id:a.userID,user_name:a.username,session_id:a.token,open_id:a.openid,sign:a.sign,support_subscribe:r})):(t.showError("\u767b\u5f55\u5931\u8d25"),t.onCallback(s,0,"("+e.code+")"+e.msg))},e=>{t.showError("\u8bf7\u6c42\u767b\u5f55\u5931\u8d25"),t.onCallback(s,0,"\u8bf7\u6c42\u767b\u5f55\u5931\u8d25\uff01"+e)})):(t.showError("\u767b\u5f55\u5931\u8d25"),t.onCallback(s,0,e.errMsg),t.log.info("\u767b\u5f55\u5931\u8d25\uff01"+e.errMsg))},fail(e){t.showError("\u767b\u5f55\u5931\u8d25"),t.onCallback(s,0,e.errMsg),t.log.error(e.errMsg)}})},_0x339023.prototype.submitData=function(e,a=null){var r=this;e.game_id=this.opts.gameId,e.uid=this.userInfo.userID,e.server_id=e.server_id||1,e.type=e.data_type,e.os=this.getOS(),r.saveStorage("server_id",e.server_id),r.saveStorage("role_id",e.role_id),_0x252543.report({data:e}).then(e=>{r.onCallback(a,1,"\u6570\u636e\u4e0a\u62a5\u6210\u529f")},e=>{r.onCallback(a,0,"\u6570\u636e\u4e0a\u62a5\u5931\u8d25")})},_0x339023.prototype.pay=function(s,t=null){var o=this;var i,e;this.userInfo?(o.log.debug("\u53d1\u8d77\u652f\u4ed8"),i=this.getOS(),e={game_id:o.opts.gameId,os:i,openid:o.userInfo.openid,user_id:o.userInfo.userID,role_id:o.getStorage("role_id"),server_id:o.getStorage("server_id")},_0x252543.examineVerify({data:e}).then(e=>{var a,r;0==e.code?(a=e.data.verify,r=e.data.release,o.saveStorage("offer_id",e.data.offer_id),r||(a=0),s.os=i,o.createOrder(a,s,t)):o.onCallback(t,0,"\u4e0b\u5355\u5931\u8d25\u8bf7\u91cd\u8bd5\uff01"+e.msg)},e=>{o.onCallback(t,0,"\u53d1\u8d77\u652f\u4ed8\u5931\u8d25\uff01"+e)})):console.error("\u5f53\u524d\u672a\u767b\u5f55\uff0c\u8bf7\u767b\u5f55\u540e\u91cd\u65b0\u53d1\u8d77\u652f\u4ed8")},_0x339023.prototype.createOrder=function(a,r,s){var t=this;if(0==a&&2==r.os)return t.showMessage("IOS\u6682\u4e0d\u652f\u6301\u652f\u4ed8"),void t.onCallback(s,100,"IOS\u6682\u4e0d\u652f\u6301\u652f\u4ed8\u529f\u80fd");r.game_id=t.opts.gameId,r.openid=t.userInfo.openid,r.user_id=t.userInfo.userID;var e={game_id:r.game_id,userID:r.user_id,user_name:t.userInfo.username,openid:r.openid,server_id:r.server_id||1,roleId:r.role_id,role_name:r.role_name,ext:r.ext,money:r.money,game_gold:r.game_gold||100*r.money,os:r.os};_0x252543.createOrder({data:e}).then(e=>{0==e.code?(r.orderid=e.data.orderID,e.data.pay_url&&(r.pay_url=e.data.pay_url),0==a?t.payByMidas(r,s):1==a?(e.data.icon_url&&(r.icon_url=e.data.icon_url),t.payByCustomerService(r,s)):2==a?(r.mp_appid=e.data.mp_appid,e.data.app_path&&(r.app_path=e.data.app_path),e.data.env_version&&(r.env_version=e.data.env_version),t.payByMiniProgram(r,s)):t.payByBrowser(r,s)):t.onCallback(s,0,"\u521b\u5efa\u8ba2\u5355\u5931\u8d25\uff01"+e.msg)},e=>{t.onCallback(s,0,"\u521b\u5efa\u8ba2\u5355\u5931\u8d25\uff01"+e)})},_0x339023.prototype.payByMidas=function(a,r=null){var s=this;function Sa(){_0x252543.payMidas({data:a}).then(e=>{if(e.errcode&&0!=e.errcode)return s.showMessage("\u652f\u4ed8\u672a\u5b8c\u6210"),void s.onCallback(r,0,"\u652f\u4ed8\u5931\u8d25\uff01"+e.errcode);s.showMessage("\u652f\u4ed8\u5b8c\u6210"),s.onCallback(r,1,"\u652f\u4ed8\u5b8c\u6210",{order_id:a.orderid})},e=>{s.showMessage("\u652f\u4ed8\u672a\u5b8c\u6210"),s.onCallback(r,0,"\u652f\u4ed8\u5931\u8d25\uff01"+e)})}_0x252543.balance({data:{game_id:this.opts.gameId,openid:this.userInfo.openid}}).then(e=>{0==e.errcode?(s.log.debug(e),e.balance>=100*a.money?Sa():(s.log.debug(a),wx.requestMidasPayment({mode:"game",env:e.env,offerId:s.getStorage("offer_id"),currencyType:"CNY",buyQuantity:100*a.money,platform:"android",zoneId:1,success(e){Sa()},fail(e){s.onCallback(r,0,"("+e.errCode+")"+e.errMsg)}}))):s.onCallback(r,0,"("+e.errcode+")"+e.errmsg)},e=>{s.showError("\u652f\u4ed8\u5931\u8d25\u8bf7\u91cd\u8bd5"),s.onCallback(r,0,"\u652f\u4ed8\u5931\u8d25\u8bf7\u91cd\u8bd5\uff01"+e)})},_0x339023.prototype.payByCustomerService=function(a,r=null){var s=this;if(!a.pay_url)return s.showMessage("\u83b7\u53d6\u652f\u4ed8\u94fe\u63a5\u6709\u8bef"),void s.onCallback(r,0,"\u652f\u4ed8\u94fe\u63a5\u6709\u8bef");var e=a.pay_url;wx.setClipboardData({data:"\u8ba2\u5355\u53f7: "+a.orderid+"\n\u5145\u503c\u94fe\u63a5: "+e+"\n\n\u70b9\u51fb\u4ee5\u4e0a\u94fe\u63a5\u5373\u53ef\u5145\u503c\uff0c\u82e5\u9047\u5230\u5145\u503c\u95ee\u9898\uff0c\u8bf7\u53ca\u65f6\u8054\u7cfb\u5ba2\u670d\u3002",success(e){wx.showModal({title:"\u5145\u503c\u6559\u7a0b",content:"\u5145\u503c\u94fe\u63a5\u5df2\u7ecf\u590d\u5236\uff0c\u8bf7\u70b9\u51fb\u786e\u5b9a\u524d\u5f80\u5ba2\u670d\u4e2d\u5fc3\uff0c\u5982\u679c\u6ca1\u6709\u81ea\u52a8\u6536\u5230\u8ba2\u5355\u5165\u53e3\uff0c\u8bf7\u7c98\u8d34\u5e76\u53d1\u9001\u5185\u5bb9\u83b7\u53d6\u652f\u4ed8\u94fe\u63a5\u5165\u53e3",showCancel:!1,success(e){e.confirm&&wx.openCustomerServiceConversation({sessionFrom:"",showMessageCard:!0,sendMessageTitle:"\u83b7\u53d6\u5145\u503c\u5730\u5740",sendMessagePath:"wxgamepay/orderid/"+a.orderid,sendMessageImg:a.icon_url||"https://image.dfkj8.com/pic/concect_kf.png",success(e){},fail(e){s.log.debug(e.errMsg),s.onCallback(r,0,e.errMsg)}})}})}})},_0x339023.prototype.payByMiniProgram=function(e,a=null){var r=this;if(!e.mp_appid)return r.showMessage("\u652f\u4ed8\u8df3\u8f6c\u5931\u8d25"),void r.onCallback(a,0,"\u652f\u4ed8\u8df3\u8f6c\u5931\u8d25");wx.navigateToMiniProgram({appId:e.mp_appid,path:e.app_path||"pages/pay/index",envVersion:e.env_version||"release",extraData:e,success(e){r.log.debug("\u8df3\u8f6c\u5c0f\u7a0b\u5e8f\u6210\u529f:"+e)},fail(e){r.log.debug("\u8df3\u8f6c\u5c0f\u7a0b\u5e8f\u5931\u8d25:"+e),r.onCallback(a,0,e.errMsg)}})},_0x339023.prototype.payByBrowser=function(e,a){if(!e.pay_url)return this.showMessage("\u83b7\u53d6\u652f\u4ed8\u94fe\u63a5\u6709\u8bef"),void this.onCallback(a,0,"\u652f\u4ed8\u94fe\u63a5\u6709\u8bef");wx.setClipboardData({data:e.pay_url,success(e){wx.showModal({title:"\u5145\u503c\u94fe\u63a5\u5df2\u590d\u5236",content:"\u8bf7\u5728\u5916\u90e8\u6d4f\u89c8\u5668\u7c98\u8d34\u5145\u503c\u94fe\u63a5\u540e\u652f\u4ed8",showCancel:!1,success(e){}})}})},_0x339023.prototype.msgSecCheck=function(e,r){var s=this;e={game_id:s.opts.gameId,content:e.content,openid:s.userInfo&&s.userInfo.openid?s.userInfo.openid:""};_0x252543.msgSecCheck({data:e}).then(e=>{var a=0==e.errcode;s.onCallback(r,1,e.errmsg,{passed:a})},e=>{s.onCallback(r,0,"\u8bf7\u6c42\u5931\u8d25\u8bf7\u91cd\u8bd5\uff01"+e)})},_0x339023.prototype.openCustomerService=function(e=0,a=null){var r=this;wx.openCustomerServiceConversation({sessionFrom:"",showMessageCard:!1,sendMessageTitle:"",sendMessagePath:"",sendMessageImg:"",success(e){r.log.debug(e)},fail(e){r.log.debug(e.errMsg),r.onCallback(a,0,e.errMsg)}})},_0x339023.prototype.getDefaultShareInfo=function(){return this.extend({},{share_title:"",share_img_url:"",share_img_id:"",share_query:"",share_img_preview_url:"",share_img_preview_id:""},this.cache.share_info||{})},_0x339023.prototype.onShareAppMessage=function(){var e=this;var a=this.getDefaultShareInfo();wx.onShareAppMessage(function(){return e.log.debug("onShareAppMessage"),{title:a.share_title||"",imageUrl:a.share_img_url||"",query:a.share_query||"",imageUrlId:a.share_img_id||""}})},_0x339023.prototype.shareAppMessage=function(e=null){var a=this;var r=this.getDefaultShareInfo();r=this.extend({},r,e||{}),wx.shareAppMessage(function(){return a.log.debug("shareAppMessage"),{title:r.share_title||"",imageUrl:r.share_img_url||"",query:r.share_query||"",imageUrlId:r.share_img_id||""}})},_0x339023.prototype.onShareTimeline=function(){var e=this;var a=this.getDefaultShareInfo();wx.onShareTimeline(function(){return e.log.debug("onShareTimeline"),{title:a.share_title||"",imageUrl:a.share_img_url||"",query:a.share_query||"",imageUrlId:a.share_img_id||"",imagePreviewUrl:a.share_img_preview_url||"",imagePreviewUrlId:a.share_img_preview_id||""}})},_0x339023.prototype.gotoSpecificPage=function(e){var a=this;e?(e={game_id:a.opts.gameId,user_id:a.userInfo&&a.userInfo.userID?a.userInfo.userID:"",user_name:a.userInfo&&a.userInfo.username?a.userInfo.username:"",openid:a.userInfo&&a.userInfo.openid?a.userInfo.openid:"",os:a.getOS(),action:e},_0x252543.specificPage({data:e}).then(e=>{0==e.code?e.data&&(e.data.copyData&&wx.setClipboardData({data:e.data.copyData,success(e){}}),wx.openCustomerServiceConversation({sessionFrom:e.data.sessionFrom,showMessageCard:e.data.showMessageCard,sendMessageTitle:e.data.sendMessageTitle,sendMessagePath:e.data.sendMessagePath,sendMessageImg:e.data.sendMessageImg,success(e){},fail(e){a.showMessage("\u8df3\u8f6c\u5931\u8d25"),a.log.error(e.errMsg)}})):a.showMessage(e.msg||"\u4e0d\u652f\u6301\u7684\u65b9\u5f0f")},e=>{a.showMessage("\u8df3\u8f6c\u5931\u8d25"),a.log.error(e)})):a.log.error("\u8bf7\u4f20\u5165action")},_0x339023.prototype.requestSubscribe=function(e,s=null){var t=this;var o={};e&&0<e.length&&t.cache.template_ids&&0<Object.keys(t.cache.template_ids).length&&e.forEach(e=>{t.cache.template_ids.hasOwnProperty(e)&&(o[t.cache.template_ids[e]]=e)}),o&&0!=Object.keys(o).length?wx.onTouchEnd(function(e,a,r){wx.requestSubscribeMessage({tmplIds:Object.keys(o),success(a){var r=[];Object.keys(a).forEach(e=>{o.hasOwnProperty(e)&&"accept"==a[e]&&r.push(o[e])}),t.onCallback(s,1,"success",r)},fail(e){t.onCallback(s,0,"\u8ba2\u9605\u5931\u8d25("+e.errCode+")"+e.errMsg)}})}):t.onCallback(s,0,"\u8ba2\u9605\u6a21\u677f\u4e3a\u7a7a")}}var e=new a;module.exports.dfSDK=e}();