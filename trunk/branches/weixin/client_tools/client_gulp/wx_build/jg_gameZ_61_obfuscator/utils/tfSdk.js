var XingYunCryptoJS=require("./tfEncryptUtil.js"),common_md5=require("./commonMd5.js"),XingYunTFSdk={base_url:"",app_id:"",package_name:"",company_id:"",sign_key:"",idfa:"",caid:"",user_id:"",wx_open_id:"",wx_union_id:"",is_show_log:0,refer:"",XingYun_Resp_Success_Code:7,XingYun_Resp_Fail_code:4,public_config:{open:{type:"every_time",score:0,disabled:!1},login:{type:"every_time",score:0,disabled:!0},create_account:{type:"one_time",score:0,disabled:!0},create_role:{type:"one_time",score:0,disabled:!0},enter_game:{type:"every_time",score:0,disabled:!0},post_pay:{type:"every_time",score:0,disabled:!0},pay:{type:"every_time",score:0,disabled:!0},bind_mobile:{type:"one_time",score:0,disabled:!0},bind_idcard:{type:"one_time",score:0,disabled:!0},d1:{type:"one_time",score:0,disabled:!0},online:{type:"every_time",score:0,disabled:!1},upgrade:{type:"every_time",score:0,disabled:!1}},TFEventType:{OPEN:"open",ENTER:"enter_game",POST_PAY:"post_pay",PAY:"pay",CREATE_ROLE:"create_role",CREATE_ACCOUNT:"create_account",LOGIN:"login",UPGRADE:"upgrade",ONLINE:"online",BIND_PHONE:"bind_mobile",BIND_IDCARD:"bind_idcard",D1:"d1",KBI:"kbi"},adClickReport:function(){var n,e,i,t,o;null==this.base_url||this.base_url.length<11?console.log("no report url,no use function"):(n=wx.getLaunchOptionsSync().query,e=void console.log("launchQuery",n),i=void 0,n&&n.gdt_vid&&(e="gdt_vid="+n.gdt_vid+"&weixinadinfo="+n.weixinadinfo+"&weixinadkey="+n.weixinadkey+"&scene_type="+n.scene_type,i="guangdiantong"),n&&n.clue_token&&(e="callback="+n.clue_token+"&ad_id="+n.ad_id+"&ttCreativeId="+n.creative_id,(o=n.req_id)&&(e+="&req_id="+o),i="toutiao"),n&&n.callback&&(e="callback="+n.callback,i="kuaishou"),t=this,i&&e&&10<e.length?(o=this.base_url+"/sdk/ad/click/"+this.app_id+"/"+i+"/"+this.company_id,e=(e+="&open_id="+this.wx_open_id)+"&union_id="+this.wx_union_id,XingYunTFSdk.XingYunGetAsync(o+="?"+e,function(n,e){t.tfRegister()})):this.tfRegister())},d1Report:function(){var n=new Date,n=12*n.getMonth()+n.getDate(),e=XingYunTFSdk.XingYunLocalStorage.getItem("XingYun"+this.TFEventType.D1);1e3!=e&&(e&&n-e==1?(this.tfEvent(this.TFEventType.D1,"",""),XingYunTFSdk.XingYunLocalStorage.setItem("XingYun"+this.TFEventType.D1,1e3)):XingYunTFSdk.XingYunLocalStorage.setItem("XingYun"+this.TFEventType.D1,n))},tfInit:function(n,e,i,t,o,g,d,u,a){XingYunTFSdk.tfShowLog("tfInit init"),XingYunTFSdk.base_url=n,XingYunTFSdk.app_id=e,XingYunTFSdk.package_name=i,XingYunTFSdk.company_id=t,XingYunTFSdk.sign_key=o,XingYunTFSdk.wx_open_id=d,XingYunTFSdk.wx_union_id=u,XingYunTFSdk.idfa="",XingYunTFSdk.caid="",XingYunTFSdk.user_id=g;n=wx.getSystemInfoSync();n&&(XingYunTFSdk.refer=n.platform);e=(e=XingYunTFSdk.XingYunLocalStorage.getItem("openCount"))&&"undefined"!=e&&"NaN"!=e?parseInt(e)+1:1;XingYunTFSdk.XingYunLocalStorage.setItem("openCount",e),XingYunTFSdk.openCount=e;!XingYunTFSdk.XingYunLocalStorage.getItem("kbi_config")&&a&&XingYunTFSdk.XingYunGetAsync(a,function(n,e){e===XingYunTFSdk.XingYun_Resp_Success_Code&&XingYunTFSdk.XingYunLocalStorage.setItem("kbi_config",n)}),this.adClickReport();var r=setTimeout(function(){setInterval(function(){clearTimeout(r),XingYunTFSdk.tfShowLog("heartbeat"),XingYunTFSdk.tfEvent("online","5")},3e5)},6e4)},tfSetUserId:function(n){XingYunTFSdk.user_id=n},tfShowLog:function(...n){1==this.is_show_log&&console.log(n)},tfInitEvent:function(){XingYunTFSdk.tfEvent(XingYunTFSdk.TFEventType.OPEN,""),XingYunTFSdk.tfCreateAccountEvent(XingYunTFSdk.TFEventType.CREATE_ACCOUNT,XingYunTFSdk.user_id,""),XingYunTFSdk.tfEvent(XingYunTFSdk.TFEventType.LOGIN,XingYunTFSdk.user_id,""),XingYunTFSdk.d1Report()},tfRegister:function(){try{if(null==XingYunTFSdk.base_url||XingYunTFSdk.base_url.length<5)return void console.log("没填参数，不接入此功能");var i,n,t,o;XingYunTFSdk.tfShowLog("register"),XingYunTFSdk.XingYunLocalStorage.getItem("device_id")?(XingYunTFSdk.tfShowLog("device_id存在，直接进行open上报"),XingYunTFSdk.device_id=XingYunTFSdk.XingYunLocalStorage.getItem("device_id"),XingYunTFSdk.click_id=XingYunTFSdk.XingYunLocalStorage.getItem("click_id"),this.tfInitEvent()):(XingYunTFSdk.tfShowLog("device_id=undefined"),i=XingYunTFSdk.base_url+"/sdk/regirest",(n=new Map).set("app_id",XingYunTFSdk.app_id),n.set("package_name",XingYunTFSdk.package_name),n.set("company_id",XingYunTFSdk.company_id),n.set("open_id",XingYunTFSdk.wx_open_id),n.set("union_id",XingYunTFSdk.wx_union_id),t=!0,n.forEach(function(n,e){t?(t=!1,i+="?"+e+"="+n):i+="&"+e+"="+n}),XingYunTFSdk.tfShowLog("url="+i),o=this,XingYunTFSdk.XingYunGetAsync(i,function(e,n){if(n===XingYunTFSdk.XingYun_Resp_Success_Code)try{var i=JSON.parse(e);XingYunTFSdk.device_id=i.device_id,XingYunTFSdk.click_id=i.click_id,XingYunTFSdk.XingYunLocalStorage.setItem("device_id",i.device_id),XingYunTFSdk.XingYunLocalStorage.setItem("click_id",i.click_id),o.tfInitEvent()}catch(n){console.log("xingyun init request error:"+e)}})),console.log("device_id:"+XingYunTFSdk.device_id)}catch(n){console.log(n)}},tfCreateAccountEvent(n,e,i){var t=XingYunTFSdk.XingYunLocalStorage.getItem(n+e);e&&e!=t?this.tfEvent(n,e,i):XingYunTFSdk.tfShowLog("this account already report:"+e)},tfEvent:function(i,t,n){try{var e=XingYunTFSdk.XingYunLocalStorage.getItem("kbi_config"),o=(XingYunTFSdk.tfShowLog("localKbiConfig"+e+"end"),void 0),o=e?JSON.parse(e):this.public_config,g=parseInt(XingYunTFSdk.XingYunLocalStorage.getItem(i+"_time"))||0;if(!o[i])return void XingYunTFSdk.tfShowLog("事件类型不存在："+i);if(XingYunTFSdk.device_id)if(o[i].type){if(g++,XingYunTFSdk.XingYunLocalStorage.setItem(i+"_time",g),"one_time"===o[i].type&&1<g)return;var d=parseInt(XingYunTFSdk.XingYunLocalStorage.getItem("kbi_score"))||0,u=(d+=parseInt(o[i].score),{}),a=new Array,r=(u.action_name=i,u.log_time=this.XingYunGetFormatTime(),u.user_id=XingYunTFSdk.user_id,u.value=t,u.device_id=XingYunTFSdk.device_id,u.click_id=XingYunTFSdk.click_id,u.ua=navigator.userAgent,u.open_id=XingYunTFSdk.wx_open_id,u.union_id=XingYunTFSdk.wx_union_id,u.unique=n||"",u.index=XingYunTFSdk.openCount,u.refer=XingYunTFSdk.refer,u.t=parseInt((new Date).getTime()/1e3),a.push(u),XingYunTFSdk.XingYunLocalStorage.getItem("cacheEvent")),c=(XingYunTFSdk.XingYunLocalStorage.removeItem("cacheEvent"),r&&"undefined"!=r&&"NaN"!=r&&(a=JSON.parse(r).concat(a)),JSON.stringify(a)),s={},S={},Y=(S.appId=XingYunTFSdk.app_id,S.packageName=XingYunTFSdk.package_name,S.companyId=XingYunTFSdk.company_id,S.sign=common_md5(c+XingYunTFSdk.sign_key),s.headers=S,s.content=c,void 0);try{Y=this.XingYunEncryptByDES(JSON.stringify(s),"asdf1234")}catch(n){return console.log("eventType:"+i,n),void XingYunTFSdk.saveEventToLocal(c)}var X=XingYunTFSdk.base_url+"/sdk/v3/event";XingYunTFSdk.XingYunPostAsync(X,Y,function(n,e){200===n?(XingYunTFSdk.TFEventType.CREATE_ACCOUNT==i&&XingYunTFSdk.XingYunLocalStorage.setItem(XingYunTFSdk.TFEventType.CREATE_ACCOUNT+t),XingYunTFSdk.tfShowLog("success: "+n+"-eventType:"+i)):(console.log("failed: "+n+"-eventType:"+i),XingYunTFSdk.saveEventToLocal(c))}),XingYunTFSdk.XingYunLocalStorage.setItem("kbi_score",d),100<=d&&XingYunTFSdk.tfEvent("kbi","")}else console.log("config not report this event:"+i);else console.log("device_id是空，无法上报："+i)}catch(n){console.log(n),XingYunTFSdk.XingYunLocalStorage.removeItem("kbi_config")}},XingYunGetAsync:function(n,i){XingYunTFSdk.tfShowLog("XingYunGetAsync",n);var t=new XMLHttpRequest;t.open("GET",n,!0),t.send(),t.onreadystatechange=function(){if(4==t.readyState)if(200<=t.status&&t.status<300){var e=t.response;let n=t.responseText;e&&"object"==typeof e&&(n=JSON.stringify(e)),i(n,XingYunTFSdk.XingYun_Resp_Success_Code)}else i("network error",XingYunTFSdk.XingYun_Resp_Fail_code)}},XingYunPostAsync:function(n,e,t){XingYunTFSdk.tfShowLog("XingYunPostAsync",n,e);var o=new XMLHttpRequest;o.open("POST",n,!0),o.send(e),o.onreadystatechange=function(){var n,e,i;4==o.readyState&&(e="response error",200==(n=o.status)&&(e=o.responseText,(i=o.response)&&"object"==typeof i&&(e=JSON.stringify(i))),t(n,e))}},XingYunGetFormatTime:function(){var n=new Date,e=n.getFullYear(),i=n.getMonth()+1,t=n.getDate();return e+"-"+(i=1<=i&&i<=9?"0"+i:i)+"-"+(t=0<=t&&t<=9?"0"+t:t)+" "+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds()},XingYunEncryptByDES:function(n,e){XingYunTFSdk.tfShowLog(n);var e=XingYunCryptoJS.enc.Utf8.parse(e),i=XingYunCryptoJS.enc.Utf8.parse("12345678"),n=XingYunCryptoJS.DES.encrypt(n,e,{iv:i,mode:XingYunCryptoJS.mode.CBC,padding:XingYunCryptoJS.pad.Pkcs7});return this.XingYunHexToBase644(n.ciphertext.toString())},XingYunDecryptByDES:function(n,e){var e=XingYunCryptoJS.enc.Utf8.parse(e),i=XingYunCryptoJS.enc.Utf8.parse("12345678");return XingYunCryptoJS.DES.decrypt({ciphertext:XingYunCryptoJS.enc.Hex.parse(n)},e,{iv:i,mode:XingYunCryptoJS.mode.CBC,padding:XingYunCryptoJS.pad.Pkcs7}).toString(XingYunCryptoJS.enc.Utf8)},XingYunHexToBase644:function(n){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="",t=0,o=0,g=0;g<n.length;++g)t=t<<4|("A"<=n[g]&&n[g]<="Z"?n.charCodeAt(g)-55:"a"<=n[g]&&n[g]<="z"?n.charCodeAt(g)-87:n.charCodeAt(g)-48),6<=(o+=4)&&(i+=e[t>>>(o-=6)],t&=~(-1<<o));0<o&&(i+=e[t<<=6-o]);var d=i.length%4;if(0<d)for(g=0;g<4-d;++g)i+="=";return i},XingYunLocalStorage:{getItem:function(e){XingYunTFSdk.tfShowLog("getItem",e);try{return wx.getStorageSync(e)}catch(n){console.log("getItem error:"+e,n)}return""},setItem:function(e,n){try{XingYunTFSdk.tfShowLog("setItem",e,n),wx.setStorageSync(e,n)}catch(n){console.log("strong set item error:"+e)}},removeItem:function(e){try{wx.removeStorageSync(e)}catch(n){console.log("removeItem error:"+e,n)}}},saveEventToLocal:function(n){var e=XingYunTFSdk.XingYunLocalStorage.getItem("cacheEvent"),n=JSON.parse(n);e&&"undefined"!=e&&"NaN"!=e&&(e=JSON.parse(e),n=n.concat(e)),n.length<=10?XingYunTFSdk.XingYunLocalStorage.setItem("cacheEvent",JSON.stringify(n)):XingYunTFSdk.XingYunLocalStorage.removeItem("cacheEvent")}};module.exports=XingYunTFSdk;