"use strict";var W=wx.$l;var _Mathfloor=Math.floor;import md5 from"./md5";!function(){function ManualAut(e,n,i){var t=wx.getSystemInfoSync(),a=t.screenWidth,s=t.screenHeight;wx.getSetting({success:function(e){var o;e.authSetting["scope.userInfo"]||(o=wx.createUserInfoButton({type:"text",text:"",style:{left:0,top:0,width:a,height:s,backgroundColor:"#00000000",color:"#ffffff",fontSize:20,textAlign:"center",lineHeight:s}})).onTap(function(e){e.userInfo?(Object.assign({},{encrpted:e.encryptedData,iv:e.iv},r),wx.getUserInfo({success:function(e){e=e.userInfo;var n={token:i.token,game_id:i.game_id,nick_name:e.nickName,head_img:e.avatarUrl,city:e.city,province:e.province,country:e.country};var t=[];for(var a in n)a=a+"="+n[a],t.push(a);e=t.sort().join("&")+i.client_key;e=md5(e);n.sign=e,adApiReq("/user/login/xcxGetUserInfo",n).then(function(e){o.destroy()})}})):o.destroy()})}})}function adApiReq(t,a){return t?new Promise(function(e,n){wx.request({url:"https://game.andou.com"+t,method:"POST",data:a,header:{"content-type":"application/x-www-form-urlencoded"},success:e,fail:function(e){wx.getNetworkType({success:function(e){e.networkType}}),n(e)},complete:function(){}})}):"url is empty"}var i="https://res.andou.com/andou/static/images/",r={},o="sdk_user",s="0.0.1";module.exports={preInit:function(n,t){return null==(e=n.sdk_ver)||""==e||{}==e?void console.log(""):(s=n.sdk_ver,n.sys_info=wx.getSystemInfoSync(),n.wxOpt=wx.getLaunchOptionsSync(),void adApiReq("/sdk/wxinit",n).then(function(e){console.log("sdk_init_rs: ",e," === initCfg.sdk_ver: ",n.sdk_ver),e&&200===e.statusCode&&200===e.data.code&&1==e.data.data.ab_auth?t&&t(!0):t&&t(!1)}));var e},$LDN:function(t,a){var e=wx.getLaunchOptionsSync();var n;t.cid=e.query.cid||0,t.link_id=e.query.link_id||0,n=t.cid,wx.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]}),wx.onShareAppMessage(()=>({title:"",imageUrl:"",query:"cid="+n,success:e=>{},fail:e=>{}})),t.sdkVersion="1.1.2",s=t.sdk_ver,new Promise(function(n){wx.login({success:function(e){n(e.code)},fail:function(){}})}).then(function(e){return t.game_id<1?void console.log("sub_gid is must contain!"):(t.sys_info=wx.getSystemInfoSync(),t.code=e,t.wxOpt=wx.getLaunchOptionsSync(),t.os=3,void adApiReq("/user/login/xcxLogin",t).then(function(e){var n;console.log("wxQLogin_Request_rs: ",e),e&&200===e.data.status&&200===e.data.status&&(1==e.data.data.get_user_info&&ManualAut(0,0,{token:e.data.data.token,game_id:t.game_id,client_key:t.client_key}),wx.setStorageSync(o,e.data.data),e=Object.assign({},t,e.data.data),e=e,r.game_id||(n=wx.getSystemInfoSync(),r={uid:e.uid,uname:e.uname,game_key:e.game_key,client_key:e.client_key,game_id:e.game_id,adv_cid:e.adv_cid,scene:e.scene,model_type:n.model,device_uniq:e.device_uniq,device_code:e.device_code,mac:"00:00:00:00",resolution:n.windowWidth+"*"+n.windowHeight,os_ver:n.system,sdk_ver:s,net:"none",os:3,system:n.system}),a&&a(!0))}))},function(){console.log("to record db log")})},sdkLogin:function(e){var n=wx.getStorageSync(o);return n?(n.get_unionid&&2==n.get_unionid&&ManualAut(),void(e&&e({uid:n.uid,token:n.token,uname:n.user_name,open_id:n.open_id}))):(console.log(""),"login_err")},sdkReportEvent:function(e){var n=[];for(var t in e){var a;a=t+"="+e[t],"loginType"!=t&&n.push(a)}var o=n.sort().join("&")+r.client_key;var i=md5(o);e.sign=i,adApiReq("/game/play/miniGameRole",e).then(function(e){201==e.data.code&&console.log("\u7b7e\u540d\u53c2\u6570,",o)})},sdkGenOrder:function(e,a){var o=Object.assign({},e,{os_ver:r.os_ver,sdkVersion:"1.1.2"});adApiReq("/pay/wechat/miniPay",o).then(function(e){if(e&&200===e.statusCode&&200===e.data.status){var n=e.data.data;var t;switch(t=0==n.env?"release":"trial",o.out_trade_no=e.data.data.order_id,o.xcx_appid=e.data.data.xcx_appid,n.xyx){case 2:1==n.jump?wx.navigateToMiniProgram({appId:"wx3f44a8453b45fa12",path:"pages/about/about",extraData:o,envVersion:t,success(e){},fail(e){}}):wx.showModal({title:n.title,content:n.content,showCancel:!1,confirmText:n.confirmMsg,success:function(e){e.confirm&&wx.openCustomerServiceConversation({sessionFrom:"xyx_"+o.game_id+"_"+n.order_id,showMessageCard:!0,sendMessageImg:i+"xyx"+o.game_id+".png",fail:function(){wx.showModal({title:"\u6e29\u99a8\u63d0\u793a",content:"\u56e0\u7248\u672c\u9650\u5236\uff0c\u9700\u901a\u8fc7\u3010\u5ba2\u670d\u4f1a\u8bdd\u3011\u5145\u503c\uff0c\u8bf7\u60a8\u8c05\u89e3",cancelText:"\u6715\u77e5\u9053\u4e86",confirmText:"\u524d\u5f80\u5145\u503c",confirmColor:"#576B95",success:function(e){e.confirm&&wx.openCustomerServiceConversation({sessionFrom:"xyx_"+o.game_id+"_"+n.order_id,sendMessagePath:o.game_id+"_"+n.order_id,showMessageCard:!0,sendMessageImg:i+"svip"+o.game_id+".png"})}})}})}});break;case 5:wx.previewImage({current:n.img_url,urls:[n.img_url]});break;case 4:wx.showModal({title:"\u63d0\u793a",content:"\u6682\u4e0d\u652f\u6301\u5145\u503c",showCancel:!1});break;case 1:wx.requestMidasPayment({mode:"game",env:n.env,offerId:n.offerId,currencyType:"CNY",platform:"android",buyQuantity:100*o.money,zoneId:"1",success:function(e){adApiReq("/pay/notify/midasPay",{game_id:o.game_id,order_id:n.order_id,user_id:o.user_id,money:o.money}).then(function(e){})},fail:function(e){},complete:function(e){}});break;case 6:wx.navigateToMiniProgram({appId:n.pay_appid,path:"pages/jumpPay/jumpPay?order_id="+n.order_id,envVersion:t,success:function(){}});break;case 7:wx.previewImage({current:n.img_url,urls:[n.img_url]})}a&&a(e.data.data)}})},openGS:function(e){Object.assign({},e,r);wx.openCustomerServiceConversation({sessionFrom:"kfmsg&"+JSON.stringify(e),sendMessagePath:"",showMessageCard:!0})},getSubscribe:function(){adApiReq("/wx/gsub",Object.assign({},{game_id:r.game_id})).then(function(e){var n;e&&200===e.data.code?(n=e.data.data.template_id,wx.onTouchEnd(function(){1==(r.subState||1)&&wx.requestSubscribeMessage({tmplIds:[n],success:function(){r.subState=2}})})):console.log("")})},forward:function(t){var a=(new Date).getTime();adApiReq("/wx/gforward",Object.assign({},{})).then(function(e){var n=e.data.data.title,e=e.data.data.img;wx.shareAppMessage({title:n[_Mathfloor(Math.random()*n.length)],imageUrl:e[_Mathfloor(Math.random()*e.length)].pic_url,query:"name="+t+"&key="+a}),wx.setStorageSync(t,a)})}}}();