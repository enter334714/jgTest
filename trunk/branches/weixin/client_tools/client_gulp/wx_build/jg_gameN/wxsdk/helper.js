/** * 漫方SDK * by 陌上老农 2022-03 * version:2.0.4 */!function(){"use strict"};export default class FunGame{constructor(){this.host="https://funsdk.bigrnet.com"}sign(params){var _sign="";var keys=Object.keys(params);keys.sort();keys.forEach((key)=>{if(key!="host_url"){_sign+=params[key]}});return _sign}setParameter(url,name,value){url=url.replace(/(#.*)/ig,"");var reg=new RegExp("([\?&])"+name+"=([^&]*)(?=&|$)","i");if(reg.test(url)){return url.replace(reg,"$1"+name+"="+value)}else{return url+(url.indexOf("?")==-1?"?":"&")+name+"="+value}}ajaxRequest(request_url,params,success,fail){request_url=this.setParameter(request_url,"v",Math.random());let _this=this;wx.request({url:request_url,header:{'content-type':'application/x-www-form-urlencoded',},method:'POST',data:params,dataType:"json",success:function(res){success&&success(res.data)},fail:function(res){fail&&fail(res)},})}game(data,success,fail){console.log("<<<----游戏---->>>");if(!data.game_key){console.log("缺少game_key");return}var url=this.host+"/index/game";this.ajaxRequest(url,data,success,fail)};wxChannelCode(){console.log("<<<----渠道---->>>");const{query}=wx.getLaunchOptionsSync();const query_params=decodeURIComponent(query.query);const clue_token=decodeURIComponent(query.clue_token);const gdt_vid=decodeURIComponent(query.gdt_vid);const wx_extension=JSON.stringify(query);var channel=new Object();channel['wx_extension']='';channel['clue_token']='';channel['click_id']='';if(query_params!="undefined"&&query_params!=""){channel["code"]=query_params;channel["type"]=10000}else{const scene_params=decodeURIComponent(query.scene);if(scene_params=="undefined"){return channel}var strs=scene_params.split("&");for(var i=0;i<strs.length;i++){channel[strs[i].split("=")[0]]=strs[i].split("=")[1]}}if(clue_token!="undefined"&&clue_token!=""){channel['clue_token']=clue_token}if(wx_extension!="undefined"&&wx_extension!=''){channel['wx_extension']=wx_extension}if(gdt_vid!="undefined"&&gdt_vid!=""){channel['click_id']=gdt_vid}return channel}role(data,success,fail){console.log("<<<----角色---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.account){console.log("缺少account");return}if(!data.server){console.log("缺少server");return}if(!data.server_name){console.log("缺少server_name");return}if(!data.role){console.log("缺少role");return}if(!data.role_name){console.log("缺少role_name");return}if(!data.level){console.log("缺少level");return}if(data.type==undefined||data.type==""||data.type==null){data.type=0}data["sign"]=this.sign(data);var url=data.host_url+"/index/role";this.ajaxRequest(url,data,success,fail)}order(data,success,fail){console.log("<<<----订单---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.account){console.log("缺少account");return}if(!data.server){console.log("缺少server");return}if(!data.role){console.log("缺少role");return}if(!data.amount){console.log("缺少amount");return}data["sign"]=this.sign(data);var url=data.host_url+"/order/index";this.ajaxRequest(url,data,success,fail)}gameLogin(data,success,fail){console.log("<<<----登录---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}var url=data.host_url+"/login/code";var _this=this;wx.login({success(res){data.code=res.code;data.channel_code="";var channel=_this.wxChannelCode();if(channel&&channel["code"]){data.channel_code=channel["code"]}data.clue_token=channel['clue_token'];data.click_id=channel['click_id'];data.wx_extension=channel['wx_extension'];console.log(data);_this.ajaxRequest(url,data,success,fail)}})}gameToken(data,success,fail){console.log("<<<----Token---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}var url=data.host_url+"/index/game-access-token";this.ajaxRequest(url,data,success,fail)}midasNotice(data,success,fail){console.log("<<<----米大师---->>>");if(data.game_env==undefined||data.game_env==""||data.game_env==null){data.game_env=0}if(!data.offer_id){console.log("缺少offer_id");return}if(!data.currency_type){console.log("缺少currency_type");return}if(!data.amount){console.log("缺少amount");return}if(!data.server){console.log("缺少server");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.host_url){console.log("缺少host_url");return}if(!data.account){console.log("缺少account");return}if(!data.role){console.log("缺少role");return}var _this=this;this.checkPaySwicth(data,function(res){if(res.data.is_check_pay==1){if(res.data.is_kf==1){var orderData={'host_url':data.host_url,'game_key':data.game_key,'account':data.account,'server':data.server,'role':data.role,'amount':data.amount,'extend':data.extend,};_this.order(orderData,function(orderRes){if(orderRes.code==0&&orderRes.data.order){_this.openCustomerService()}})}else{var gucpk_url=data.host_url+"/index/get-user-check-pay-key";var gucpk_data={'host_url':data.host_url,'game_key':data.game_key,'account':data.account,};_this.ajaxRequest(gucpk_url,gucpk_data,function(res){if(res.code==0){wx.showModal({title:'温馨提示',content:res.data.content,showCancel:false,success:function(showres){wx.setClipboardData({data:res.data.text,success(res){wx.showToast({title:'内容已复制',icon:'none',duration:1500})}})}})}else{console.log('暂不支持')}})}}else{var _is_success=false;wx.requestMidasPayment({currencyType:data.currency_type,env:data.game_env,mode:"game",offerId:data.offer_id,buyQuantity:data.amount,platform:"android",zoneId:"1",success(res){_is_success=true;console.log("<<<----midas支付成功---->>>");var url=data.host_url+"/notice/midas";_this.ajaxRequest(url,data,success,fail)},fail(f){console.log(f)},complete(r){if(_is_success==false){console.log("<<<----midas支付完成---->>>");var url=data.host_url+"/notice/midas";_this.ajaxRequest(url,data,success,fail)}}})}},function(){console.log('异常错误')})}midasOrderSubmit(data,success,fail){console.log("<<<----米大师充值订单提交---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.account){console.log("缺少account");return}if(!data.server){console.log("缺少server");return}if(!data.role){console.log("缺少role");return}if(!data.extend){console.log("缺少extend");return}if(!data.amount){console.log("缺少amount");return}data["sign"]=this.sign(data);var url=data.host_url+"/order/midas-order";this.ajaxRequest(url,data,success,fail)}checkWords(data,success,fail){console.log("<<<----敏感词---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.account){console.log("缺少account");return}if(!data.scene){console.log("缺少scene");return}if(!data.content){console.log("缺少content");return}var url=data.host_url+"/index/check-words";this.ajaxRequest(url,data,success,fail)}gameCenter(data,success,fail){console.log("<<<----游戏中心---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}var url=data.host_url+"/service/top-game";this.ajaxRequest(url,data,success,fail)}openGame(data,success,fail){console.log("<<<----跳转小程序---->>>");if(!data.app_id){console.log("缺少app_id");return}var p={"account":data.account,"from_app_id":data.from_app_id,"app_id":data.app_id,"type":0,};var url=data.host_url+"/service/click-game";var _this=this;wx.navigateToMiniProgram({appId:data.app_id,path:data.path,envVersion:data.env_version,success(res){p.type=1;_this.ajaxRequest(url,p,success,fail)},fail(f){_this.ajaxRequest(url,p,success,fail)}})}vipDesc(data,success,fail){console.log("<<<----VIP客服描述---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}var url=data.host_url+"/service/vip-desc";this.ajaxRequest(url,data,success,fail)}wxFollowSteps(data,success,fail){console.log("<<<----关注步骤---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}var url=data.host_url+"/service/follow-steps";this.ajaxRequest(url,data,success,fail)}openCustomerService(){wx.showModal({title:"充值教程",content:'即将跳转官方【客服会话】充值，\r\n 给客服回复“1”获取充值链接',showCancel:false,confirmText:"客服充值",success(res){wx.openCustomerServiceConversation({showMessageCard:true,sendMessageTitle:"可能要发送的小程序",sendMessageImg:"http://funsdk.bigrnet.com/images/thumb_recharge.jpg",})}})}phoneDesc(data,success,fail){console.log("<<<----手机绑定文字描述---->>>");if(!data.host_url){console.log("缺少host_url");return}var url=data.host_url+"/sms/phone-desc";this.ajaxRequest(url,data,success,fail)}phoneCode(data,success,fail){console.log("<<<----手机绑定获取验证码---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.phone){console.log("缺少phone");return}var url=data.host_url+"/sms/phone-code";this.ajaxRequest(url,data,success,fail)}phoneBind(data,success,fail){console.log("<<<----手机绑定绑定手机号---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.account){console.log("缺少account");return}if(!data.phone){console.log("缺少phone");return}if(!data.code){console.log("缺少code");return}var url=data.host_url+"/sms/phone-bind";this.ajaxRequest(url,data,success,fail)}gameLoop(data){console.log("<<<----微信游戏圈---->>>");if(!data.type){console.log("缺少type");return}if(data.type!='text'&&data.type!='image'){console.log("错误的type类型");return};if(data.type=='text'&&!data.text){console.log("缺少text");return}if(data.type=='image'&&!data.icon){console.log("缺少icon");return}if(!data.style){console.log("缺少styel");return}wx.createGameClubButton(data)}subscribeToData(data,succFun,errFun){console.log("<<<----订阅消息---->>>");if(!data.tmpl_ids){console.log("缺少tmpl_ids");return}if(!data.account){console.log("缺少account");return}if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}const retunData={'code':'0','msg':'成功','data':[]};const url=data.host_url+"/subscribe/index";const _this=this;const ajaxData={'account':data.account,'game_key':data.game_key,'pushTmplIds':[]};wx.requestSubscribeMessage({tmplIds:data.tmpl_ids,success:function(res){if(res.errMsg=='requestSubscribeMessage:ok'){for(var i=0;i<data.tmpl_ids.length;i++){if(res[data.tmpl_ids[i]]=='accept'){ajaxData.pushTmplIds.push(data.tmpl_ids[i])}}_this.ajaxRequest(url,ajaxData,succFun,errFun)}},fail:function(err){retunData.code=err.errCode?err.errCode:'-1';retunData.msg='失败';errFun&&errFun(retunData)}})}sharingInMoments(data){console.log("<<<----小游戏分享---->>>");if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}const url=data.host_url+"/subscribe/sharing-in-moments";var go_title='';var go_imageUrl='';var gc_title='';var gc_imageUrl='';wx.showShareMenu({withShareTicket:true,menus:['shareAppMessage','shareTimeline']});this.ajaxRequest(url,data,function(res){if(res.code==0){go_title=res.data.CircleOfFriends.title;go_imageUrl=res.data.CircleOfFriends.imageUrl;gc_title=res.data.GroupChat.title;gc_imageUrl=res.data.GroupChat.imageUrl}wx.onShareAppMessage(()=>{return{title:gc_title,imageUrl:gc_imageUrl,}});wx.onShareTimeline(()=>{return{title:go_title,imageUrl:go_imageUrl,}})},function(err){console.log('失败',err)})}checkPaySwicth(data,succFun,errFun){if(!data.host_url){console.log("缺少host_url");return}if(!data.game_key){console.log("缺少game_key");return}if(!data.account){console.log("缺少account");return}if(!data.server){console.log("缺少server");return}if(!data.role){console.log("缺少role");return}var url=data.host_url+"/index/check-pay";this.ajaxRequest(url,data,succFun,errFun)}}