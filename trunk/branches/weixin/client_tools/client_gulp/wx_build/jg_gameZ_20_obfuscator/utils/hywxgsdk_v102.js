var W=wx.$l;let instance;export default class hywxgsdk{constructor(e){return instance||(instance=this,void 0===e.appid?(console.log("appid\u5fc5\u4f20"),!1):(this.gameargs=e,this._sdkConfig(),void this._sdkinit()))}_sdkConfig(){this.version="102",this.minigameid="",this.miniappid="",this.apiDomain="https://game.moleyx.cn/",this.isIosPay=0,this.apiurl={initinfo:this.apiDomain+"api/wxgsdk/initinfo",login:this.apiDomain+"api/wxgsdk/login",sendrole:this.apiDomain+"api/wxgsdk/sendroleclient",pay:this.apiDomain+"api/pay",userinfo:this.apiDomain+"api/wxgsdk/wxuserinfo",checkpay:this.apiDomain+"api/wxgsdk/checkpay"}}_sdkinit(){var e=wx.getEnterOptionsSync();void 0===(this.wxentercs=e).query.cid?this.cid=0:this.cid=e.query.cid;e=wx.getStorageSync("hywxgsdk_token_29ty73");this.token=void 0===e?"":e;e=wx.getStorageSync("hywxgsdk_userid_35fh82");this.userid=void 0===e?0:e;e=this;wx.request({url:e.apiurl.initinfo,data:{wxentercs:e.wxentercs,cid:e.cid,appid:e.gameargs.appid,minigameid:e.minigameid},header:{"content-type":"application/json"},method:"POST",success(e){e=e.data;0==e.code?console.log("\u521d\u59cb\u5316\u4fe1\u606f\u6210\u529f"):(console.log("\u521d\u59cb\u5316\u4fe1\u606f\u5931\u8d25"),console.log(e))},fail(e){console.log("\u521d\u59cb\u5316\u4fe1\u606f\u63a5\u53e3\u8c03\u7528\u5931\u8d25"),console.log(e)}})}login(e){var a;console.log("\u767b\u5f55\u5f00\u59cb"),void 0!==this.cid&&void 0!==this.wxentercs||(a=wx.getEnterOptionsSync(),void 0===(this.wxentercs=a).query.cid?this.cid=0:this.cid=a.query.cid);var i=this;wx.checkSession({success(){void 0!==i.userid&&void 0!==i.token&&i.userid&&i.token?i._loginLogin(e,1):i._loginLogin(e,0)},fail(){i._loginLogin(e,0)}})}_loginLogin(i,a){var s=this;console.log("\u6267\u884c\u767b\u5f55"),1==a&&s.userid&&s.token?wx.request({url:s.apiurl.login,data:{is_sk:a,cid:s.cid,appid:s.gameargs.appid,userid:s.userid,token:s.token,minigameid:s.minigameid,wxentercs:s.wxentercs},method:"POST",success(e){e=e.data;var a;0==e.code?(console.log("\u6267\u884c\u767b\u5f55\u6210\u529f"),s.miniappid=e.data.miniappid,s.isIosPay=e.data.is_ios_pay,s.minigameid=e.data.http_minigame_appid,s.cid!=e.data.cid&&(s.cid=e.data.cid),wx.setStorageSync("hywxgsdk_token_29ty73",e.data.token),wx.setStorageSync("hywxgsdk_userid_35fh82",e.data.id),s.token=e.data.token,s.userid=e.data.id,wx.getSetting({success(e){e.authSetting["scope.userInfo"]?s._getUserInfo():wx.authorize({scope:"scope.userInfo",success(){s._getUserInfo()}})}}),a={code:0,data:{token:e.data.token},msg:e.msg},i.success(a)):(wx.setStorageSync("hywxgsdk_token_29ty73",""),wx.setStorageSync("hywxgsdk_userid_35fh82",""),s.token="",s.userid=0,a={code:e.code,data:{},msg:e.msg},i.fail(a))},fail(e){i.fail({code:90001,data:{},msg:"\u767b\u5f55\u63a5\u53e3\u8c03\u7528\u5931\u8d25"})}}):wx.login({success(e){e.code?wx.request({url:s.apiurl.login,data:{is_sk:a,code:e.code,cid:s.cid,appid:s.gameargs.appid,minigameid:s.minigameid,wxentercs:s.wxentercs},method:"POST",success(e){e=e.data;var a;0==e.code?(console.log("\u767b\u5f55\u6210\u529f"),s.miniappid=e.data.miniappid,s.isIosPay=e.data.is_ios_pay,s.minigameid=e.data.http_minigame_appid,s.cid!=e.data.cid&&(s.cid=e.data.cid),wx.setStorageSync("hywxgsdk_token_29ty73",e.data.token),wx.setStorageSync("hywxgsdk_userid_35fh82",e.data.id),s.token=e.data.token,s.userid=e.data.id,wx.getSetting({success(e){e.authSetting["scope.userInfo"]?s._getUserInfo():wx.authorize({scope:"scope.userInfo",success(){s._getUserInfo()}})}}),a={code:0,data:{token:e.data.token},msg:"ok"},i.success(a)):(wx.setStorageSync("hywxgsdk_token_29ty73",""),wx.setStorageSync("hywxgsdk_userid_35fh82",""),s.token="",s.userid=0,a={code:e.code,data:{},msg:e.msg},i.fail(a))},fail(e){console.log("\u63a5\u53e3\u8c03\u7528\u5931\u8d25");i.fail({code:90002,data:{},msg:"\u767b\u5f55\u63a5\u53e3\u8c03\u7528\u5931\u8d25"})}}):(console.log("\u83b7\u53d6\u4e0d\u5230code"),i.fail({code:80001,data:{},msg:"\u83b7\u53d6\u4e0d\u5230code"}))}})}_getUserInfo(){if(!this.gameargs.appid||!this.token||!this.userid)return!1;var a=this;wx.getUserInfo({withCredentials:!1,success:function(e){console.log("\u83b7\u53d6wx"),console.log(e),wx.request({url:a.apiurl.userinfo,data:{res:e,token:a.token,user_id:a.userid,appid:a.gameargs.appid},method:"POST",success(e){console.log(e);e=e.data;0==e.code||e.code,e.msg},fail(e){console.log(e)}})},fail:function(e){console.log(e)}})}sendrole(i){if(!this.gameargs.appid||!this.token)return i.fail({code:90001,data:{},msg:"\u8bf7\u5148\u767b\u5f55"}),!1;i.roleInfo.appid=this.gameargs.appid,i.roleInfo.token=this.token,i.roleInfo.ts=0,i.roleInfo.sign="";wx.request({url:this.apiurl.sendrole,data:i.roleInfo,method:"POST",success(e){e=e.data;var a;0==e.code?(a={code:0,data:{},msg:e.msg},i.success(a)):(a={code:e.code,data:{},msg:e.msg},i.fail(a))},fail(e){i.fail({code:80001,data:{},msg:"\u63a5\u53e3\u8c03\u7528\u5931\u8d25"})}})}pay(t){if(!this.gameargs.appid||!this.token)return t.fail(a={code:90001,data:{},msg:"\u8bf7\u5148\u767b\u5f55"}),!1;var o=this;var e=wx.getSystemInfoSync();var a;{if("ios"==e.platform)return 0==o.isIosPay?(a={code:80099,data:{},msg:"\u4e0d\u652f\u6301IOS\u7cfb\u7edf\u652f\u4ed8\uff01"},wx.showModal({title:"\u63d0\u793a",content:"\u4e0d\u652f\u6301IOS\u7cfb\u7edf\u652f\u4ed8"}),t.fail(a),!1):""==o.miniappid?(t.fail(a={code:80002,data:{},msg:"\u7f3a\u4e4f\u5c0f\u7a0b\u5e8fid"}),!1):void wx.navigateToMiniProgram({appId:o.miniappid,path:"pages/pay/pay",extraData:{orderParams:t.orderParams,cid:o.cid,token:o.token,minigameid:o.minigameid},success(e){console.log("\u5c0f\u7a0b\u5e8f\u6253\u5f00\u6210\u529f");var a=0;var i=0;var s=setInterval(function(){if(1===i||100<a++)return clearInterval(s),!0;wx.request({url:o.apiurl.checkpay,data:{token:o.token,reqOrder:t.orderParams},method:"POST",success(e){var a=e.data;if(console.log(a),0==a.code&&1==a.data.is_pay)return i=1,t.success(a),!0;console.log(e)},fail(e){console.log(e)}})},3e3)},fail(e){return t.fail({code:80003,data:{},msg:"\u5c0f\u7a0b\u5e8f\u8df3\u8f6c\u5931\u8d25"}),!1}});wx.request({url:o.apiurl.pay,method:"POST",data:{type:"wechat",method:"minigame",token:o.token,reqOrder:t.orderParams},success(e){console.log(e);var a=e.data;var i=e.data;0==a.code?t.success(a):2==a.code?wx.requestMidasPayment({mode:"game",env:a.data.offer_env,offerId:a.data.offer_id,currencyType:"CNY",platform:"android",buyQuantity:a.data.quantity,success:function(e){console.log(e),wx.request({url:o.apiurl.pay,method:"POST",data:{type:"wechat",method:"minigame",reqOrder:t.orderParams,token:o.token,mi_pay_return:i,is_mi_pay_return:1,midas_res:e},success(e){e=e.data;0==e.code?t.success(e):t.fail(e)},fail(e){t.fail({code:90001,data:{},msg:"\u63a5\u53e3\u8c03\u7528\u5931\u8d25"})}})},fail:function(e){t.fail({code:90002,data:{},msg:"\u652f\u4ed8\u5931\u8d25"})}}):t.fail(a)},fail(e){t.fail({code:80001,data:{},msg:"\u63a5\u53e3\u8c03\u7528\u5931\u8d25"})}})}}}