!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_UTM=e()}(this,(function(){"use strict";function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var e,n=function(){return+new Date},i=function(t){var e=t;try{e=decodeURIComponent(t)}catch(t){}return e},r=function(t){var e={};return t&&t.split("&").forEach((function(t){if(t){var n=t.split("=");n[0]&&(e[n[0]]=n[1]||"")}})),e};!function(t){t[t.Undefined=0]="Undefined",t[t.Start=1]="Start",t[t.End=2]="End"}(e||(e={}));var o=function(){function o(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o),this.key="utm",this.utmed=e.Undefined,this.reload=!1}var s,a,u;return s=o,a=[{key:"apply",value:function(t,n){var i=this;this.sdk=t,this.options=n;var r=this.sdk.types;this.sdk.on(r.LaunchInfo,(function(t){var n,r;if(i.utmed===e.Start)return;i.utmed===e.End&&(i.reload=!0),i.utmed=e.Start,i.parseDefault(null!==(n=null==t?void 0:t.query)&&void 0!==n?n:{}),i.parseMore(null!==(r=null==t?void 0:t.query)&&void 0!==r?r:{})})),this.sdk.on(r.AppHide,(function(){i.utmed=e.End}))}},{key:"parseDefault",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=!1,r=Object.keys(e).reduce((function(r,o){return t.sdk.UtmType.includes(o)&&(n=!0,r[o]=i(e[o])),r}),{});n&&this.sdk.env.set(r)}},{key:"parseMore",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e||{},o=n.tr_token,s=void 0===o?"":o,a=n.surl_token,u=void 0===a?"":a,d=n.scene,c=void 0===d?"":d,f=s||u;if(c){var h=r(i("".concat(c)));h.tr_token&&(f=h.tr_token),this.sdk.set("scene_extra_query",h)}if(!f)return this.dispatch(),void 0;var l=function(){t.reload?t.sdk.emit(t.sdk.types.CancelPause):t.dispatch()};this.reload&&this.sdk.emit(this.sdk.types.Pause),this.storageGet(f).then((function(e){e?(t.sdk.env.set(e.utms||{}),l()):t.fetch(f).then((function(){return l()})).catch((function(){return l()}))})).catch((function(){t.fetch(f).then((function(){return l()})).catch((function(){return l()}))}))}},{key:"storageGet",value:function(t){var e=this.sdk.getKey(this.key),i=this.sdk.adapter;return i.get(e).then((function(r){var o=n(),s=[];if(Object.keys(r).forEach((function(t){r[t]&&r[t].timestamp+864e7<o&&s.push(t)})),s.length>0&&(s.forEach((function(t){delete r[t]})),i.set(e,r)),r&&r[t])return r[t];return null}))}},{key:"storageSet",value:function(t,e){var i=this.sdk.getKey(this.key),r=this.sdk.adapter;r.get(i).then((function(o){o||(o={}),o[t]={utms:e,timestamp:n()},r.set(i,o)}))}},{key:"fetch",value:function(t){var e=this,n=this.sdk,i=n.adapter,r=n.option,o=n.env,s=n.UtmType;return i.request({url:"".concat(r.get("domain"),"/service/2/mp_campaigns"),method:"GET",data:{tr_token:t},timeout:3e3}).then((function(n){var r=(n||{}).data,a=(r=void 0===r?{}:r).code,u=void 0===a?-1:a,d=r.data,c=void 0===d?{}:d,f=r.message,h=void 0===f?"":f;if(0===u){if(e.sdk.isObject(c)){var l=!1,v=Object.keys(c).reduce((function(t,e){return s.includes(e)&&(l=!0,v[e]=c[e]),t}),{});l&&o.set(v),e.storageSet(t,v)}}else 40002===u&&e.storageSet(t,{});0!==u&&i.log(h||"")}))}},{key:"dispatch",value:function(){this.sdk.emit(this.sdk.types.LaunchComplete)}}],a&&t(s.prototype,a),u&&t(s,u),s,o}();return o.pluginName="official:utm",o}));
