!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).$$LOGSDK=t()}(this,(function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function a(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=s(e);if(t){var r=s(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return a(this,n)}}function c(e,t,n){return c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=s(e)););return e}(e,t);if(!i)return;var r=Object.getOwnPropertyDescriptor(i,t);if(r.get)return r.get.call(n);return r.value},c(e,t,n||e)}function h(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var i,r,s=[],o=!0,a=!1;try{for(n=n.call(e);!(o=(i=n.next()).done)&&(s.push(i.value),!t||s.length!==t);o=!0);}catch(e){a=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(a)throw r}}return s}(e,t)||l(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e){return function(e){if(Array.isArray(e))return p(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||l(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){if(!e)return;if("string"==typeof e)return p(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p(e,t)}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function d(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}var v,y=void 0,m="cn",k={cn:"https://mcs.volceapplog.com",va:"https://mcs.itobsnssdk.com",sg:"https://mcs.tobsnssdk.com"},g={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share",pageOnAddToFavorites:"on_addtofavorites",mpClick:"bav2b_click"},_=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],b=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],w=function(){return+new Date},O=function(){function t(n){e(this,t),this.sdk=n,this.env=this.init()}return n(t,[{key:"init",value:function(){return{user:{web_id:y,user_unique_id:y,user_id:y,user_type:y,user_is_auth:y,user_is_login:y,ip_addr_id:y,device_id:y,user_unique_id_type:y},header:{app_id:y,app_name:y,app_install_id:y,install_id:y,app_package:y,app_channel:y,app_version:y,os_name:y,os_version:y,device_model:y,device_brand:y,traffic_type:y,client_ip:y,os_api:y,access:y,language:y,app_language:y,creative_id:y,ad_id:y,campaign_id:y,ab_client:y,ab_version:y,platform:y,sdk_version:y,sdk_lib:y,app_region:y,region:y,province:y,city:y,timezone:y,tz_offset:y,tz_name:y,sim_region:y,carrier:y,resolution:y,screen_width:y,screen_height:y,browser:y,browser_version:y,referrer:y,referrer_host:y,utm_source:y,utm_medium:y,utm_campaign:y,utm_term:y,utm_content:y,custom:{},ab_sdk_version:y,_sdk_version:y,_sdk_name:y,wechat_openid:y,wechat_unionid:y,is_connected:y}}}},{key:"set",value:function(e){var t=this;this.sdk.emit(this.sdk.types.EnvTransform,e),Object.keys(e).forEach((function(n){if("evtParams"===n)t.evtParams=Object.assign(Object.assign({},t.evtParams||{}),e.evtParams||{});else if("_staging_flag"===n)t.evtParams=Object.assign(Object.assign({},t.evtParams||{}),{_staging_flag:e._staging_flag});else{var i=n,r=e[n];if(null===r)return!1;var s="";if(i.indexOf(".")>-1){var o=h(i.split("."),2);s=o[0],i=o[1]}"platform"===i&&(r="mp"),"os_version"!==i&&"mp_platform"!==i||(r="".concat(r)),s?("headers"===s&&(s="header"),"user"===s||"header"===s?t.env[s][i]=r:t.env.header.custom[i]=r):t.env.user.hasOwnProperty(i)?["user_type","ip_addr_id"].indexOf(i)>-1?t.env.user[i]=Number(r):["user_id","web_id","user_unique_id"].indexOf(i)>-1?t.env.user[i]=String(r):["user_is_auth","user_is_login"].indexOf(i)>-1?t.env.user[i]=Boolean(r):t.env.user[i]=r:t.env.header.hasOwnProperty(i)?t.env.header[i]=r:t.env.header.custom[i]=r}}))}},{key:"get",value:function(e){if(!e||"env"===e)return this.clone(this.env);if("evtParams"===e)return Object.assign({},this[e]);if(this.env.hasOwnProperty(e))return this.clone(this.env[e]);if(this.env.user.hasOwnProperty(e))return this.clone(this.env.user[e]);if(this.env.header.hasOwnProperty(e))return this.clone(this.env.header[e]);if(this.env.header.custom.hasOwnProperty(e))return this.clone(this.env.header.custom[e])}},{key:"compose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this.env,i=n.user,r=n.header,s=this.evtParams,o=e.map((function(e){return e.event&&!t.includes(e.event)&&s&&Object.keys(s).forEach((function(t){void 0===e.params[t]&&(e.params[t]=s[t])})),e.params=JSON.stringify(e.params),e}));return this.clone({events:o,user:i,header:r})}},{key:"merge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this.compose(e,t);return n.local_time=Math.floor(w()/1e3),[n]}},{key:"clone",value:function(e){if(this.sdk.isObject(e))return JSON.parse(JSON.stringify(e));return e}}]),t}(),C=function(e){return null!=e&&"[object Object]"==Object.prototype.toString.call(e)},P=function(e){return"number"==typeof e&&!isNaN(e)},S=function(){function t(){e(this,t),this.domains=k,this.init()}return n(t,[{key:"init",value:function(){this.option={caller:"",log:!1,channel:m,report_channel:m,channel_domain:"",report_url:"",auto_report:false,auto_profile:false,profile_channel:"cn",enable_profile:false,enable_ab_test:false,ab_channel_domain:"",clear_ab_cache_on_user_change:true,enable_et_test:false,event_verify_url:"",enable_buffer:false,buffer_interval:5e3,buffer_number:5,enable_storage_only:false,enable_cache:false,enable_filter_list:false,enable_third:false,enable_filter_crawler:false,request_timeout:0,enable_initiative_launch:false,enable_custom_webid:false,disable_sdk_monitor:false,verify:null},this.cloneOption=Object.assign({},this.option),this.initDomain()}},{key:"initDomain",value:function(){if(this.option.channel_domain)return this.domain=this.option.channel_domain,void 0;var e=this.option.report_channel;Object.keys(this.domains).includes(e)||(e=m),this.domain=this.domains[e]}},{key:"set",value:function(e){var t=this;if(!C(e))return;Object.keys(e).forEach((function(n){t.option.hasOwnProperty(n)&&("channel"===n||"report_channel"===n?(t.option.report_channel=t.option.channel=e[n]?e[n]:t.cloneOption[n],t.initDomain()):(t.option[n]=void 0===e[n]?t.cloneOption[n]:e[n],"channel_domain"===n&&t.initDomain()))}))}},{key:"get",value:function(e){if(e){if(this.hasOwnProperty(e))return this[e];if(this.option.hasOwnProperty(e))return this.option[e];return}return Object.assign({},this.option)}}]),t}(),I=function(){function t(){e(this,t),this.hooks={}}return n(t,[{key:"on",value:function(e,t){if(!e||!t||"function"!=typeof t)return;this.hooks[e]||(this.hooks[e]=[]),this.hooks[e].push(t)}},{key:"once",value:function(e,t){var n=this;if(!e||!t||"function"!=typeof t)return;this.on(e,(function i(r){t(r),n.off(e,i)}))}},{key:"off",value:function(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;if(t){var n=this.hooks[e].indexOf(t);-1!==n&&this.hooks[e].splice(n,1)}else this.hooks[e]=[]}},{key:"emit",value:function(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;f(this.hooks[e]).forEach((function(e){try{e(t)}catch(e){}}))}}]),t}(),A=function(){function t(n){e(this,t),this.ready=!1,this.sdk=n}return n(t,[{key:"setLog",value:function(e){e&&this.sdk.isFunction(e.log)&&(this._log=e)}},{key:"setRequest",value:function(e){if(this.sdk.isFunction(e)){var t=e(this.sdk);this.sdk.isFunction(t)&&(this._request=t)}}},{key:"setStorage",value:function(e){this.sdk.isObject(e)&&this.sdk.isFunction(e.get)&&this.sdk.isFunction(e.set)&&this.sdk.isFunction(e.remove)&&(this._storage=e)}},{key:"check",value:function(){if(!this._request||!this._storage)return;this.ready=!0}},{key:"log",value:function(){if(!this._log)return;try{var e;this.sdk.option.get("log")&&(e=this._log).log.apply(e,arguments)}catch(e){}}},{key:"request",value:function(e){var t;if(!this.ready)return Promise.reject(null);try{return null===(t=this._request)||void 0===t?void 0:t.call(this,e)}catch(e){}}},{key:"get",value:function(e){if(!this.ready)return Promise.reject(null);return this._storage.get(e)}},{key:"set",value:function(e,t){if(!this.ready)return Promise.reject(!1);return this._storage.set(e,t)}},{key:"remove",value:function(e){if(!this.ready)return Promise.reject(!1);return this._storage.remove(e)}},{key:"storageInfo",value:function(){if(!this.ready)return Promise.reject(null);return this._storage.info()}}]),t}();!function(e){e.Init="$init",e.Config="$config",e.Send="$send",e.Ready="$ready",e.TokenComplete="$token-complete",e.TokenStorage="$token-storage",e.TokenFetch="$token-fetch",e.TokenGet="$token-get",e.LaunchComplete="$launch-complete",e.ConfigUuid="$config-uuid",e.ConfigWebId="$config-webid",e.ConfigTransform="$config-transform",e.UuidChangeBefore="$uuid-change-before",e.UuidChangeAfter="$uuid-change-after",e.EnvTransform="$env-transform",e.Event="$event",e.Report="$report",e.AppOpen="$app-open",e.AppClose="$app-close",e.AppShowStart="$app-show-start",e.AppShow="$app-show",e.AppHide="$app-hide",e.AppError="$app-error",e.AppShare="$app-share",e.AppOnShare="$app-on-share",e.PageShow="$page-show",e.PageHide="$page-hide",e.PageShare="$page-share",e.SubmitBefore="$submit-before",e.SubmitAfter="$submit-after",e.SubmitError="$submit-error",e.FilterCrawler="$filter-crawler",e.LaunchInfo="$launch-info",e.Pause="$pause",e.CancelPause="$cancel-pause",e.AbVar="$ab-var",e.AbAllVars="$ab-all-vars",e.AbExternalVersion="$ab-external-version",e.AbVersionChangeOn="$ab-version-change-on",e.AbVersionChangeOff="$ab-version-change-off",e.AbRefresh="$ab-refresh",e.AbFetchAfter="$ab-fetch-After",e.ProfileSet="$profile-set",e.ProfileSetOnce="$profile-set-once",e.ProfileUnset="$profile-unset",e.ProfileIncrement="$profile-increment",e.ProfileAppend="$profile-append",e.ProfileClear="$profile-clear",e.ProfileSubmitAfter="$profile-submit-after",e.ProfileSubmitError="$profile-submit-error",e.TransformInfo="$transform-info",e.ExtendAppLaunch="$extend-app-launch",e.ExtendAppTerminate="$extend-app-terminate",e.ExtendAppError="$extend-app-error",e.ExtendPageShow="$extend-page-show",e.ExtendPageHide="$extend-page-hide",e.ExtendPageShare="$extend-page-share",e.ExtendPageFavorite="$extend-page-favorite",e.MpClick="$mp-click",e.Network="$network",e.CacheUnReady="$cache-unready",e.CacheBuffer="$cache-buffer",e.Verify="$verify",e.Check="$check"}(v||(v={}));var q=v,j=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},$=function(){function t(){e(this,t),this.types=q,this.EventType=g,this.ProfileType=b,this.UtmType=_,this.SdkHook=q,this.Domains=k,this.inited=!1,this.sended=!1,this.pluginInstances=[],this.data={},this.unInitedCache=[],this.ready=!1,this.sessionId="",this.appShowStarted=!1,this.env=new O(this),this.option=new S,this.hook=new I,this.sessionId=j(),t.instances.push(this);try{this.adapter=new A(this),this.adapter.setLog(t._log),this.adapter.setRequest(t._request),this.adapter.setStorage(t._storage),this.adapter.check(),t.plugins.reduce((function(e,t){var n=t.plugin;return e.push(new n),e}),this.pluginInstances)}catch(e){}}return n(t,[{key:"on",value:function(e,t){var n;null===(n=this.hook)||void 0===n?void 0:n.on(e,t)}},{key:"once",value:function(e,t){var n;null===(n=this.hook)||void 0===n?void 0:n.once(e,t)}},{key:"off",value:function(e,t){var n;if(!t&&this.types[e])return;null===(n=this.hook)||void 0===n?void 0:n.off(e,t)}},{key:"emit",value:function(e,t){var n;this.adapter.log("emit ".concat(e),t||""),null===(n=this.hook)||void 0===n||n.emit(e,t)}},{key:"appId",get:function(){return this._appId}},{key:"checkUsePlugin",value:function(e){return!!t.plugins.find((function(t){return t.name===e}))}},{key:"init",value:function(e){var t=this;if(this.inited||!this.isObject(e))return;var n=e.app_id,i=e.log,r=d(e,["app_id","log"]);if(void 0!==i&&this.option.set({log:i}),!(P(n)&&n>0))return this.adapter.log("app_id invalid"),void 0;this._appId=n,this.option.set(r),this.env.set({app_id:n}),Promise.all([new Promise((function(e){t.once(t.types.TokenComplete,(function(){e(!0)}))})),new Promise((function(e){t.checkUsePlugin("official:auto")?t.on(t.types.LaunchComplete,(function(){e(!0)})):e(!0)})),new Promise((function(e){t.sended?e(!0):t.once(t.types.Send,(function(){e(!0)}))}))]).then((function(){t.ready=!0,t.emit(t.types.Ready)})),this.on(this.types.AppShowStart,(function(){t.appShowStarted?t.sessionId=j():t.appShowStarted=!0})),this.on(this.types.UuidChangeAfter,(function(){t.sessionId=j()}));var s=this.option.get();if(this.pluginInstances.forEach((function(e){e.apply(t,s)})),this.get("is-crawler"))return;this.inited=!0,this.emit(this.types.Init),this.unInitedCache.length>0&&this.unInitedCache.forEach((function(e){t.emit(t.types.Event,e)}))}},{key:"config",value:function(e){if(!this.inited||!this.isObject(e))return;this.emit(this.types.Config,e),this.emit(this.types.ConfigTransform,e);var t=e.web_id,n=e.user_unique_id,i=d(e,["web_id","user_unique_id"]);void 0!==t&&this.emit(this.types.ConfigWebId,t),void 0!==n&&this.emit(this.types.ConfigUuid,n),this.emit(this.types.Check,{type:"config",value:i}),this.env.set(i)}},{key:"send",value:function(){if(!this.inited||this.sended)return;this.sended=!0,this.emit(this.types.Send)}},{key:"event",value:function(e,t){var n=this;if(this.get("is-crawler"))return;if(Array.isArray(e)){var i=w(),r=[];e.forEach((function(e){var t,s,o;if(Array.isArray(e)){var a=h(e,3);t=a[0],s=a[1],o=a[2]}else n.isObject(e)&&(t=e.event,s=e.params,o=e.local_time_ms);if(!t)return;(!P(o)||o<0||o>i)&&(o=i),r.push(n.createEvent({event:t,params:s,time:o}))})),r.length>0&&(this.inited?this.emit(this.types.Event,r):this.unInitedCache.push(r))}else{var s=this.createEvent({event:e,params:t});this.inited?this.emit(this.types.Event,s):this.unInitedCache.push(s),this.emit(this.types.Verify,{event:e,params:t})}}},{key:"createEvent",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=Object.assign({event:e.event,params:e.params||{},local_time_ms:e.time||w()},this.sessionId?{session_id:this.sessionId}:{});if(this.emit(this.types.Check,{type:"event",value:n}),!t)return n;var i="",r=this.get("ab_sdk_version");r&&(i+=r);var s=this.get("ab_sdk_version_external");return s&&(i?i+=","+s:i=s),Object.assign(Object.assign({},n),i?{ab_sdk_version:i}:{})}},{key:"set",value:function(e,t){this.data[e]=t}},{key:"get",value:function(e){return this.data[e]}},{key:"getKey",value:function(e){var t=this.appId;if("ab_version"===e||"ab_version_external"===e)return"__tea_sdk_".concat(e,"_").concat(t);var n={token:"tokens",report:"reports",event:"events",utm:"utm",first:"first",compensate:"compensate",buffer:"buffer"};return n[e]?"__tea_cache_".concat(n[e],"_").concat(t):void 0}},{key:"getUrl",value:function(e){var t=this.option,n=this.env,i=n.get("_sdk_version"),r=(n.get("_sdk_name")||"").replace(/@.+\//,""),s="".concat(t.get("domain")).concat(e,"?sdk_version=").concat(i,"&sdk_name=").concat(r),o=t.get("caller");if(o)return"".concat(s,"&app_id=").concat(this.appId,"&caller=").concat(o);return s}},{key:"getToken",value:function(e){var t=this;if(e)return this.emit(this.types.TokenGet,{callback:e}),void 0;return new Promise((function(e){t.emit(t.types.TokenGet,{callback:function(t){e(t)}})}))}},{key:"getConfig",value:function(e){return this.env.get(e||"header")}},{key:"stash",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="stash";this.set(n,[].concat(f(this.get(n)||[]),[this.createEvent({event:e,params:t})]))}},{key:"commit",value:function(){var e="stash",t=this.get(e)||[];t.length>0&&(this.event(t),this.set(e,[]))}},{key:"isObject",value:function(e){return C(e)}},{key:"isArray",value:function(e){return function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)}(e)}},{key:"isNumber",value:function(e){return P(e)}},{key:"isString",value:function(e){return function(e){return"string"==typeof e}(e)}},{key:"isFunction",value:function(e){return function(e){return"function"==typeof e}(e)}},{key:"isUndefined",value:function(e){return void 0===e}}],[{key:"useAdapterLog",value:function(e){t._log=e}},{key:"useAdapterRequest",value:function(e){t._request=e}},{key:"useAdapterStorage",value:function(e){t._storage=e}},{key:"usePlugin",value:function(e,n){var i=n||e.pluginName;if(i){for(var r=!1,s=0,o=t.plugins.length;s<o;s++){if(t.plugins[s].name===i){t.plugins[s].plugin=e,r=!0;break}}r||t.plugins.push({name:i,plugin:e})}else t.plugins.push({plugin:e});if("function"==typeof e.init)try{e.init(t)}catch(e){}}}]),t}();$.plugins=[],$.instances=[];var x,E="2.1.1",U=function(){function t(){e(this,t)}return n(t,[{key:"apply",value:function(e,t){e.env.set({sdk_version:E,_sdk_version:E,_sdk_name:"@datarangers/sdk-qg"})}}]),t}();U.pluginName="official:info",function(e){e.Default="default",e.Custom="custom"}(x||(x={}));var T=function(){function t(n,i){e(this,t),this.wrap=n,this.sdk=i,this.url="/webid/"}return n(t,[{key:"storageNoData",value:function(){this.fetch()}},{key:"storageHasData",value:function(e){return this.wrap.dataComplete(e)}},{key:"fetch",value:function(){var e=this,t=this.sdk,n=t.adapter,i=t.appId;n.request({url:this.sdk.getUrl("".concat(this.url)),method:"POST",data:{app_id:i,url:"-",user_agent:"-",referer:"-",user_unique_id:""}}).then((function(t){try{var i=t.data,r=(i=void 0===i?{}:i).e,s=void 0===r?-1e4:r,o=i.web_id,a=void 0===o?"":o;if(0===s)return e.fetchComplete(a),void 0;n.log("parse web_id error",s)}catch(e){n.log("parse web_id error",e)}e.fetchComplete()})).catch((function(t){e.fetchComplete(),n.log("fetch web_id error",t)}))}},{key:"fetchComplete",value:function(e){if(!e)return;this.wrap.webIdComplete(e)}},{key:"storageComplete",value:function(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===x.Default){var t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}]),t}(),N=function(){function t(n,i){var r=this;e(this,t),this.wrap=n,this.sdk=i,this.sdk.on(this.sdk.types.ConfigWebId,(function(e){e="".concat(e),r.wrap.tokenComplete?r.waitComplete(e):r.waitResolve?r.waitResolve(e):r.tmpWebId=e}))}return n(t,[{key:"storageNoData",value:function(){this.wait()}},{key:"storageHasData",value:function(e){return this.wrap.dataComplete(e,this.tmpWebId)}},{key:"wait",value:function(){var e=this;new Promise((function(t){void 0!==e.tmpWebId?(t(e.tmpWebId),e.tmpWebId=void 0):e.waitResolve=t})).then((function(t){e.waitComplete(t)}))}},{key:"waitComplete",value:function(e){this.wrap.webIdComplete(e)}},{key:"storageComplete",value:function(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===x.Custom){var t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}]),t}(),R=function(){function t(){e(this,t),this.tokenComplete=!1,this.tobid="",this.tobidUrl="/tobid/",this.tobidKey="",this.isCustom=!1,this.typeKey="_type_"}return n(t,[{key:"apply",value:function(e,t){var n=this;this.sdk=e,this.options=t,this.key=this.sdk.getKey("token"),this.tobidKey="diss".split("").reverse().join(""),this.options.enable_custom_webid?(this.isCustom=!0,this.token=new N(this,this.sdk)):(this.isCustom=!1,this.token=new T(this,this.sdk));var i=this.sdk.types;this.sdk.on(i.ConfigUuid,(function(e){n.setUserUniqueId(e)})),this.sdk.on(i.TokenGet,(function(e){var t=e.callback,r=function(){n.fetchTobid().then((function(){var e=n.sdk.env.get("user"),i=Object.assign(Object.assign({},e),{web_id:n.webId,user_unique_id:n.userUniqueId});i[n.tobidKey]=n.tobid,"function"==typeof t&&t(i)}))};n.sdk.ready?r():n.sdk.once(i.Ready,(function(){r()}))})),this.storage()}},{key:"storage",value:function(){var e=this,t=this.sdk.adapter;t.get(this.key).then((function(n){if(!e.sdk.isObject(n)||!n.web_id)return e.storageComplete(null),void 0;n[e.typeKey]&&!n[e.tobidKey]&&n.user_unique_id||(n=i({web_id:n.web_id,user_unique_id:n.user_unique_id||n.web_id},e.typeKey,e.isCustom?x.Custom:x.Default),t.set(e.key,n)),e.storageComplete(n)})).catch((function(n){e.storageComplete(null),t.log("get token error",n)}))}},{key:"storageComplete",value:function(e){this.token.storageComplete(e)}},{key:"dataComplete",value:function(e,t){var n=e.web_id;void 0!==t&&t!==n&&(n=t),this.webId=n;var i=e.web_id===e.user_unique_id?n:e.user_unique_id;return void 0!==this.tmpUserUniqueId&&this.tmpUserUniqueId!==i&&(i=this.tmpUserUniqueId?this.tmpUserUniqueId:n,this.tmpUserUniqueId=void 0),this.userUniqueId=i,n!==e.web_id||i!==e.user_unique_id}},{key:"webIdComplete",value:function(e){this.webId=e,this.tmpUserUniqueId?(this.userUniqueId=this.tmpUserUniqueId,this.tmpUserUniqueId=void 0):this.userUniqueId=e,this.complete(!0)}},{key:"complete",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.sdk.types,n={web_id:this.webId,user_unique_id:this.userUniqueId};this.sdk.env.set(n),n[this.typeKey]=this.isCustom?x.Custom:x.Default,e&&this.sdk.adapter.set(this.key,n),this.tokenComplete=!0,this.sdk.emit(t.TokenComplete)}},{key:"setUserUniqueId",value:function(e){var t=this.sdk,n=t.adapter,r=t.env,s=t.types;if(this.tokenComplete){if(this.userUniqueId===e)return;this.sdk.emit(s.UuidChangeBefore),this.userUniqueId=e||this.webId,r.set({user_unique_id:this.userUniqueId});var o=i({web_id:this.webId,user_unique_id:this.userUniqueId},this.typeKey,this.isCustom?x.Custom:x.Default);n.set(this.key,o),this.sdk.emit(s.UuidChangeAfter)}else this.tmpUserUniqueId=e}},{key:"fetchTobid",value:function(){var e=this,t=this.sdk,n=t.adapter,i=t.appId;return n.request({url:this.sdk.getUrl("".concat(this.tobidUrl)),method:"POST",data:{app_id:i,web_id:this.webId,user_unique_id:this.userUniqueId}}).then((function(t){try{var n=t.data,i=(n=void 0===n?{}:n).e,r=void 0===i?-1e4:i,s=n.tobid,o=void 0===s?"":s;if(0===r)return e.tobid=o,void 0}catch(e){}})).catch((function(e){n.log("fetch tobid error",e)}))}}]),t}();R.pluginName="official:token";var D=function(){function t(){e(this,t),this.url="/list/",this.cache=[],this.pause=!1,this.eventName="request_status__"}return n(t,[{key:"apply",value:function(e,t){var n=this;this.sdk=e,this.options=t,this.key=this.sdk.getKey("report"),this.reportUrl=this.sdk.getUrl("".concat(this.url)),this.sdk.set("report_url",this.reportUrl);var i=this.sdk.types;this.sdk.on(i.Report,(function(e){if(Array.isArray(e)||(e=[e]),!n.sdk.ready||n.pause)return e.forEach((function(e){return n.cache.push(e)})),void 0;n.report(e)})),this.sdk.on(i.Ready,(function(){n.reportCache()})),this.sdk.on(i.Pause,(function(){n.pause=!0})),this.sdk.on(i.CancelPause,(function(){n.pause=!1,n.reportCache()}));var r=this.sdk.adapter;this.sdk.on(i.AppOpen,(function(){r.get(n.key).then((function(){}))})),this.sdk.on(i.AppClose,(function(){n.cache.length>0&&(r.set(n.key,f(n.cache)),n.cache.length=0)}))}},{key:"reportCache",value:function(){this.cache.length>0&&(this.report(f(this.cache)),this.cache.length=0)}},{key:"report",value:function(e){this.submit(e)}},{key:"submit",value:function(e){var t=this,n=this.sdk.types;this.sdk.emit(n.SubmitBefore,e),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:e}).then((function(i){t.sdk.emit(n.SubmitAfter,{isError:!1,response:i,event:e});try{if(t.checkMonitor(e))return;var r=i.data,s=i.statusCode;if(0!==r.e){var o=e.map((function(e){return null==e?void 0:e.events}));t.reportMonitor({status_code:s,response_data:JSON.stringify(r),event_info:JSON.stringify(o)})}}catch(e){}})).catch((function(i){t.sdk.emit(n.SubmitAfter,{isError:!0,error:i,event:e});try{if(t.checkMonitor(e))return;t.sdk.emit(n.SubmitError,{event:e})}catch(e){}}))}},{key:"reportMonitor",value:function(e){var t=this.sdk.createEvent({event:this.eventName,params:e}),n=this.sdk.env.merge([t]);this.submit(n)}},{key:"checkMonitor",value:function(e){if(e&&e[0]&&e[0].events[0]&&e[0].events[0].event===this.eventName)return!0;return!1}}]),t}();D.pluginName="official:report";var M=function(){function t(){e(this,t),this.buffer=[],this.timer=0,this.unReadyCache=[],this.cacheBatchNumber=15}return n(t,[{key:"apply",value:function(e,t){var n,i,r=this;this.sdk=e,this.options=t,this.enable=!!this.options.enable_buffer,this.cacheEnable=!!this.options.enable_cache;var s=!0===this.options.enable_storage||!1===this.options.disable_storage;if(s&&(this.enable=!0),this.enable){this.interval=this.options.buffer_interval,this.number=this.options.buffer_number,s&&((null===(n=this.options)||void 0===n?void 0:n.report_interval)>0&&(this.interval=this.options.report_interval),(null===(i=this.options)||void 0===i?void 0:i.max_batch_event)>0&&(this.number=this.options.max_batch_event));try{this.interval=Number(this.interval),this.number=Number(this.number)}catch(e){}}var o=this.sdk.types;this.sdk.on(o.Event,(function(e){var t=Array.isArray(e)?e:[e];if(!r.sdk.ready)return r.unReadyCache=[].concat(f(r.unReadyCache),f(t)),r.cacheEnable&&r.unReadyCache.length>=r.cacheBatchNumber&&(r.sdk.emit(o.CacheUnReady,f(r.unReadyCache)),r.unReadyCache.length=0),void 0;r.process(t)})),this.sdk.on(o.Ready,(function(){r.unReadyCache.length>0&&(r.process(r.unReadyCache),r.unReadyCache.length=0)})),this.sdk.on(o.Network,(function(e){!e.origin&&e.current&&(r.enable?r.refresh():r.buffer.length>0&&(r.report(f(r.buffer)),r.buffer.length=0))})),this.sdk.on(o.AppClose,(function(){if(r.timer&&clearTimeout(r.timer),!r.sdk.ready)return r.cacheEnable&&r.unReadyCache.length>0&&(r.sdk.emit(o.CacheUnReady,f(r.unReadyCache)),r.unReadyCache.length=0),void 0;r.buffer.length>0&&(r.network()?r.report(f(r.buffer)):r.cacheEnable&&r.sdk.emit(o.CacheBuffer,f(r.buffer)),r.buffer.length=0)}))}},{key:"process",value:function(e){var t=this.sdk.env.compose(e);this.network()?this.enable?(this.buffer=[].concat(f(this.buffer),[t]),this.refresh()):this.report(t):(this.buffer=[].concat(f(this.buffer),[t]),this.cacheEnable&&this.buffer.length>=this.cacheBatchNumber&&(this.sdk.emit(this.sdk.types.CacheBuffer,f(this.buffer)),this.buffer.length=0))}},{key:"refresh",value:function(){var e=this;this.buffer.length>=this.number?(this.timer&&(clearTimeout(this.timer),this.timer=0),this.report(f(this.buffer)),this.buffer.length=0):this.timer||(this.timer=setTimeout((function(){e.timer=0,e.buffer.length>0&&(e.report(f(e.buffer)),e.buffer.length=0)}),this.interval))}},{key:"report",value:function(e){this.sdk.emit(this.sdk.types.Report,e)}},{key:"network",value:function(){return!!this.sdk.env.get("is_connected")}}]),t}();M.pluginName="official:buffer";var K=function(){function t(){e(this,t)}return n(t,[{key:"apply",value:function(e,t){var n=this;this.sdk=e,this.options=t;var i=this.sdk,r=i.types,s=i.env,o=function(){try{var e=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(e)/60),offset:60*e}}catch(e){return{timezone:8,offset:-28800}}}();s.set({timezone:o.timezone,tz_offset:o.offset}),this.sdk.on(r.ConfigTransform,(function(e){if(void 0!==e.user_unique_id_type&&(e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),{$user_unique_id_type:e.user_unique_id_type})),void 0!==e.gender&&([1,2,"1","2"].includes(e.gender)?e.gender=e.gender<2?"male":"female":delete e.gender),!!n.options.enable_profile){var t={};["nick_name","gender","avatar_url"].forEach((function(n){void 0!==e[n]&&(t[n]=e[n],delete e[n])})),n.sdk.emit(r.ProfileSet,t)}})),this.sdk.on(r.EnvTransform,(function(e){if(!!n.options.enable_profile){var t={};["$mp_from_uuid"].forEach((function(n){void 0!==e[n]&&(t[n]=e[n],delete e[n])})),Object.keys(t).length>0&&n.sdk.emit(r.ProfileSetOnce,t)}}))}}]),t}();K.pluginName="official:transform";var B=function(){function t(){e(this,t),this.url="/profile/list",this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[]}return n(t,[{key:"apply",value:function(e,t){var n=this;this.sdk=e,this.options=t;var i=this.sdk.types;this.sdk.on(i.ProfileSet,(function(e){n.check()&&n.setProfile(e)})),this.sdk.on(i.ProfileSetOnce,(function(e){n.check()&&n.setOnceProfile(e)})),this.sdk.on(i.ProfileUnset,(function(e){n.check()&&n.unsetProfile(e)})),this.sdk.on(i.ProfileIncrement,(function(e){n.check()&&n.incrementProfile(e)})),this.sdk.on(i.ProfileAppend,(function(e){n.check()&&n.appendProfile(e)})),this.sdk.on(i.ProfileClear,(function(){n.cache={}})),this.sdk.on(i.Ready,(function(){if(!n.buffer.length)return;n.reportMore(f(n.buffer)),n.buffer=[]}))}},{key:"check",value:function(){return!!this.options.enable_profile}},{key:"setProfile",value:function(e){var t=this,n=this.debounce(e);if(!n)return;this.putCache(n);var i=this.filter(n,(function(e){return t.sdk.isString(e)||t.sdk.isNumber(e)||t.sdk.isArray(e)}));this.report(this.sdk.createEvent({event:"__profile_set",params:i}))}},{key:"setOnceProfile",value:function(e){var t=this,n=this.debounce(e,!0);if(!n)return;this.putCache(n);var i=this.filter(n,(function(e){return t.sdk.isString(e)||t.sdk.isNumber(e)||t.sdk.isArray(e)}));this.report(this.sdk.createEvent({event:"__profile_set_once",params:i}))}},{key:"incrementProfile",value:function(e){var t=this;if(!e)return;var n=this.filter(e,(function(e){return t.sdk.isNumber(e)}));this.report(this.sdk.createEvent({event:"__profile_increment",params:n}))}},{key:"unsetProfile",value:function(e){if(!e||!this.sdk.isString(e))return;var t={};t[e]="1",this.report(this.sdk.createEvent({event:"__profile_unset",params:t}))}},{key:"appendProfile",value:function(e){var t=this;if(!e||!this.sdk.isObject(e)||this.isEmpty(e))return;var n=this.filter(e,(function(e){return t.sdk.isString(e)||t.sdk.isArray(e)}));this.report(this.sdk.createEvent({event:"__profile_append",params:n}))}},{key:"reportMore",value:function(e){var t=this;if(this.sdk.ready){var n=this.sdk.env.merge(e,this.sdk.ProfileType),i=this.sdk,r=i.adapter,s=i.option;r.request({url:"".concat(s.get("domain")).concat(this.url),method:"POST",data:n}).then((function(e){t.sdk.emit(t.sdk.types.ProfileSubmitAfter,{isError:!0,response:e,event:n})})).catch((function(e){t.sdk.emit(t.sdk.types.ProfileSubmitError,{isError:!0,error:e,event:n})}))}else e.forEach((function(e){t.buffer.push(e)}))}},{key:"report",value:function(e){this.reportMore([e])}},{key:"ms",value:function(){return w()}},{key:"debounce",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e||!this.sdk.isObject(e)||this.isEmpty(e))return;var i=Object.keys(e),r=this.ms(),s=i.filter((function(i){var s=t.cache[i];if(s&&(n||t.compare(s.val,e[i])&&r-s.timestamp<t.duration))return!1;return!0})).reduce((function(t,n){return t[n]=e[n],t}),{});if(!(i=Object.keys(s)).length)return;return s}},{key:"putCache",value:function(e){var t=this,n=this.ms();Object.keys(e).forEach((function(i){t.cache[i]={val:t.clone(e[i]),timestamp:n}}))}},{key:"clone",value:function(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}},{key:"compare",value:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{key:"filter",value:function(e,t){return Object.keys(e).reduce((function(n,i){var r=e[i];return t(r)&&(n[i]=r),n}),{})}},{key:"isEmpty",value:function(e){return!Object.keys(e).length}}],[{key:"init",value:function(e){e.prototype.profileSet=function(e){this.emit(this.types.ProfileSet,e)},e.prototype.profileSetOnce=function(e){this.emit(this.types.ProfileSetOnce,e)},e.prototype.profileUnset=function(e){this.emit(this.types.ProfileUnset,e)},e.prototype.profileIncrement=function(e){this.emit(this.types.ProfileIncrement,e)},e.prototype.profileAppend=function(e){this.emit(this.types.ProfileAppend,e)}}}]),t}();B.pluginName="official:profile",$.usePlugin(U),$.usePlugin(R),$.usePlugin(D),$.usePlugin(M),$.usePlugin(K),$.usePlugin(B);var F=console,H=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(n){return function(i){var r=i.timeout||n.option.get("request_timeout"),s="number"==typeof r&&r>0;return new Promise((function(n,o){var a=e.request(Object.assign(Object.assign(Object.assign({},i),s&&!t?{timeout:r}:{}),{dataType:i.dataType||"json",success:function(e){n(e)},fail:function(e){o(e)}}));s&&t&&setTimeout((function(){try{a&&a.abort()}catch(e){}}),r)}))}}}(qq),V=new(function(){function t(n){e(this,t),this.target=n}return n(t,[{key:"get",value:function(e){var t=this;return new Promise((function(n,i){try{n(t.target.getStorageSync(e))}catch(e){i(e)}}))}},{key:"set",value:function(e,t){var n=this;return new Promise((function(i,r){try{n.target.setStorageSync(e,t),i(!0)}catch(e){r(!1)}}))}},{key:"remove",value:function(e){var t=this;return new Promise((function(n,i){try{t.target.removeStorageSync(e),n(!0)}catch(e){i(!1)}}))}},{key:"info",value:function(){var e=this;return new Promise((function(t,n){try{e.target.getStorageInfo({success:function(e){t(e)},fail:function(){n(null)}})}catch(e){n(null)}}))}}]),t}())(qq),z=function(){function t(){e(this,t),this.timer=0}return n(t,[{key:"apply",value:function(e,t){var n=this;this.sdk=e,this.options=t,this.boost();var i=this.sdk.types;this.getInfo(),this.sdk.on(i.AppOpen,(function(){n.getInfo(),n.onChange()}))}},{key:"boost",value:function(){}},{key:"getInfo",value:function(){var e=this.sdk.target;e&&(this.system(e),this.network(e))}},{key:"system",value:function(e){var t=this,n=this.sdk.env;e.getSystemInfo&&e.getSystemInfo({success:function(e){var i=Math.ceil(e.screenWidth),r=Math.ceil(e.screenHeight),s={device_brand:e.brand,device_model:e.model,os_version:e.system,os_name:e.platform,platform:e.platform,resolution:"".concat(i,"x").concat(r),screen_width:i,screen_height:r};t.overlap(e,s),n.set(s)}})}},{key:"network",value:function(e){var t=this,n=this.sdk,i=n.env,r=n.types;e.getNetworkType&&e.getNetworkType({success:function(e){var n={access:e.networkType,is_connected:void 0!==e.networkAvailable?!!e.networkAvailable:"none"!==e.networkType};t.sdk.emit(r.Network,{origin:i.get("is_connected"),current:n.is_connected}),i.set(n)},fail:function(){if(t.timer>0)return;t.timer=setTimeout((function(){t.network(e)}),50)}})}},{key:"onChange",value:function(){var e=this,t=this.sdk,n=t.target,i=t.env,r=t.types;null==n?void 0:n.onNetworkStatusChange((function(t){e.sdk.emit(r.Network,{origin:i.get("is_connected"),current:null==t?void 0:t.isConnected}),i.set({access:null==t?void 0:t.networkType,is_connected:null==t?void 0:t.isConnected})}))}},{key:"overlap",value:function(e,t){t.language=e.language,t.mp_platform_app_version=e.version,t.mp_platform_basic_version=e.SDKVersion}}]),t}();z.pluginName="official:device";var J=function(t){r(o,t);var i=u(o);function o(){return e(this,o),i.apply(this,arguments)}return n(o,[{key:"boost",value:function(){c(s(o.prototype),"boost",this).call(this),this.sdk.env.set(Object.assign({sdk_lib:"qg_common",custom_platform:"quickGame",mp_platform:4},"undefined"!=typeof qg||"undefined"!=typeof cc?{is_connected:!0}:{}))}},{key:"overlap",value:function(e,t){c(s(o.prototype),"overlap",this).call(this,e,t),t.os_version=e.system||e.osVersionName,t.os_name=e.platform||e.platformVersionName}}]),o}(z),L=function(t){r(o,t);var i=u(o);function o(){return e(this,o),i.apply(this,arguments)}return n(o,[{key:"boost",value:function(){c(s(o.prototype),"boost",this).call(this),this.sdk.target=qq,this.sdk.whichIs="qq"}}],[{key:"init",value:function(e){e.platform=qq}}]),o}(J);return $.useAdapterLog(F),$.useAdapterRequest(H),$.useAdapterStorage(V),$.usePlugin(L),$}));
