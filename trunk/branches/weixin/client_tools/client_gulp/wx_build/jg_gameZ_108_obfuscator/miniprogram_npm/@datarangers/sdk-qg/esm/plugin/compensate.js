const e=()=>+new Date;class t{constructor(){this.key="compensate",this.keyCache=[],this.batchMax=5,this.cacheBatchNumber=15,this.enable=!1,this.unReadyKeys={},this.bufferKeys={},this.errorKeys={},this.bufferPreKey="",this.errorPreKey="",this.hasKey=!1}apply(e,t){if(this.sdk=e,this.options=t,this.enable=!!this.options.enable_cache,!this.enable)return;this.reportUrl=this.sdk.get("report_url"),this.bufferPreKey=this.sdk.getKey("buffer"),this.errorPreKey=this.sdk.getKey("compensate");const{types:s}=this.sdk;this.sdk.on(s.AppShow,(()=>{this.hasKey?this.sdk.ready&&this.network()&&this.nowReport():this.getKeys().then((()=>{this.hasKey=!0,this.sdk.ready&&this.network()&&this.nowReport()}))})),this.sdk.on(s.Ready,(()=>{this.hasKey?this.network()&&this.nowReport():this.getKeys().then((()=>{this.hasKey=!0,this.network()&&this.nowReport()}))})),this.sdk.on(s.Network,(e=>{e.current&&this.sdk.ready&&this.nowReport()})),this.sdk.on(s.AppClose,(()=>{try{["unReadyKeys","bufferKeys","errorKeys"].forEach((e=>{Object.keys(this[e]).forEach((t=>{2===this[e][t]&&delete this[e][t]}))}))}catch(e){}})),this.sdk.on(s.SubmitError,(e=>{const{event:t}=e;this.storageError(t).then((e=>{this.errorKeys[e]=0}))})),this.sdk.on(s.CacheUnReady,(e=>{const t=e.length;if(t>0){const s=`${this.bufferPreKey}_unready_`;if(t>this.cacheBatchNumber){const t=[...e];for(;t.length>0;){const e=t.splice(0,this.cacheBatchNumber);if(e.length>0){const t=s+this.random();this.sSet(t,e).then((()=>this.unReadyKeys[s]=0))}}}else{const t=s+this.random();this.sSet(t,e).then((()=>this.unReadyKeys[s]=0))}}})),this.sdk.on(s.CacheBuffer,(e=>{const t=`${this.bufferPreKey}_buffer_`+this.random();this.sSet(t,e).then((()=>{this.bufferKeys[t]=0}))}))}getKeys(){const{adapter:e}=this.sdk;return e.storageInfo().then((e=>{if(null==e?void 0:e.keys){const{keys:t}=e;Array.isArray(t)&&t.forEach((e=>{0===e.indexOf(`${this.bufferPreKey}_unready`)?void 0===this.unReadyKeys[e]&&(this.unReadyKeys[e]=0):0===e.indexOf(`${this.bufferPreKey}_buffer`)?void 0===this.bufferKeys[e]&&(this.bufferKeys[e]=0):0===e.indexOf(`${this.errorPreKey}`)&&void 0===this.errorKeys[e]&&(this.errorKeys[e]=0)}))}}))}nowReport(){this.unReadyReport(),this.bufferReport(),this.errorReport()}unReadyReport(){this.batchReport(this.unReadyKeys,!0)}bufferReport(){this.batchReport(this.bufferKeys,!1)}errorReport(){this.batchReport(this.errorKeys,!1)}batchReport(e,t=!1){const s=Object.keys(e).filter((t=>0===e[t]));if(0===s.length)return;if(s.length<=3)s.forEach((s=>{e[s]=1,this.byKey(e,s,t)}));else{const r=[...s];let h=0;for(;r.length>0;){const s=r.splice(0,3);s.length>0&&(s.forEach((t=>{e[t]=1})),setTimeout((()=>{s.forEach((s=>{this.byKey(e,s,t)}))}),150*h)),h++}}}byKey(e,t,s){this.sGet(t).then((r=>{if(!r)return e[t]=2,void 0;const h=s?this.sdk.env.compose(r):r;this.report(h).then((()=>{e[t]=2,this.sRemove(t)})).catch((()=>{e[t]=0}))})).catch((()=>{e[t]=0}))}report(e){if(!this.reportUrl&&(this.reportUrl=this.sdk.get("report_url"),!this.reportUrl))return Promise.reject();return this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:e})}storageError(e){const t=`${this.errorPreKey}_`+this.random();return this.sSet(t,e).then((()=>t))}sGet(t){const{adapter:s}=this.sdk;return s.get(t).then((r=>{if(!this.sdk.isObject(r)||!r.timestamp)return s.remove(t),null;const h=e();if(r.timestamp+6048e5<h)return s.remove(t),null;return r.data}))}sSet(t,s){const{adapter:r}=this.sdk;return r.set(t,{data:s,timestamp:e()})}sRemove(e){return this.sdk.adapter.remove(e)}random(){return`${+new Date}_${Math.floor(1e5*Math.random())}`}network(){return!!this.sdk.env.get("is_connected")}}t.pluginName="official:compensate";export{t as default};
