!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).$$LOGSDK_PLUGIN_COMPENSATE=t()}(this,(function(){"use strict";function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function t(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var n=function(){return+new Date},o=function(){function r(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.key="compensate",this.keyCache=[],this.batchMax=5,this.cacheBatchNumber=15,this.enable=!1,this.unReadyKeys={},this.bufferKeys={},this.errorKeys={},this.bufferPreKey="",this.errorPreKey="",this.hasKey=!1}var o,i,a;return o=r,i=[{key:"apply",value:function(e,r){var n=this;if(this.sdk=e,this.options=r,this.enable=!!this.options.enable_cache,!this.enable)return;this.reportUrl=this.sdk.get("report_url"),this.bufferPreKey=this.sdk.getKey("buffer"),this.errorPreKey=this.sdk.getKey("compensate");var o=this.sdk.types;this.sdk.on(o.AppShow,(function(){n.hasKey?n.sdk.ready&&n.network()&&n.nowReport():n.getKeys().then((function(){n.hasKey=!0,n.sdk.ready&&n.network()&&n.nowReport()}))})),this.sdk.on(o.Ready,(function(){n.hasKey?n.network()&&n.nowReport():n.getKeys().then((function(){n.hasKey=!0,n.network()&&n.nowReport()}))})),this.sdk.on(o.Network,(function(e){e.current&&n.sdk.ready&&n.nowReport()})),this.sdk.on(o.AppClose,(function(){try{["unReadyKeys","bufferKeys","errorKeys"].forEach((function(e){Object.keys(n[e]).forEach((function(t){2===n[e][t]&&delete n[e][t]}))}))}catch(e){}})),this.sdk.on(o.SubmitError,(function(e){var t=e.event;n.storageError(t).then((function(e){n.errorKeys[e]=0}))})),this.sdk.on(o.CacheUnReady,(function(e){var r=e.length;r>0&&!function(){var o="".concat(n.bufferPreKey,"_unready_");if(r>n.cacheBatchNumber)for(var i=t(e);i.length>0;){var a=i.splice(0,n.cacheBatchNumber);if(a.length>0){var s=o+n.random();n.sSet(s,a).then((function(){return n.unReadyKeys[o]=0}))}}else{var u=o+n.random();n.sSet(u,e).then((function(){return n.unReadyKeys[o]=0}))}}()})),this.sdk.on(o.CacheBuffer,(function(e){var t="".concat(n.bufferPreKey,"_buffer_")+n.random();n.sSet(t,e).then((function(){n.bufferKeys[t]=0}))}))}},{key:"getKeys",value:function(){var e=this;return this.sdk.adapter.storageInfo().then((function(t){if(null==t?void 0:t.keys){var r=t.keys;Array.isArray(r)&&r.forEach((function(t){0===t.indexOf("".concat(e.bufferPreKey,"_unready"))?void 0===e.unReadyKeys[t]&&(e.unReadyKeys[t]=0):0===t.indexOf("".concat(e.bufferPreKey,"_buffer"))?void 0===e.bufferKeys[t]&&(e.bufferKeys[t]=0):0===t.indexOf("".concat(e.errorPreKey))&&void 0===e.errorKeys[t]&&(e.errorKeys[t]=0)}))}}))}},{key:"nowReport",value:function(){this.unReadyReport(),this.bufferReport(),this.errorReport()}},{key:"unReadyReport",value:function(){this.batchReport(this.unReadyKeys,!0)}},{key:"bufferReport",value:function(){this.batchReport(this.bufferKeys,!1)}},{key:"errorReport",value:function(){this.batchReport(this.errorKeys,!1)}},{key:"batchReport",value:function(e){var r=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=Object.keys(e).filter((function(t){return 0===e[t]}));if(0===o.length)return;if(o.length<=3)o.forEach((function(t){e[t]=1,r.byKey(e,t,n)}));else for(var i=t(o),a=0,s=function(){var t=i.splice(0,3);t.length>0&&(t.forEach((function(t){e[t]=1})),setTimeout((function(){t.forEach((function(t){r.byKey(e,t,n)}))}),150*a)),a++};i.length>0;)s()}},{key:"byKey",value:function(e,t,r){var n=this;this.sGet(t).then((function(o){if(!o)return e[t]=2,void 0;var i=r?n.sdk.env.compose(o):o;n.report(i).then((function(){e[t]=2,n.sRemove(t)})).catch((function(){e[t]=0}))})).catch((function(){e[t]=0}))}},{key:"report",value:function(e){if(!this.reportUrl&&(this.reportUrl=this.sdk.get("report_url"),!this.reportUrl))return Promise.reject();return this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:e})}},{key:"storageError",value:function(e){var t="".concat(this.errorPreKey,"_")+this.random();return this.sSet(t,e).then((function(){return t}))}},{key:"sGet",value:function(e){var t=this,r=this.sdk.adapter;return r.get(e).then((function(o){if(!t.sdk.isObject(o)||!o.timestamp)return r.remove(e),null;var i=n();if(o.timestamp+6048e5<i)return r.remove(e),null;return o.data}))}},{key:"sSet",value:function(e,t){return this.sdk.adapter.set(e,{data:t,timestamp:n()})}},{key:"sRemove",value:function(e){return this.sdk.adapter.remove(e)}},{key:"random",value:function(){return"".concat(+new Date,"_").concat(Math.floor(1e5*Math.random()))}},{key:"network",value:function(){return!!this.sdk.env.get("is_connected")}}],i&&e(o.prototype,i),a&&e(o,a),o,r}();return o.pluginName="official:compensate",o}));
