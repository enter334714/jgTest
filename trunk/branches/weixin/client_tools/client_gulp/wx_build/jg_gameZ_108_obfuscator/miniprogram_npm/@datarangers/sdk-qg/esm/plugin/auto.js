const t=()=>+new Date,s=t=>{let s=t;try{s=decodeURIComponent(t)}catch(t){}return s};var e;!function(t){t.True="true",t.False="false"}(e||(e={}));const i=["wx","qq"];class p{constructor(){this.queue=[],this.firstTime=e.False,this.open=!1,this.startup=0}static init(t){var s,e,i,p,h,n;t.platform&&(null===(e=(s=t.platform).onShow)||void 0===e?void 0:e.call(s,(s=>{t.instances.forEach((t=>{t.emit(t.types.AppShowStart,s),t.emit(t.types.AppShow,s)}))})),null===(p=(i=t.platform).onHide)||void 0===p||p.call(i,(()=>{t.instances.forEach((t=>{t.emit(t.types.AppHide),t.emit(t.types.AppClose)}))})),null===(n=(h=t.platform).onError)||void 0===n||n.call(h,(s=>{t.instances.forEach((t=>{t.emit(t.types.AppError,s)}))}))),t.prototype.appLaunch=function(){this.appShow()},t.prototype.appTerminate=function(){this.appHide()},t.prototype.appShow=function(){let t;void 0!==this.target.getLaunchOptionsSync&&(t=this.target.getLaunchOptionsSync()),this.emit(this.types.AppShow,t)},t.prototype.appHide=function(){this.emit(this.types.AppHide)},t.prototype.appError=function(t){this.emit(this.types.AppError,t)},t.prototype.rangerOnShareAppMessage=function(t){this.emit(this.types.AppOnShare,t)},t.prototype.rangerShareAppMessage=function(t){this.emit(this.types.AppShare,t)}}apply(t,s){this.sdk=t,this.options=s,this.open=!!this.options.auto_report;const{types:p,adapter:h}=this.sdk,n=this.sdk.getKey("first");if(h.get(n).then((t=>{if(t===e.False)return this.firstTime=e.False,void 0;t||(this.firstTime=e.True),h.set(n,e.False)})),this.sdk.on(p.Ready,(()=>{this.queue.length>0&&(this.sdk.event([...this.queue]),this.queue.length=0)})),"undefined"!=typeof cc)return this.sdk.emit(this.sdk.types.LaunchComplete),void 0;this.sdk.target&&this.appLaunch(),this.open&&this.sdk.target&&(this.sdk.whichIs&&i.includes(this.sdk.whichIs)&&(this.appShowPrefix(this.appInfo),this.appShow(this.appInfo)),this.sdk.on(p.AppShow,(t=>{this.appShowPrefix(t),this.appShow(t)})),this.sdk.on(p.AppHide,(()=>{this.appHide()})),this.sdk.on(p.AppError,(t=>{this.appError(t)})),this.sdk.on(p.AppOnShare,(t=>{this.onShareAppMessage(t)})),this.sdk.on(p.AppShare,(t=>{this.shareAppMessage(t)})),this.sdk.on(p.UuidChangeBefore,(()=>{this.appHide(!0)})),this.sdk.on(p.UuidChangeAfter,(()=>{this.appShow(this.appInfo||{},!0)})))}event(s,e){const{ready:i}=this.sdk;i?this.sdk.event(s,e):this.queue.push({event:s,params:e,local_time_ms:t()})}getQuery(t={}){const e={};return this.sdk.isObject(t)&&Object.keys(t).forEach((i=>{if(!this.sdk.UtmType.includes(i)&&"scene"!==i){let p=t[i];"from_title"===i&&(p=encodeURIComponent(s(t[i]))),e[`query_${i}`]=p}})),e}appLaunch(){var t,s,e;this.appInfo=null===(s=(t=this.sdk.target).getLaunchOptionsSync)||void 0===s?void 0:s.call(t),this.scene=null===(e=this.appInfo)||void 0===e?void 0:e.scene,this.sdk.checkUsePlugin("official:utm")?this.sdk.emit(this.sdk.types.LaunchInfo,this.appInfo):this.sdk.emit(this.sdk.types.LaunchComplete)}appShowPrefix(t){this.startup++}}p.pluginName="official:auto",p.instances=[];class h extends p{constructor(){super(...arguments),this.sessionStart=0,this.sessionDepth=0,this.shareDepth=0}appShow(i,p=!1){this.sessionStart=t();const h={session_id:this.sdk.sessionId,$is_first_time:this.firstTime};if(i)if("string"==typeof i)h.query=i;else if("object"==typeof i){const{scene:t,query:e}=i;if(h.scene=t,h.path="/",e&&"object"==typeof e){this.shareDepth=Number(e.share_depth)||0;const t={},i={};let p=!1;Object.keys(e).forEach((n=>{const a=e[n];this.sdk.UtmType.includes(n)?(p=!0,i[n]=s(a)):(t[n]=a,h[`query_${n}`]=a)})),p&&this.sdk.env.set(i),h.query=JSON.stringify(t)}}h.launch_type=p?2:this.startup>1?1:0,this.event(this.sdk.EventType.appOnShow,h),this.firstTime===e.True&&(this.firstTime=e.False)}appHide(s=!1){const e={session_duration:Math.ceil((t()-this.sessionStart)/1e3),session_id:this.sdk.sessionId};e.terminate_type=s?2:1,this.event(this.sdk.EventType.appOnHide,e)}appError(t){let s={session_id:this.sdk.sessionId};if("string"==typeof t)s=Object.assign(Object.assign({},s),{stack:t,on_error:t});else{const{message:e="",stack:i=""}=this.sdk.isObject(t)?t:{};s=Object.assign(Object.assign({},s),{stack:i,on_error:i,message:e})}this.event(this.sdk.EventType.appOnError,s)}appShare(t){const{user_unique_id:s}=this.sdk.env.get("user"),e=(Number(this.shareDepth)||0)+1;let i=t||{};"object"!=typeof i&&(i={});const{title:p=""}=i,h=`from_user_unique_id=${s}&share_depth=${e}&from_title=${p}`;return i.query?i.query+="&"+h:i.query=h,this.event(this.sdk.EventType.pageOnShareAppMessage,Object.assign(Object.assign({},i.title?{title:i.title}:{}),{path:"/?"+i.query,query_share_depth:e,session_id:this.sdk.sessionId})),i}onShareAppMessage(t){try{"function"==typeof this.sdk.target.onShareAppMessage&&this.sdk.target.onShareAppMessage((()=>this.appShare(t())))}catch(t){}}shareAppMessage(t){try{"function"==typeof this.sdk.target.shareAppMessage&&this.sdk.target.shareAppMessage(this.appShare(t))}catch(t){}}}export{h as default};
