function e(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}const t=void 0,s={cn:"https://mcs.volceapplog.com",va:"https://mcs.itobsnssdk.com",sg:"https://mcs.tobsnssdk.com"},i={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share",pageOnAddToFavorites:"on_addtofavorites",mpClick:"bav2b_click"},r=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],n=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],o=()=>+new Date;class h{constructor(e){this.sdk=e,this.env=this.init()}init(){return{user:{web_id:t,user_unique_id:t,user_id:t,user_type:t,user_is_auth:t,user_is_login:t,ip_addr_id:t,device_id:t,user_unique_id_type:t},header:{app_id:t,app_name:t,app_install_id:t,install_id:t,app_package:t,app_channel:t,app_version:t,os_name:t,os_version:t,device_model:t,device_brand:t,traffic_type:t,client_ip:t,os_api:t,access:t,language:t,app_language:t,creative_id:t,ad_id:t,campaign_id:t,ab_client:t,ab_version:t,platform:t,sdk_version:t,sdk_lib:t,app_region:t,region:t,province:t,city:t,timezone:t,tz_offset:t,tz_name:t,sim_region:t,carrier:t,resolution:t,screen_width:t,screen_height:t,browser:t,browser_version:t,referrer:t,referrer_host:t,utm_source:t,utm_medium:t,utm_campaign:t,utm_term:t,utm_content:t,custom:{},ab_sdk_version:t,_sdk_version:t,_sdk_name:t,wechat_openid:t,wechat_unionid:t,is_connected:t}}}set(e){this.sdk.emit(this.sdk.types.EnvTransform,e),Object.keys(e).forEach((t=>{if("evtParams"===t)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),e.evtParams||{});else if("_staging_flag"===t)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),{_staging_flag:e._staging_flag});else{let s=t,i=e[t];if(null===i)return!1;let r="";s.indexOf(".")>-1&&([r,s]=s.split(".")),"platform"===s&&(i="mp"),"os_version"!==s&&"mp_platform"!==s||(i=`${i}`),r?("headers"===r&&(r="header"),"user"===r||"header"===r?this.env[r][s]=i:this.env.header.custom[s]=i):this.env.user.hasOwnProperty(s)?["user_type","ip_addr_id"].indexOf(s)>-1?this.env.user[s]=Number(i):["user_id","web_id","user_unique_id"].indexOf(s)>-1?this.env.user[s]=String(i):["user_is_auth","user_is_login"].indexOf(s)>-1?this.env.user[s]=Boolean(i):this.env.user[s]=i:this.env.header.hasOwnProperty(s)?this.env.header[s]=i:this.env.header.custom[s]=i}}))}get(e){if(!e||"env"===e)return this.clone(this.env);if("evtParams"===e)return Object.assign({},this[e]);if(this.env.hasOwnProperty(e))return this.clone(this.env[e]);if(this.env.user.hasOwnProperty(e))return this.clone(this.env.user[e]);if(this.env.header.hasOwnProperty(e))return this.clone(this.env.header[e]);if(this.env.header.custom.hasOwnProperty(e))return this.clone(this.env.header.custom[e])}compose(e,t=[]){const{user:s,header:i}=this.env,{evtParams:r}=this,n=e.map((e=>(e.event&&!t.includes(e.event)&&r&&Object.keys(r).forEach((t=>{void 0===e.params[t]&&(e.params[t]=r[t])})),e.params=JSON.stringify(e.params),e)));return this.clone({events:n,user:s,header:i})}merge(e,t=[]){const s=this.compose(e,t);return s.local_time=Math.floor(o()/1e3),[s]}clone(e){if(this.sdk.isObject(e))return JSON.parse(JSON.stringify(e));return e}}const a=e=>null!=e&&"[object Object]"==Object.prototype.toString.call(e),c=e=>"number"==typeof e&&!isNaN(e);class p{constructor(){this.domains=s,this.init()}init(){this.option={caller:"",log:!1,channel:"cn",report_channel:"cn",channel_domain:"",report_url:"",auto_report:false,auto_profile:false,profile_channel:"cn",enable_profile:false,enable_ab_test:false,ab_channel_domain:"",clear_ab_cache_on_user_change:true,enable_et_test:false,event_verify_url:"",enable_buffer:false,buffer_interval:5e3,buffer_number:5,enable_storage_only:false,enable_cache:false,enable_filter_list:false,enable_third:false,enable_filter_crawler:false,request_timeout:0,enable_initiative_launch:false,enable_custom_webid:false,disable_sdk_monitor:false,verify:null},this.cloneOption=Object.assign({},this.option),this.initDomain()}initDomain(){if(this.option.channel_domain)return this.domain=this.option.channel_domain,void 0;let e=this.option.report_channel;Object.keys(this.domains).includes(e)||(e="cn"),this.domain=this.domains[e]}set(e){if(!a(e))return;Object.keys(e).forEach((t=>{this.option.hasOwnProperty(t)&&("channel"===t||"report_channel"===t?(this.option.report_channel=this.option.channel=e[t]?e[t]:this.cloneOption[t],this.initDomain()):(this.option[t]=void 0===e[t]?this.cloneOption[t]:e[t],"channel_domain"===t&&this.initDomain()))}))}get(e){if(e){if(this.hasOwnProperty(e))return this[e];if(this.option.hasOwnProperty(e))return this.option[e];return}return Object.assign({},this.option)}}class u{constructor(){this.hooks={}}on(e,t){if(!e||!t||"function"!=typeof t)return;this.hooks[e]||(this.hooks[e]=[]),this.hooks[e].push(t)}once(e,t){if(!e||!t||"function"!=typeof t)return;const s=i=>{t(i),this.off(e,s)};this.on(e,s)}off(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;if(t){const s=this.hooks[e].indexOf(t);-1!==s&&this.hooks[e].splice(s,1)}else this.hooks[e]=[]}emit(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;[...this.hooks[e]].forEach((e=>{try{e(t)}catch(e){}}))}}class d{constructor(e){this.ready=!1,this.sdk=e}setLog(e){e&&this.sdk.isFunction(e.log)&&(this._log=e)}setRequest(e){if(this.sdk.isFunction(e)){const t=e(this.sdk);this.sdk.isFunction(t)&&(this._request=t)}}setStorage(e){this.sdk.isObject(e)&&this.sdk.isFunction(e.get)&&this.sdk.isFunction(e.set)&&this.sdk.isFunction(e.remove)&&(this._storage=e)}check(){if(!this._request||!this._storage)return;this.ready=!0}log(...e){if(!this._log)return;try{this.sdk.option.get("log")&&this._log.log(...e)}catch(e){}}request(e){var t;if(!this.ready)return Promise.reject(null);try{return null===(t=this._request)||void 0===t?void 0:t.call(this,e)}catch(e){}}get(e){if(!this.ready)return Promise.reject(null);return this._storage.get(e)}set(e,t){if(!this.ready)return Promise.reject(!1);return this._storage.set(e,t)}remove(e){if(!this.ready)return Promise.reject(!1);return this._storage.remove(e)}storageInfo(){if(!this.ready)return Promise.reject(null);return this._storage.info()}}var l;!function(e){e.Init="$init",e.Config="$config",e.Send="$send",e.Ready="$ready",e.TokenComplete="$token-complete",e.TokenStorage="$token-storage",e.TokenFetch="$token-fetch",e.TokenGet="$token-get",e.LaunchComplete="$launch-complete",e.ConfigUuid="$config-uuid",e.ConfigWebId="$config-webid",e.ConfigTransform="$config-transform",e.UuidChangeBefore="$uuid-change-before",e.UuidChangeAfter="$uuid-change-after",e.EnvTransform="$env-transform",e.Event="$event",e.Report="$report",e.AppOpen="$app-open",e.AppClose="$app-close",e.AppShowStart="$app-show-start",e.AppShow="$app-show",e.AppHide="$app-hide",e.AppError="$app-error",e.AppShare="$app-share",e.AppOnShare="$app-on-share",e.PageShow="$page-show",e.PageHide="$page-hide",e.PageShare="$page-share",e.SubmitBefore="$submit-before",e.SubmitAfter="$submit-after",e.SubmitError="$submit-error",e.FilterCrawler="$filter-crawler",e.LaunchInfo="$launch-info",e.Pause="$pause",e.CancelPause="$cancel-pause",e.AbVar="$ab-var",e.AbAllVars="$ab-all-vars",e.AbExternalVersion="$ab-external-version",e.AbVersionChangeOn="$ab-version-change-on",e.AbVersionChangeOff="$ab-version-change-off",e.AbRefresh="$ab-refresh",e.AbFetchAfter="$ab-fetch-After",e.ProfileSet="$profile-set",e.ProfileSetOnce="$profile-set-once",e.ProfileUnset="$profile-unset",e.ProfileIncrement="$profile-increment",e.ProfileAppend="$profile-append",e.ProfileClear="$profile-clear",e.ProfileSubmitAfter="$profile-submit-after",e.ProfileSubmitError="$profile-submit-error",e.TransformInfo="$transform-info",e.ExtendAppLaunch="$extend-app-launch",e.ExtendAppTerminate="$extend-app-terminate",e.ExtendAppError="$extend-app-error",e.ExtendPageShow="$extend-page-show",e.ExtendPageHide="$extend-page-hide",e.ExtendPageShare="$extend-page-share",e.ExtendPageFavorite="$extend-page-favorite",e.MpClick="$mp-click",e.Network="$network",e.CacheUnReady="$cache-unready",e.CacheBuffer="$cache-buffer",e.Verify="$verify",e.Check="$check"}(l||(l={}));var f=l,m=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));class _{constructor(){this.types=f,this.EventType=i,this.ProfileType=n,this.UtmType=r,this.SdkHook=f,this.Domains=s,this.inited=!1,this.sended=!1,this.pluginInstances=[],this.data={},this.unInitedCache=[],this.ready=!1,this.sessionId="",this.appShowStarted=!1,this.env=new h(this),this.option=new p,this.hook=new u,this.sessionId=m(),_.instances.push(this);try{this.adapter=new d(this),this.adapter.setLog(_._log),this.adapter.setRequest(_._request),this.adapter.setStorage(_._storage),this.adapter.check(),_.plugins.reduce(((e,t)=>{const{plugin:s}=t;return e.push(new s),e}),this.pluginInstances)}catch(e){}}on(e,t){var s;null===(s=this.hook)||void 0===s?void 0:s.on(e,t)}once(e,t){var s;null===(s=this.hook)||void 0===s?void 0:s.once(e,t)}off(e,t){var s;if(!t&&this.types[e])return;null===(s=this.hook)||void 0===s?void 0:s.off(e,t)}emit(e,t){var s;this.adapter.log(`emit ${e}`,t||""),null===(s=this.hook)||void 0===s||s.emit(e,t)}static useAdapterLog(e){_._log=e}static useAdapterRequest(e){_._request=e}static useAdapterStorage(e){_._storage=e}static usePlugin(e,t){const s=t||e.pluginName;if(s){let t=!1;for(let i=0,r=_.plugins.length;i<r;i++){if(_.plugins[i].name===s){_.plugins[i].plugin=e,t=!0;break}}t||_.plugins.push({name:s,plugin:e})}else _.plugins.push({plugin:e});if("function"==typeof e.init)try{e.init(_)}catch(e){}}get appId(){return this._appId}checkUsePlugin(e){return!!_.plugins.find((({name:t})=>t===e))}init(t){if(this.inited||!this.isObject(t))return;const{app_id:s,log:i}=t,r=e(t,["app_id","log"]);if(void 0!==i&&this.option.set({log:i}),!(c(s)&&s>0))return this.adapter.log("app_id invalid"),void 0;this._appId=s,this.option.set(r),this.env.set({app_id:s}),Promise.all([new Promise((e=>{this.once(this.types.TokenComplete,(()=>{e(!0)}))})),new Promise((e=>{this.checkUsePlugin("official:auto")?this.on(this.types.LaunchComplete,(()=>{e(!0)})):e(!0)})),new Promise((e=>{this.sended?e(!0):this.once(this.types.Send,(()=>{e(!0)}))}))]).then((()=>{this.ready=!0,this.emit(this.types.Ready)})),this.on(this.types.AppShowStart,(()=>{this.appShowStarted?this.sessionId=m():this.appShowStarted=!0})),this.on(this.types.UuidChangeAfter,(()=>{this.sessionId=m()}));const n=this.option.get();if(this.pluginInstances.forEach((e=>{e.apply(this,n)})),this.get("is-crawler"))return;this.inited=!0,this.emit(this.types.Init),this.unInitedCache.length>0&&this.unInitedCache.forEach((e=>{this.emit(this.types.Event,e)}))}config(t){if(!this.inited||!this.isObject(t))return;this.emit(this.types.Config,t),this.emit(this.types.ConfigTransform,t);const{web_id:s,user_unique_id:i}=t,r=e(t,["web_id","user_unique_id"]);void 0!==s&&this.emit(this.types.ConfigWebId,s),void 0!==i&&this.emit(this.types.ConfigUuid,i),this.emit(this.types.Check,{type:"config",value:r}),this.env.set(r)}send(){if(!this.inited||this.sended)return;this.sended=!0,this.emit(this.types.Send)}event(e,t){if(this.get("is-crawler"))return;if(Array.isArray(e)){const t=o(),s=[];e.forEach((e=>{let i,r,n;if(Array.isArray(e)?[i,r,n]=e:this.isObject(e)&&(i=e.event,r=e.params,n=e.local_time_ms),!i)return;(!c(n)||n<0||n>t)&&(n=t),s.push(this.createEvent({event:i,params:r,time:n}))})),s.length>0&&(this.inited?this.emit(this.types.Event,s):this.unInitedCache.push(s))}else{const s=this.createEvent({event:e,params:t});this.inited?this.emit(this.types.Event,s):this.unInitedCache.push(s),this.emit(this.types.Verify,{event:e,params:t})}}createEvent(e,t=!0){const s=Object.assign({event:e.event,params:e.params||{},local_time_ms:e.time||o()},this.sessionId?{session_id:this.sessionId}:{});if(this.emit(this.types.Check,{type:"event",value:s}),!t)return s;let i="";const r=this.get("ab_sdk_version");r&&(i+=r);const n=this.get("ab_sdk_version_external");return n&&(i?i+=","+n:i=n),Object.assign(Object.assign({},s),i?{ab_sdk_version:i}:{})}set(e,t){this.data[e]=t}get(e){return this.data[e]}getKey(e){const t=this.appId;if("ab_version"===e||"ab_version_external"===e)return`__tea_sdk_${e}_${t}`;const s={token:"tokens",report:"reports",event:"events",utm:"utm",first:"first",compensate:"compensate",buffer:"buffer"};return s[e]?`__tea_cache_${s[e]}_${t}`:void 0}getUrl(e){const{option:t,env:s}=this,i=s.get("_sdk_version"),r=(s.get("_sdk_name")||"").replace(/@.+\//,""),n=`${t.get("domain")}${e}?sdk_version=${i}&sdk_name=${r}`,o=t.get("caller");if(o)return`${n}&app_id=${this.appId}&caller=${o}`;return n}getToken(e){if(e)return this.emit(this.types.TokenGet,{callback:e}),void 0;return new Promise((e=>{this.emit(this.types.TokenGet,{callback:t=>{e(t)}})}))}getConfig(e){return this.env.get(e||"header")}stash(e,t={}){const s="stash";this.set(s,[...this.get(s)||[],this.createEvent({event:e,params:t})])}commit(){const e="stash",t=this.get(e)||[];t.length>0&&(this.event(t),this.set(e,[]))}isObject(e){return a(e)}isArray(e){return(e=>"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e))(e)}isNumber(e){return c(e)}isString(e){return(e=>"string"==typeof e)(e)}isFunction(e){return(e=>"function"==typeof e)(e)}isUndefined(e){return void 0===e}}_.plugins=[],_.instances=[];class g{apply(e,t){e.env.set({sdk_version:"2.1.1",_sdk_version:"2.1.1",_sdk_name:"@datarangers/sdk-qg"})}}var b;g.pluginName="official:info",function(e){e.Default="default",e.Custom="custom"}(b||(b={}));class k{constructor(e,t){this.wrap=e,this.sdk=t,this.url="/webid/"}storageNoData(){this.fetch()}storageHasData(e){return this.wrap.dataComplete(e)}fetch(){const{adapter:e,appId:t}=this.sdk;e.request({url:this.sdk.getUrl(`${this.url}`),method:"POST",data:{app_id:t,url:"-",user_agent:"-",referer:"-",user_unique_id:""}}).then((t=>{try{const{data:{e:s=-1e4,web_id:i=""}={}}=t;if(0===s)return this.fetchComplete(i),void 0;e.log("parse web_id error",s)}catch(t){e.log("parse web_id error",t)}this.fetchComplete()})).catch((t=>{this.fetchComplete(),e.log("fetch web_id error",t)}))}fetchComplete(e){if(!e)return;this.wrap.webIdComplete(e)}storageComplete(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===b.Default){const t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}class y{constructor(e,t){this.wrap=e,this.sdk=t,this.sdk.on(this.sdk.types.ConfigWebId,(e=>{e=`${e}`,this.wrap.tokenComplete?this.waitComplete(e):this.waitResolve?this.waitResolve(e):this.tmpWebId=e}))}storageNoData(){this.wait()}storageHasData(e){return this.wrap.dataComplete(e,this.tmpWebId)}wait(){new Promise((e=>{void 0!==this.tmpWebId?(e(this.tmpWebId),this.tmpWebId=void 0):this.waitResolve=e})).then((e=>{this.waitComplete(e)}))}waitComplete(e){this.wrap.webIdComplete(e)}storageComplete(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===b.Custom){const t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}class v{constructor(){this.tokenComplete=!1,this.tobid="",this.tobidUrl="/tobid/",this.tobidKey="",this.isCustom=!1,this.typeKey="_type_"}apply(e,t){this.sdk=e,this.options=t,this.key=this.sdk.getKey("token"),this.tobidKey="diss".split("").reverse().join(""),this.options.enable_custom_webid?(this.isCustom=!0,this.token=new y(this,this.sdk)):(this.isCustom=!1,this.token=new k(this,this.sdk));const{types:s}=this.sdk;this.sdk.on(s.ConfigUuid,(e=>{this.setUserUniqueId(e)})),this.sdk.on(s.TokenGet,(({callback:e})=>{const t=()=>{this.fetchTobid().then((()=>{const t=this.sdk.env.get("user"),s=Object.assign(Object.assign({},t),{web_id:this.webId,user_unique_id:this.userUniqueId});s[this.tobidKey]=this.tobid,"function"==typeof e&&e(s)}))};this.sdk.ready?t():this.sdk.once(s.Ready,(()=>{t()}))})),this.storage()}storage(){const{adapter:e}=this.sdk;e.get(this.key).then((t=>{if(!this.sdk.isObject(t)||!t.web_id)return this.storageComplete(null),void 0;t[this.typeKey]&&!t[this.tobidKey]&&t.user_unique_id||(t={web_id:t.web_id,user_unique_id:t.user_unique_id||t.web_id,[this.typeKey]:this.isCustom?b.Custom:b.Default},e.set(this.key,t)),this.storageComplete(t)})).catch((t=>{this.storageComplete(null),e.log("get token error",t)}))}storageComplete(e){this.token.storageComplete(e)}dataComplete(e,t){let s=e.web_id;void 0!==t&&t!==s&&(s=t),this.webId=s;let i=e.web_id===e.user_unique_id?s:e.user_unique_id;return void 0!==this.tmpUserUniqueId&&this.tmpUserUniqueId!==i&&(i=this.tmpUserUniqueId?this.tmpUserUniqueId:s,this.tmpUserUniqueId=void 0),this.userUniqueId=i,s!==e.web_id||i!==e.user_unique_id}webIdComplete(e){this.webId=e,this.tmpUserUniqueId?(this.userUniqueId=this.tmpUserUniqueId,this.tmpUserUniqueId=void 0):this.userUniqueId=e,this.complete(!0)}complete(e=!1){const{types:t}=this.sdk,s={web_id:this.webId,user_unique_id:this.userUniqueId};this.sdk.env.set(s),s[this.typeKey]=this.isCustom?b.Custom:b.Default,e&&this.sdk.adapter.set(this.key,s),this.tokenComplete=!0,this.sdk.emit(t.TokenComplete)}setUserUniqueId(e){const{adapter:t,env:s,types:i}=this.sdk;if(this.tokenComplete){if(this.userUniqueId===e)return;this.sdk.emit(i.UuidChangeBefore),this.userUniqueId=e||this.webId,s.set({user_unique_id:this.userUniqueId});const r={web_id:this.webId,user_unique_id:this.userUniqueId,[this.typeKey]:this.isCustom?b.Custom:b.Default};t.set(this.key,r),this.sdk.emit(i.UuidChangeAfter)}else this.tmpUserUniqueId=e}fetchTobid(){const{adapter:e,appId:t}=this.sdk;return e.request({url:this.sdk.getUrl(`${this.tobidUrl}`),method:"POST",data:{app_id:t,web_id:this.webId,user_unique_id:this.userUniqueId}}).then((e=>{try{const{data:{e:t=-1e4,tobid:s=""}={}}=e;if(0===t)return this.tobid=s,void 0}catch(e){}})).catch((t=>{e.log("fetch tobid error",t)}))}}v.pluginName="official:token";class w{constructor(){this.url="/list/",this.cache=[],this.pause=!1,this.eventName="request_status__"}apply(e,t){this.sdk=e,this.options=t,this.key=this.sdk.getKey("report"),this.reportUrl=this.sdk.getUrl(`${this.url}`),this.sdk.set("report_url",this.reportUrl);const{types:s}=this.sdk;this.sdk.on(s.Report,(e=>{if(Array.isArray(e)||(e=[e]),!this.sdk.ready||this.pause)return e.forEach((e=>this.cache.push(e))),void 0;this.report(e)})),this.sdk.on(s.Ready,(()=>{this.reportCache()})),this.sdk.on(s.Pause,(()=>{this.pause=!0})),this.sdk.on(s.CancelPause,(()=>{this.pause=!1,this.reportCache()}));const{adapter:i}=this.sdk;this.sdk.on(s.AppOpen,(()=>{i.get(this.key).then((()=>{}))})),this.sdk.on(s.AppClose,(()=>{this.cache.length>0&&(i.set(this.key,[...this.cache]),this.cache.length=0)}))}reportCache(){this.cache.length>0&&(this.report([...this.cache]),this.cache.length=0)}report(e){this.submit(e)}submit(e){const{types:t}=this.sdk;this.sdk.emit(t.SubmitBefore,e),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:e}).then((s=>{this.sdk.emit(t.SubmitAfter,{isError:!1,response:s,event:e});try{if(this.checkMonitor(e))return;const{data:t,statusCode:i}=s;if(0!==t.e){const s=e.map((e=>null==e?void 0:e.events));this.reportMonitor({status_code:i,response_data:JSON.stringify(t),event_info:JSON.stringify(s)})}}catch(e){}})).catch((s=>{this.sdk.emit(t.SubmitAfter,{isError:!0,error:s,event:e});try{if(this.checkMonitor(e))return;this.sdk.emit(t.SubmitError,{event:e})}catch(e){}}))}reportMonitor(e){const t=this.sdk.createEvent({event:this.eventName,params:e}),s=this.sdk.env.merge([t]);this.submit(s)}checkMonitor(e){if(e&&e[0]&&e[0].events[0]&&e[0].events[0].event===this.eventName)return!0;return!1}}w.pluginName="official:report";class C{constructor(){this.buffer=[],this.timer=0,this.unReadyCache=[],this.cacheBatchNumber=15}apply(e,t){var s,i;this.sdk=e,this.options=t,this.enable=!!this.options.enable_buffer,this.cacheEnable=!!this.options.enable_cache;const r=!0===this.options.enable_storage||!1===this.options.disable_storage;if(r&&(this.enable=!0),this.enable){this.interval=this.options.buffer_interval,this.number=this.options.buffer_number,r&&((null===(s=this.options)||void 0===s?void 0:s.report_interval)>0&&(this.interval=this.options.report_interval),(null===(i=this.options)||void 0===i?void 0:i.max_batch_event)>0&&(this.number=this.options.max_batch_event));try{this.interval=Number(this.interval),this.number=Number(this.number)}catch(e){}}const{types:n}=this.sdk;this.sdk.on(n.Event,(e=>{const t=Array.isArray(e)?e:[e];if(!this.sdk.ready)return this.unReadyCache=[...this.unReadyCache,...t],this.cacheEnable&&this.unReadyCache.length>=this.cacheBatchNumber&&(this.sdk.emit(n.CacheUnReady,[...this.unReadyCache]),this.unReadyCache.length=0),void 0;this.process(t)})),this.sdk.on(n.Ready,(()=>{this.unReadyCache.length>0&&(this.process(this.unReadyCache),this.unReadyCache.length=0)})),this.sdk.on(n.Network,(e=>{!e.origin&&e.current&&(this.enable?this.refresh():this.buffer.length>0&&(this.report([...this.buffer]),this.buffer.length=0))})),this.sdk.on(n.AppClose,(()=>{if(this.timer&&clearTimeout(this.timer),!this.sdk.ready)return this.cacheEnable&&this.unReadyCache.length>0&&(this.sdk.emit(n.CacheUnReady,[...this.unReadyCache]),this.unReadyCache.length=0),void 0;if(this.buffer.length>0){this.network()?this.report([...this.buffer]):this.cacheEnable&&this.sdk.emit(n.CacheBuffer,[...this.buffer]),this.buffer.length=0}}))}process(e){const t=this.sdk.env.compose(e);this.network()?this.enable?(this.buffer=[...this.buffer,t],this.refresh()):this.report(t):(this.buffer=[...this.buffer,t],this.cacheEnable&&this.buffer.length>=this.cacheBatchNumber&&(this.sdk.emit(this.sdk.types.CacheBuffer,[...this.buffer]),this.buffer.length=0))}refresh(){this.buffer.length>=this.number?(this.timer&&(clearTimeout(this.timer),this.timer=0),this.report([...this.buffer]),this.buffer.length=0):this.timer||(this.timer=setTimeout((()=>{this.timer=0,this.buffer.length>0&&(this.report([...this.buffer]),this.buffer.length=0)}),this.interval))}report(e){this.sdk.emit(this.sdk.types.Report,e)}network(){return!!this.sdk.env.get("is_connected")}}C.pluginName="official:buffer";class O{apply(e,t){this.sdk=e,this.options=t;const{types:s,env:i}=this.sdk,r=(()=>{try{const e=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(e)/60),offset:60*e}}catch(e){return{timezone:8,offset:-28800}}})();i.set({timezone:r.timezone,tz_offset:r.offset}),this.sdk.on(s.ConfigTransform,(e=>{void 0!==e.user_unique_id_type&&(e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),{$user_unique_id_type:e.user_unique_id_type})),void 0!==e.gender&&([1,2,"1","2"].includes(e.gender)?e.gender=e.gender<2?"male":"female":delete e.gender);if(!!this.options.enable_profile){const t={};["nick_name","gender","avatar_url"].forEach((s=>{void 0!==e[s]&&(t[s]=e[s],delete e[s])})),this.sdk.emit(s.ProfileSet,t)}})),this.sdk.on(s.EnvTransform,(e=>{if(!!this.options.enable_profile){const t={};["$mp_from_uuid"].forEach((s=>{void 0!==e[s]&&(t[s]=e[s],delete e[s])})),Object.keys(t).length>0&&this.sdk.emit(s.ProfileSetOnce,t)}}))}}O.pluginName="official:transform";class P{constructor(){this.url="/profile/list",this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[]}static init(e){e.prototype.profileSet=function(e){this.emit(this.types.ProfileSet,e)},e.prototype.profileSetOnce=function(e){this.emit(this.types.ProfileSetOnce,e)},e.prototype.profileUnset=function(e){this.emit(this.types.ProfileUnset,e)},e.prototype.profileIncrement=function(e){this.emit(this.types.ProfileIncrement,e)},e.prototype.profileAppend=function(e){this.emit(this.types.ProfileAppend,e)}}apply(e,t){this.sdk=e,this.options=t;const{types:s}=this.sdk;this.sdk.on(s.ProfileSet,(e=>{this.check()&&this.setProfile(e)})),this.sdk.on(s.ProfileSetOnce,(e=>{this.check()&&this.setOnceProfile(e)})),this.sdk.on(s.ProfileUnset,(e=>{this.check()&&this.unsetProfile(e)})),this.sdk.on(s.ProfileIncrement,(e=>{this.check()&&this.incrementProfile(e)})),this.sdk.on(s.ProfileAppend,(e=>{this.check()&&this.appendProfile(e)})),this.sdk.on(s.ProfileClear,(()=>{this.cache={}})),this.sdk.on(s.Ready,(()=>{if(!this.buffer.length)return;this.reportMore([...this.buffer]),this.buffer=[]}))}check(){return!!this.options.enable_profile}setProfile(e){const t=this.debounce(e);if(!t)return;this.putCache(t);const s=this.filter(t,(e=>this.sdk.isString(e)||this.sdk.isNumber(e)||this.sdk.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_set",params:s}))}setOnceProfile(e){const t=this.debounce(e,!0);if(!t)return;this.putCache(t);const s=this.filter(t,(e=>this.sdk.isString(e)||this.sdk.isNumber(e)||this.sdk.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_set_once",params:s}))}incrementProfile(e){if(!e)return;const t=this.filter(e,(e=>this.sdk.isNumber(e)));this.report(this.sdk.createEvent({event:"__profile_increment",params:t}))}unsetProfile(e){if(!e||!this.sdk.isString(e))return;const t={};t[e]="1",this.report(this.sdk.createEvent({event:"__profile_unset",params:t}))}appendProfile(e){if(!e||!this.sdk.isObject(e)||this.isEmpty(e))return;const t=this.filter(e,(e=>this.sdk.isString(e)||this.sdk.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_append",params:t}))}reportMore(e){if(this.sdk.ready){const t=this.sdk.env.merge(e,this.sdk.ProfileType),{adapter:s,option:i}=this.sdk;s.request({url:`${i.get("domain")}${this.url}`,method:"POST",data:t}).then((e=>{this.sdk.emit(this.sdk.types.ProfileSubmitAfter,{isError:!0,response:e,event:t})})).catch((e=>{this.sdk.emit(this.sdk.types.ProfileSubmitError,{isError:!0,error:e,event:t})}))}else e.forEach((e=>{this.buffer.push(e)}))}report(e){this.reportMore([e])}ms(){return o()}debounce(e,t=!1){if(!e||!this.sdk.isObject(e)||this.isEmpty(e))return;let s=Object.keys(e);const i=this.ms(),r=s.filter((s=>{const r=this.cache[s];if(r&&(t||this.compare(r.val,e[s])&&i-r.timestamp<this.duration))return!1;return!0})).reduce(((t,s)=>(t[s]=e[s],t)),{});if(s=Object.keys(r),!s.length)return;return r}putCache(e){const t=this.ms();Object.keys(e).forEach((s=>{this.cache[s]={val:this.clone(e[s]),timestamp:t}}))}clone(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}compare(e,t){return JSON.stringify(e)===JSON.stringify(t)}filter(e,t){return Object.keys(e).reduce(((s,i)=>{const r=e[i];return t(r)&&(s[i]=r),s}),{})}isEmpty(e){return!Object.keys(e).length}}P.pluginName="official:profile",_.usePlugin(g),_.usePlugin(v),_.usePlugin(w),_.usePlugin(C),_.usePlugin(O),_.usePlugin(P);var $=console,S=((e,t=!1)=>s=>i=>{const r=i.timeout||s.option.get("request_timeout"),n="number"==typeof r&&r>0;return new Promise(((s,o)=>{const h=e.request(Object.assign(Object.assign(Object.assign({},i),n&&!t?{timeout:r}:{}),{dataType:i.dataType||"json",success:e=>{s(e)},fail:e=>{o(e)}}));n&&t&&setTimeout((()=>{try{h&&h.abort()}catch(e){}}),r)}))})(tt);var I=new class{constructor(e){this.target=e}get(e){return new Promise(((t,s)=>{try{t(this.target.getStorageSync(e))}catch(e){s(e)}}))}set(e,t){return new Promise(((s,i)=>{try{this.target.setStorageSync(e,t),s(!0)}catch(e){i(!1)}}))}remove(e){return new Promise(((t,s)=>{try{this.target.removeStorageSync(e),t(!0)}catch(e){s(!1)}}))}info(){return new Promise(((e,t)=>{try{this.target.getStorageInfo({success(t){e(t)},fail(){t(null)}})}catch(e){t(null)}}))}}(tt);class A{constructor(){this.timer=0}apply(e,t){this.sdk=e,this.options=t,this.boost();const{types:s}=this.sdk;this.getInfo(),this.sdk.on(s.AppOpen,(()=>{this.getInfo(),this.onChange()}))}boost(){}getInfo(){const{target:e}=this.sdk;e&&(this.system(e),this.network(e))}system(e){const t=this,{env:s}=this.sdk;e.getSystemInfo&&e.getSystemInfo({success(e){const i=Math.ceil(e.screenWidth),r=Math.ceil(e.screenHeight),n={device_brand:e.brand,device_model:e.model,os_version:e.system,os_name:e.platform,platform:e.platform,resolution:`${i}x${r}`,screen_width:i,screen_height:r};t.overlap(e,n),s.set(n)}})}network(e){const t=this,{env:s,types:i}=this.sdk;e.getNetworkType&&e.getNetworkType({success(e){const r={access:e.networkType,is_connected:void 0!==e.networkAvailable?!!e.networkAvailable:"none"!==e.networkType};t.sdk.emit(i.Network,{origin:s.get("is_connected"),current:r.is_connected}),s.set(r)},fail(){if(t.timer>0)return;t.timer=setTimeout((()=>{t.network(e)}),50)}})}onChange(){const{target:e,env:t,types:s}=this.sdk;null==e?void 0:e.onNetworkStatusChange((e=>{this.sdk.emit(s.Network,{origin:t.get("is_connected"),current:null==e?void 0:e.isConnected}),t.set({access:null==e?void 0:e.networkType,is_connected:null==e?void 0:e.isConnected})}))}overlap(e,t){t.language=e.language,t.mp_platform_app_version=e.version,t.mp_platform_basic_version=e.SDKVersion}}A.pluginName="official:device";class q extends A{boost(){super.boost(),this.sdk.env.set(Object.assign({sdk_lib:"qg_common",custom_platform:"quickGame",mp_platform:4},"undefined"!=typeof qg||"undefined"!=typeof cc?{is_connected:!0}:{}))}overlap(e,t){super.overlap(e,t),t.os_version=e.system||e.osVersionName,t.os_name=e.platform||e.platformVersionName}}_.useAdapterLog($),_.useAdapterRequest(S),_.useAdapterStorage(I),_.usePlugin(class extends q{static init(e){e.platform=tt}boost(){super.boost(),this.sdk.target=tt}});export{_ as default};
