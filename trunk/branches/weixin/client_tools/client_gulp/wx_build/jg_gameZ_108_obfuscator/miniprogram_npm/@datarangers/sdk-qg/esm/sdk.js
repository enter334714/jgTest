import e from"./plugin/check";import t from"./plugin/verify";import s from"./plugin/ab";import i from"./plugin/utm";import r from"./plugin/monitor";import n from"./plugin/extend";import o from"./plugin/auto";import a from"./plugin/compensate";function h(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}const c=void 0,u={cn:"https://mcs.volceapplog.com",va:"https://mcs.itobsnssdk.com",sg:"https://mcs.tobsnssdk.com"},p={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share",pageOnAddToFavorites:"on_addtofavorites",mpClick:"bav2b_click"},d=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],l=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],f=()=>+new Date;class m{constructor(e){this.sdk=e,this.env=this.init()}init(){return{user:{web_id:c,user_unique_id:c,user_id:c,user_type:c,user_is_auth:c,user_is_login:c,ip_addr_id:c,device_id:c,user_unique_id_type:c},header:{app_id:c,app_name:c,app_install_id:c,install_id:c,app_package:c,app_channel:c,app_version:c,os_name:c,os_version:c,device_model:c,device_brand:c,traffic_type:c,client_ip:c,os_api:c,access:c,language:c,app_language:c,creative_id:c,ad_id:c,campaign_id:c,ab_client:c,ab_version:c,platform:c,sdk_version:c,sdk_lib:c,app_region:c,region:c,province:c,city:c,timezone:c,tz_offset:c,tz_name:c,sim_region:c,carrier:c,resolution:c,screen_width:c,screen_height:c,browser:c,browser_version:c,referrer:c,referrer_host:c,utm_source:c,utm_medium:c,utm_campaign:c,utm_term:c,utm_content:c,custom:{},ab_sdk_version:c,_sdk_version:c,_sdk_name:c,wechat_openid:c,wechat_unionid:c,is_connected:c}}}set(e){this.sdk.emit(this.sdk.types.EnvTransform,e),Object.keys(e).forEach((t=>{if("evtParams"===t)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),e.evtParams||{});else if("_staging_flag"===t)this.evtParams=Object.assign(Object.assign({},this.evtParams||{}),{_staging_flag:e._staging_flag});else{let s=t,i=e[t];if(null===i)return!1;let r="";s.indexOf(".")>-1&&([r,s]=s.split(".")),"platform"===s&&(i="mp"),"os_version"!==s&&"mp_platform"!==s||(i=`${i}`),r?("headers"===r&&(r="header"),"user"===r||"header"===r?this.env[r][s]=i:this.env.header.custom[s]=i):this.env.user.hasOwnProperty(s)?["user_type","ip_addr_id"].indexOf(s)>-1?this.env.user[s]=Number(i):["user_id","web_id","user_unique_id"].indexOf(s)>-1?this.env.user[s]=String(i):["user_is_auth","user_is_login"].indexOf(s)>-1?this.env.user[s]=Boolean(i):this.env.user[s]=i:this.env.header.hasOwnProperty(s)?this.env.header[s]=i:this.env.header.custom[s]=i}}))}get(e){if(!e||"env"===e)return this.clone(this.env);if("evtParams"===e)return Object.assign({},this[e]);if(this.env.hasOwnProperty(e))return this.clone(this.env[e]);if(this.env.user.hasOwnProperty(e))return this.clone(this.env.user[e]);if(this.env.header.hasOwnProperty(e))return this.clone(this.env.header[e]);if(this.env.header.custom.hasOwnProperty(e))return this.clone(this.env.header.custom[e])}compose(e,t=[]){const{user:s,header:i}=this.env,{evtParams:r}=this,n=e.map((e=>(e.event&&!t.includes(e.event)&&r&&Object.keys(r).forEach((t=>{void 0===e.params[t]&&(e.params[t]=r[t])})),e.params=JSON.stringify(e.params),e)));return this.clone({events:n,user:s,header:i})}merge(e,t=[]){const s=this.compose(e,t);return s.local_time=Math.floor(f()/1e3),[s]}clone(e){if(this.sdk.isObject(e))return JSON.parse(JSON.stringify(e));return e}}const g=e=>null!=e&&"[object Object]"==Object.prototype.toString.call(e),_=e=>"number"==typeof e&&!isNaN(e);class y{constructor(){this.domains=u,this.init()}init(){this.option={caller:"",log:!1,channel:"cn",report_channel:"cn",channel_domain:"",report_url:"",auto_report:false,auto_profile:false,profile_channel:"cn",enable_profile:false,enable_ab_test:false,ab_channel_domain:"",clear_ab_cache_on_user_change:true,enable_et_test:false,event_verify_url:"",enable_buffer:false,buffer_interval:5e3,buffer_number:5,enable_storage_only:false,enable_cache:false,enable_filter_list:false,enable_third:false,enable_filter_crawler:false,request_timeout:0,enable_initiative_launch:false,enable_custom_webid:false,disable_sdk_monitor:false,verify:null},this.cloneOption=Object.assign({},this.option),this.initDomain()}initDomain(){if(this.option.channel_domain)return this.domain=this.option.channel_domain,void 0;let e=this.option.report_channel;Object.keys(this.domains).includes(e)||(e="cn"),this.domain=this.domains[e]}set(e){if(!g(e))return;Object.keys(e).forEach((t=>{this.option.hasOwnProperty(t)&&("channel"===t||"report_channel"===t?(this.option.report_channel=this.option.channel=e[t]?e[t]:this.cloneOption[t],this.initDomain()):(this.option[t]=void 0===e[t]?this.cloneOption[t]:e[t],"channel_domain"===t&&this.initDomain()))}))}get(e){if(e){if(this.hasOwnProperty(e))return this[e];if(this.option.hasOwnProperty(e))return this.option[e];return}return Object.assign({},this.option)}}class b{constructor(){this.hooks={}}on(e,t){if(!e||!t||"function"!=typeof t)return;this.hooks[e]||(this.hooks[e]=[]),this.hooks[e].push(t)}once(e,t){if(!e||!t||"function"!=typeof t)return;const s=i=>{t(i),this.off(e,s)};this.on(e,s)}off(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;if(t){const s=this.hooks[e].indexOf(t);-1!==s&&this.hooks[e].splice(s,1)}else this.hooks[e]=[]}emit(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;[...this.hooks[e]].forEach((e=>{try{e(t)}catch(e){}}))}}class k{constructor(e){this.ready=!1,this.sdk=e}setLog(e){e&&this.sdk.isFunction(e.log)&&(this._log=e)}setRequest(e){if(this.sdk.isFunction(e)){const t=e(this.sdk);this.sdk.isFunction(t)&&(this._request=t)}}setStorage(e){this.sdk.isObject(e)&&this.sdk.isFunction(e.get)&&this.sdk.isFunction(e.set)&&this.sdk.isFunction(e.remove)&&(this._storage=e)}check(){if(!this._request||!this._storage)return;this.ready=!0}log(...e){if(!this._log)return;try{this.sdk.option.get("log")&&this._log.log(...e)}catch(e){}}request(e){var t;if(!this.ready)return Promise.reject(null);try{return null===(t=this._request)||void 0===t?void 0:t.call(this,e)}catch(e){}}get(e){if(!this.ready)return Promise.reject(null);return this._storage.get(e)}set(e,t){if(!this.ready)return Promise.reject(!1);return this._storage.set(e,t)}remove(e){if(!this.ready)return Promise.reject(!1);return this._storage.remove(e)}storageInfo(){if(!this.ready)return Promise.reject(null);return this._storage.info()}}var v;!function(e){e.Init="$init",e.Config="$config",e.Send="$send",e.Ready="$ready",e.TokenComplete="$token-complete",e.TokenStorage="$token-storage",e.TokenFetch="$token-fetch",e.TokenGet="$token-get",e.LaunchComplete="$launch-complete",e.ConfigUuid="$config-uuid",e.ConfigWebId="$config-webid",e.ConfigTransform="$config-transform",e.UuidChangeBefore="$uuid-change-before",e.UuidChangeAfter="$uuid-change-after",e.EnvTransform="$env-transform",e.Event="$event",e.Report="$report",e.AppOpen="$app-open",e.AppClose="$app-close",e.AppShowStart="$app-show-start",e.AppShow="$app-show",e.AppHide="$app-hide",e.AppError="$app-error",e.AppShare="$app-share",e.AppOnShare="$app-on-share",e.PageShow="$page-show",e.PageHide="$page-hide",e.PageShare="$page-share",e.SubmitBefore="$submit-before",e.SubmitAfter="$submit-after",e.SubmitError="$submit-error",e.FilterCrawler="$filter-crawler",e.LaunchInfo="$launch-info",e.Pause="$pause",e.CancelPause="$cancel-pause",e.AbVar="$ab-var",e.AbAllVars="$ab-all-vars",e.AbExternalVersion="$ab-external-version",e.AbVersionChangeOn="$ab-version-change-on",e.AbVersionChangeOff="$ab-version-change-off",e.AbRefresh="$ab-refresh",e.AbFetchAfter="$ab-fetch-After",e.ProfileSet="$profile-set",e.ProfileSetOnce="$profile-set-once",e.ProfileUnset="$profile-unset",e.ProfileIncrement="$profile-increment",e.ProfileAppend="$profile-append",e.ProfileClear="$profile-clear",e.ProfileSubmitAfter="$profile-submit-after",e.ProfileSubmitError="$profile-submit-error",e.TransformInfo="$transform-info",e.ExtendAppLaunch="$extend-app-launch",e.ExtendAppTerminate="$extend-app-terminate",e.ExtendAppError="$extend-app-error",e.ExtendPageShow="$extend-page-show",e.ExtendPageHide="$extend-page-hide",e.ExtendPageShare="$extend-page-share",e.ExtendPageFavorite="$extend-page-favorite",e.MpClick="$mp-click",e.Network="$network",e.CacheUnReady="$cache-unready",e.CacheBuffer="$cache-buffer",e.Verify="$verify",e.Check="$check"}(v||(v={}));var w=v,P=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));class O{constructor(){this.types=w,this.EventType=p,this.ProfileType=l,this.UtmType=d,this.SdkHook=w,this.Domains=u,this.inited=!1,this.sended=!1,this.pluginInstances=[],this.data={},this.unInitedCache=[],this.ready=!1,this.sessionId="",this.appShowStarted=!1,this.env=new m(this),this.option=new y,this.hook=new b,this.sessionId=P(),O.instances.push(this);try{this.adapter=new k(this),this.adapter.setLog(O._log),this.adapter.setRequest(O._request),this.adapter.setStorage(O._storage),this.adapter.check(),O.plugins.reduce(((e,t)=>{const{plugin:s}=t;return e.push(new s),e}),this.pluginInstances)}catch(e){}}on(e,t){var s;null===(s=this.hook)||void 0===s?void 0:s.on(e,t)}once(e,t){var s;null===(s=this.hook)||void 0===s?void 0:s.once(e,t)}off(e,t){var s;if(!t&&this.types[e])return;null===(s=this.hook)||void 0===s?void 0:s.off(e,t)}emit(e,t){var s;this.adapter.log(`emit ${e}`,t||""),null===(s=this.hook)||void 0===s||s.emit(e,t)}static useAdapterLog(e){O._log=e}static useAdapterRequest(e){O._request=e}static useAdapterStorage(e){O._storage=e}static usePlugin(e,t){const s=t||e.pluginName;if(s){let t=!1;for(let i=0,r=O.plugins.length;i<r;i++){if(O.plugins[i].name===s){O.plugins[i].plugin=e,t=!0;break}}t||O.plugins.push({name:s,plugin:e})}else O.plugins.push({plugin:e});if("function"==typeof e.init)try{e.init(O)}catch(e){}}get appId(){return this._appId}checkUsePlugin(e){return!!O.plugins.find((({name:t})=>t===e))}init(e){if(this.inited||!this.isObject(e))return;const{app_id:t,log:s}=e,i=h(e,["app_id","log"]);if(void 0!==s&&this.option.set({log:s}),!(_(t)&&t>0))return this.adapter.log("app_id invalid"),void 0;this._appId=t,this.option.set(i),this.env.set({app_id:t}),Promise.all([new Promise((e=>{this.once(this.types.TokenComplete,(()=>{e(!0)}))})),new Promise((e=>{this.checkUsePlugin("official:auto")?this.on(this.types.LaunchComplete,(()=>{e(!0)})):e(!0)})),new Promise((e=>{this.sended?e(!0):this.once(this.types.Send,(()=>{e(!0)}))}))]).then((()=>{this.ready=!0,this.emit(this.types.Ready)})),this.on(this.types.AppShowStart,(()=>{this.appShowStarted?this.sessionId=P():this.appShowStarted=!0})),this.on(this.types.UuidChangeAfter,(()=>{this.sessionId=P()}));const r=this.option.get();if(this.pluginInstances.forEach((e=>{e.apply(this,r)})),this.get("is-crawler"))return;this.inited=!0,this.emit(this.types.Init),this.unInitedCache.length>0&&this.unInitedCache.forEach((e=>{this.emit(this.types.Event,e)}))}config(e){if(!this.inited||!this.isObject(e))return;this.emit(this.types.Config,e),this.emit(this.types.ConfigTransform,e);const{web_id:t,user_unique_id:s}=e,i=h(e,["web_id","user_unique_id"]);void 0!==t&&this.emit(this.types.ConfigWebId,t),void 0!==s&&this.emit(this.types.ConfigUuid,s),this.emit(this.types.Check,{type:"config",value:i}),this.env.set(i)}send(){if(!this.inited||this.sended)return;this.sended=!0,this.emit(this.types.Send)}event(e,t){if(this.get("is-crawler"))return;if(Array.isArray(e)){const t=f(),s=[];e.forEach((e=>{let i,r,n;if(Array.isArray(e)?[i,r,n]=e:this.isObject(e)&&(i=e.event,r=e.params,n=e.local_time_ms),!i)return;(!_(n)||n<0||n>t)&&(n=t),s.push(this.createEvent({event:i,params:r,time:n}))})),s.length>0&&(this.inited?this.emit(this.types.Event,s):this.unInitedCache.push(s))}else{const s=this.createEvent({event:e,params:t});this.inited?this.emit(this.types.Event,s):this.unInitedCache.push(s),this.emit(this.types.Verify,{event:e,params:t})}}createEvent(e,t=!0){const s=Object.assign({event:e.event,params:e.params||{},local_time_ms:e.time||f()},this.sessionId?{session_id:this.sessionId}:{});if(this.emit(this.types.Check,{type:"event",value:s}),!t)return s;let i="";const r=this.get("ab_sdk_version");r&&(i+=r);const n=this.get("ab_sdk_version_external");return n&&(i?i+=","+n:i=n),Object.assign(Object.assign({},s),i?{ab_sdk_version:i}:{})}set(e,t){this.data[e]=t}get(e){return this.data[e]}getKey(e){const t=this.appId;if("ab_version"===e||"ab_version_external"===e)return`__tea_sdk_${e}_${t}`;const s={token:"tokens",report:"reports",event:"events",utm:"utm",first:"first",compensate:"compensate",buffer:"buffer"};return s[e]?`__tea_cache_${s[e]}_${t}`:void 0}getUrl(e){const{option:t,env:s}=this,i=s.get("_sdk_version"),r=(s.get("_sdk_name")||"").replace(/@.+\//,""),n=`${t.get("domain")}${e}?sdk_version=${i}&sdk_name=${r}`,o=t.get("caller");if(o)return`${n}&app_id=${this.appId}&caller=${o}`;return n}getToken(e){if(e)return this.emit(this.types.TokenGet,{callback:e}),void 0;return new Promise((e=>{this.emit(this.types.TokenGet,{callback:t=>{e(t)}})}))}getConfig(e){return this.env.get(e||"header")}stash(e,t={}){const s="stash";this.set(s,[...this.get(s)||[],this.createEvent({event:e,params:t})])}commit(){const e="stash",t=this.get(e)||[];t.length>0&&(this.event(t),this.set(e,[]))}isObject(e){return g(e)}isArray(e){return(e=>"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e))(e)}isNumber(e){return _(e)}isString(e){return(e=>"string"==typeof e)(e)}isFunction(e){return(e=>"function"==typeof e)(e)}isUndefined(e){return void 0===e}}O.plugins=[],O.instances=[];class C{apply(e,t){e.env.set({sdk_version:"2.1.1",_sdk_version:"2.1.1",_sdk_name:"@datarangers/sdk-qg"})}}var S;C.pluginName="official:info",function(e){e.Default="default",e.Custom="custom"}(S||(S={}));class q{constructor(e,t){this.wrap=e,this.sdk=t,this.url="/webid/"}storageNoData(){this.fetch()}storageHasData(e){return this.wrap.dataComplete(e)}fetch(){const{adapter:e,appId:t}=this.sdk;e.request({url:this.sdk.getUrl(`${this.url}`),method:"POST",data:{app_id:t,url:"-",user_agent:"-",referer:"-",user_unique_id:""}}).then((t=>{try{const{data:{e:s=-1e4,web_id:i=""}={}}=t;if(0===s)return this.fetchComplete(i),void 0;e.log("parse web_id error",s)}catch(t){e.log("parse web_id error",t)}this.fetchComplete()})).catch((t=>{this.fetchComplete(),e.log("fetch web_id error",t)}))}fetchComplete(e){if(!e)return;this.wrap.webIdComplete(e)}storageComplete(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===S.Default){const t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}class ${constructor(e,t){this.wrap=e,this.sdk=t,this.sdk.on(this.sdk.types.ConfigWebId,(e=>{e=`${e}`,this.wrap.tokenComplete?this.waitComplete(e):this.waitResolve?this.waitResolve(e):this.tmpWebId=e}))}storageNoData(){this.wait()}storageHasData(e){return this.wrap.dataComplete(e,this.tmpWebId)}wait(){new Promise((e=>{void 0!==this.tmpWebId?(e(this.tmpWebId),this.tmpWebId=void 0):this.waitResolve=e})).then((e=>{this.waitComplete(e)}))}waitComplete(e){this.wrap.webIdComplete(e)}storageComplete(e){if(!e)return this.storageNoData(),void 0;try{if(e[this.wrap.typeKey]===S.Custom){const t=this.storageHasData(e);this.wrap.complete(t)}else this.storageNoData()}catch(e){}}}class I{constructor(){this.tokenComplete=!1,this.tobid="",this.tobidUrl="/tobid/",this.tobidKey="",this.isCustom=!1,this.typeKey="_type_"}apply(e,t){this.sdk=e,this.options=t,this.key=this.sdk.getKey("token"),this.tobidKey="diss".split("").reverse().join(""),this.options.enable_custom_webid?(this.isCustom=!0,this.token=new $(this,this.sdk)):(this.isCustom=!1,this.token=new q(this,this.sdk));const{types:s}=this.sdk;this.sdk.on(s.ConfigUuid,(e=>{this.setUserUniqueId(e)})),this.sdk.on(s.TokenGet,(({callback:e})=>{const t=()=>{this.fetchTobid().then((()=>{const t=this.sdk.env.get("user"),s=Object.assign(Object.assign({},t),{web_id:this.webId,user_unique_id:this.userUniqueId});s[this.tobidKey]=this.tobid,"function"==typeof e&&e(s)}))};this.sdk.ready?t():this.sdk.once(s.Ready,(()=>{t()}))})),this.storage()}storage(){const{adapter:e}=this.sdk;e.get(this.key).then((t=>{if(!this.sdk.isObject(t)||!t.web_id)return this.storageComplete(null),void 0;t[this.typeKey]&&!t[this.tobidKey]&&t.user_unique_id||(t={web_id:t.web_id,user_unique_id:t.user_unique_id||t.web_id,[this.typeKey]:this.isCustom?S.Custom:S.Default},e.set(this.key,t)),this.storageComplete(t)})).catch((t=>{this.storageComplete(null),e.log("get token error",t)}))}storageComplete(e){this.token.storageComplete(e)}dataComplete(e,t){let s=e.web_id;void 0!==t&&t!==s&&(s=t),this.webId=s;let i=e.web_id===e.user_unique_id?s:e.user_unique_id;return void 0!==this.tmpUserUniqueId&&this.tmpUserUniqueId!==i&&(i=this.tmpUserUniqueId?this.tmpUserUniqueId:s,this.tmpUserUniqueId=void 0),this.userUniqueId=i,s!==e.web_id||i!==e.user_unique_id}webIdComplete(e){this.webId=e,this.tmpUserUniqueId?(this.userUniqueId=this.tmpUserUniqueId,this.tmpUserUniqueId=void 0):this.userUniqueId=e,this.complete(!0)}complete(e=!1){const{types:t}=this.sdk,s={web_id:this.webId,user_unique_id:this.userUniqueId};this.sdk.env.set(s),s[this.typeKey]=this.isCustom?S.Custom:S.Default,e&&this.sdk.adapter.set(this.key,s),this.tokenComplete=!0,this.sdk.emit(t.TokenComplete)}setUserUniqueId(e){const{adapter:t,env:s,types:i}=this.sdk;if(this.tokenComplete){if(this.userUniqueId===e)return;this.sdk.emit(i.UuidChangeBefore),this.userUniqueId=e||this.webId,s.set({user_unique_id:this.userUniqueId});const r={web_id:this.webId,user_unique_id:this.userUniqueId,[this.typeKey]:this.isCustom?S.Custom:S.Default};t.set(this.key,r),this.sdk.emit(i.UuidChangeAfter)}else this.tmpUserUniqueId=e}fetchTobid(){const{adapter:e,appId:t}=this.sdk;return e.request({url:this.sdk.getUrl(`${this.tobidUrl}`),method:"POST",data:{app_id:t,web_id:this.webId,user_unique_id:this.userUniqueId}}).then((e=>{try{const{data:{e:t=-1e4,tobid:s=""}={}}=e;if(0===t)return this.tobid=s,void 0}catch(e){}})).catch((t=>{e.log("fetch tobid error",t)}))}}I.pluginName="official:token";class x{constructor(){this.url="/list/",this.cache=[],this.pause=!1,this.eventName="request_status__"}apply(e,t){this.sdk=e,this.options=t,this.key=this.sdk.getKey("report"),this.reportUrl=this.sdk.getUrl(`${this.url}`),this.sdk.set("report_url",this.reportUrl);const{types:s}=this.sdk;this.sdk.on(s.Report,(e=>{if(Array.isArray(e)||(e=[e]),!this.sdk.ready||this.pause)return e.forEach((e=>this.cache.push(e))),void 0;this.report(e)})),this.sdk.on(s.Ready,(()=>{this.reportCache()})),this.sdk.on(s.Pause,(()=>{this.pause=!0})),this.sdk.on(s.CancelPause,(()=>{this.pause=!1,this.reportCache()}));const{adapter:i}=this.sdk;this.sdk.on(s.AppOpen,(()=>{i.get(this.key).then((()=>{}))})),this.sdk.on(s.AppClose,(()=>{this.cache.length>0&&(i.set(this.key,[...this.cache]),this.cache.length=0)}))}reportCache(){this.cache.length>0&&(this.report([...this.cache]),this.cache.length=0)}report(e){this.submit(e)}submit(e){const{types:t}=this.sdk;this.sdk.emit(t.SubmitBefore,e),this.sdk.adapter.request({url:this.reportUrl,method:"POST",data:e}).then((s=>{this.sdk.emit(t.SubmitAfter,{isError:!1,response:s,event:e});try{if(this.checkMonitor(e))return;const{data:t,statusCode:i}=s;if(0!==t.e){const s=e.map((e=>null==e?void 0:e.events));this.reportMonitor({status_code:i,response_data:JSON.stringify(t),event_info:JSON.stringify(s)})}}catch(e){}})).catch((s=>{this.sdk.emit(t.SubmitAfter,{isError:!0,error:s,event:e});try{if(this.checkMonitor(e))return;this.sdk.emit(t.SubmitError,{event:e})}catch(e){}}))}reportMonitor(e){const t=this.sdk.createEvent({event:this.eventName,params:e}),s=this.sdk.env.merge([t]);this.submit(s)}checkMonitor(e){if(e&&e[0]&&e[0].events[0]&&e[0].events[0].event===this.eventName)return!0;return!1}}x.pluginName="official:report";class A{constructor(){this.buffer=[],this.timer=0,this.unReadyCache=[],this.cacheBatchNumber=15}apply(e,t){var s,i;this.sdk=e,this.options=t,this.enable=!!this.options.enable_buffer,this.cacheEnable=!!this.options.enable_cache;const r=!0===this.options.enable_storage||!1===this.options.disable_storage;if(r&&(this.enable=!0),this.enable){this.interval=this.options.buffer_interval,this.number=this.options.buffer_number,r&&((null===(s=this.options)||void 0===s?void 0:s.report_interval)>0&&(this.interval=this.options.report_interval),(null===(i=this.options)||void 0===i?void 0:i.max_batch_event)>0&&(this.number=this.options.max_batch_event));try{this.interval=Number(this.interval),this.number=Number(this.number)}catch(e){}}const{types:n}=this.sdk;this.sdk.on(n.Event,(e=>{const t=Array.isArray(e)?e:[e];if(!this.sdk.ready)return this.unReadyCache=[...this.unReadyCache,...t],this.cacheEnable&&this.unReadyCache.length>=this.cacheBatchNumber&&(this.sdk.emit(n.CacheUnReady,[...this.unReadyCache]),this.unReadyCache.length=0),void 0;this.process(t)})),this.sdk.on(n.Ready,(()=>{this.unReadyCache.length>0&&(this.process(this.unReadyCache),this.unReadyCache.length=0)})),this.sdk.on(n.Network,(e=>{!e.origin&&e.current&&(this.enable?this.refresh():this.buffer.length>0&&(this.report([...this.buffer]),this.buffer.length=0))})),this.sdk.on(n.AppClose,(()=>{if(this.timer&&clearTimeout(this.timer),!this.sdk.ready)return this.cacheEnable&&this.unReadyCache.length>0&&(this.sdk.emit(n.CacheUnReady,[...this.unReadyCache]),this.unReadyCache.length=0),void 0;if(this.buffer.length>0){this.network()?this.report([...this.buffer]):this.cacheEnable&&this.sdk.emit(n.CacheBuffer,[...this.buffer]),this.buffer.length=0}}))}process(e){const t=this.sdk.env.compose(e);this.network()?this.enable?(this.buffer=[...this.buffer,t],this.refresh()):this.report(t):(this.buffer=[...this.buffer,t],this.cacheEnable&&this.buffer.length>=this.cacheBatchNumber&&(this.sdk.emit(this.sdk.types.CacheBuffer,[...this.buffer]),this.buffer.length=0))}refresh(){this.buffer.length>=this.number?(this.timer&&(clearTimeout(this.timer),this.timer=0),this.report([...this.buffer]),this.buffer.length=0):this.timer||(this.timer=setTimeout((()=>{this.timer=0,this.buffer.length>0&&(this.report([...this.buffer]),this.buffer.length=0)}),this.interval))}report(e){this.sdk.emit(this.sdk.types.Report,e)}network(){return!!this.sdk.env.get("is_connected")}}A.pluginName="official:buffer";class j{apply(e,t){this.sdk=e,this.options=t;const{types:s,env:i}=this.sdk,r=(()=>{try{const e=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(e)/60),offset:60*e}}catch(e){return{timezone:8,offset:-28800}}})();i.set({timezone:r.timezone,tz_offset:r.offset}),this.sdk.on(s.ConfigTransform,(e=>{void 0!==e.user_unique_id_type&&(e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),{$user_unique_id_type:e.user_unique_id_type})),void 0!==e.gender&&([1,2,"1","2"].includes(e.gender)?e.gender=e.gender<2?"male":"female":delete e.gender);if(!!this.options.enable_profile){const t={};["nick_name","gender","avatar_url"].forEach((s=>{void 0!==e[s]&&(t[s]=e[s],delete e[s])})),this.sdk.emit(s.ProfileSet,t)}})),this.sdk.on(s.EnvTransform,(e=>{if(!!this.options.enable_profile){const t={};["$mp_from_uuid"].forEach((s=>{void 0!==e[s]&&(t[s]=e[s],delete e[s])})),Object.keys(t).length>0&&this.sdk.emit(s.ProfileSetOnce,t)}}))}}j.pluginName="official:transform";class U{constructor(){this.url="/profile/list",this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[]}static init(e){e.prototype.profileSet=function(e){this.emit(this.types.ProfileSet,e)},e.prototype.profileSetOnce=function(e){this.emit(this.types.ProfileSetOnce,e)},e.prototype.profileUnset=function(e){this.emit(this.types.ProfileUnset,e)},e.prototype.profileIncrement=function(e){this.emit(this.types.ProfileIncrement,e)},e.prototype.profileAppend=function(e){this.emit(this.types.ProfileAppend,e)}}apply(e,t){this.sdk=e,this.options=t;const{types:s}=this.sdk;this.sdk.on(s.ProfileSet,(e=>{this.check()&&this.setProfile(e)})),this.sdk.on(s.ProfileSetOnce,(e=>{this.check()&&this.setOnceProfile(e)})),this.sdk.on(s.ProfileUnset,(e=>{this.check()&&this.unsetProfile(e)})),this.sdk.on(s.ProfileIncrement,(e=>{this.check()&&this.incrementProfile(e)})),this.sdk.on(s.ProfileAppend,(e=>{this.check()&&this.appendProfile(e)})),this.sdk.on(s.ProfileClear,(()=>{this.cache={}})),this.sdk.on(s.Ready,(()=>{if(!this.buffer.length)return;this.reportMore([...this.buffer]),this.buffer=[]}))}check(){return!!this.options.enable_profile}setProfile(e){const t=this.debounce(e);if(!t)return;this.putCache(t);const s=this.filter(t,(e=>this.sdk.isString(e)||this.sdk.isNumber(e)||this.sdk.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_set",params:s}))}setOnceProfile(e){const t=this.debounce(e,!0);if(!t)return;this.putCache(t);const s=this.filter(t,(e=>this.sdk.isString(e)||this.sdk.isNumber(e)||this.sdk.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_set_once",params:s}))}incrementProfile(e){if(!e)return;const t=this.filter(e,(e=>this.sdk.isNumber(e)));this.report(this.sdk.createEvent({event:"__profile_increment",params:t}))}unsetProfile(e){if(!e||!this.sdk.isString(e))return;const t={};t[e]="1",this.report(this.sdk.createEvent({event:"__profile_unset",params:t}))}appendProfile(e){if(!e||!this.sdk.isObject(e)||this.isEmpty(e))return;const t=this.filter(e,(e=>this.sdk.isString(e)||this.sdk.isArray(e)));this.report(this.sdk.createEvent({event:"__profile_append",params:t}))}reportMore(e){if(this.sdk.ready){const t=this.sdk.env.merge(e,this.sdk.ProfileType),{adapter:s,option:i}=this.sdk;s.request({url:`${i.get("domain")}${this.url}`,method:"POST",data:t}).then((e=>{this.sdk.emit(this.sdk.types.ProfileSubmitAfter,{isError:!0,response:e,event:t})})).catch((e=>{this.sdk.emit(this.sdk.types.ProfileSubmitError,{isError:!0,error:e,event:t})}))}else e.forEach((e=>{this.buffer.push(e)}))}report(e){this.reportMore([e])}ms(){return f()}debounce(e,t=!1){if(!e||!this.sdk.isObject(e)||this.isEmpty(e))return;let s=Object.keys(e);const i=this.ms(),r=s.filter((s=>{const r=this.cache[s];if(r&&(t||this.compare(r.val,e[s])&&i-r.timestamp<this.duration))return!1;return!0})).reduce(((t,s)=>(t[s]=e[s],t)),{});if(s=Object.keys(r),!s.length)return;return r}putCache(e){const t=this.ms();Object.keys(e).forEach((s=>{this.cache[s]={val:this.clone(e[s]),timestamp:t}}))}clone(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}compare(e,t){return JSON.stringify(e)===JSON.stringify(t)}filter(e,t){return Object.keys(e).reduce(((s,i)=>{const r=e[i];return t(r)&&(s[i]=r),s}),{})}isEmpty(e){return!Object.keys(e).length}}U.pluginName="official:profile",O.usePlugin(C),O.usePlugin(I),O.usePlugin(x),O.usePlugin(A),O.usePlugin(j),O.usePlugin(U);var E=console;let N="undefined";const T=()=>{if("undefined"!==N)return N;return N="undefined"!=typeof tt?{target:tt,is:"tt"}:"undefined"!=typeof swan?{target:swan,is:"swan"}:"undefined"!=typeof qq?{target:qq,is:"qq"}:"undefined"!=typeof wx?{target:wx,is:"wx"}:"undefined"!=typeof qg?{target:qg,is:"qg"}:{target:null,is:""},N};let R="";const D=T();var M="undefined"!=typeof qg||"undefined"!=typeof cc?"undefined"!=typeof qg&&qg.request?e=>t=>{R||(R=qg.getSystemInfoSync().brand);const s=t.timeout||e.option.get("request_timeout"),i="number"==typeof s&&s>0;return new Promise(((e,r)=>{qg.request(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},t),i?{timeout:s}:{}),{dataType:t.dataType||"json"}),"vivo"===R?{data:JSON.stringify(t.data)}:{}),{success:t=>{e(t)},fail:e=>{r(e)}}))}))}:e=>t=>{const s=t.timeout||e.option.get("request_timeout"),i="number"==typeof s&&s>0;return new Promise(((e,s)=>{const{url:r,method:n,timeout:o,data:a}=t,h=new XMLHttpRequest;i&&(h.timeout=o),h.open(n,`${r}`,!0),h.setRequestHeader("Content-Type","application/json; charset=utf-8"),h.onload=()=>{try{const t=JSON.parse(h.responseText);e({data:t})}catch(e){s()}},h.ontimeout=()=>{s()},h.onerror=()=>{h.abort(),s()},h.send(JSON.stringify(a))}))}:((e,t=!1)=>s=>i=>{const r=i.timeout||s.option.get("request_timeout"),n="number"==typeof r&&r>0;return new Promise(((s,o)=>{const a=e.request(Object.assign(Object.assign(Object.assign({},i),n&&!t?{timeout:r}:{}),{dataType:i.dataType||"json",success:e=>{s(e)},fail:e=>{o(e)}}));n&&t&&setTimeout((()=>{try{a&&a.abort()}catch(e){}}),r)}))})(D.target,"swan"===D.is);const J=T(),K=e=>class{get(t){return new Promise(((s,i)=>{try{const i=e.getItem(t);s(i?JSON.parse(i):null)}catch(e){i(e)}}))}set(t,s){return new Promise(((i,r)=>{try{e.setItem(t,JSON.stringify(s)),i(!0)}catch(e){r(!1)}}))}remove(t){return new Promise(((s,i)=>{try{e.removeItem(t),s(!0)}catch(e){i(!1)}}))}info(){return new Promise(((t,s)=>{try{const s=[];for(let t=0,i=e.length;t<i;t++)s.push(e.key(t));t(s)}catch(e){s(null)}}))}};var H=new((()=>{if("undefined"!=typeof qg||"undefined"!=typeof cc){if("undefined"!=typeof qg&&qg.getStorageSync)return class{get(e){return new Promise(((t,s)=>{try{const s=qg.getStorageSync({key:e});if(void 0===s||"object"==typeof s)return t(s),void 0;if("string"==typeof s)return"key not define"===s.trim()?t(null):t(JSON.parse(s)),void 0;t(s)}catch(e){s(e)}}))}set(e,t){return new Promise(((s,i)=>{try{qg.setStorageSync({key:e,value:JSON.stringify(t)}),s(!0)}catch(e){i(!1)}}))}remove(e){return new Promise(((t,s)=>{try{qg.removeStorageSync({key:e}),t(!0)}catch(e){s(!1)}}))}info(){return new Promise(((e,t)=>{try{qg.getStorageInfo({success(t){e(t)},fail(){t(null)}})}catch(e){t(null)}}))}};if(void 0!==cc&&void 0!==cc.sys)return K(cc.sys.localStorage);return K(localStorage)}return class{get(e){return new Promise(((t,s)=>{try{t(J.target.getStorageSync(e))}catch(e){s(e)}}))}set(e,t){return new Promise(((s,i)=>{try{J.target.setStorageSync(e,t),s(!0)}catch(e){i(!1)}}))}remove(e){return new Promise(((t,s)=>{try{J.target.removeStorageSync(e),t(!0)}catch(e){s(!1)}}))}info(){return new Promise(((e,t)=>{try{J.target.getStorageInfo({success(t){e(t)},fail(){t(null)}})}catch(e){t(null)}}))}}})());class F{constructor(){this.timer=0}apply(e,t){this.sdk=e,this.options=t,this.boost();const{types:s}=this.sdk;this.getInfo(),this.sdk.on(s.AppOpen,(()=>{this.getInfo(),this.onChange()}))}boost(){}getInfo(){const{target:e}=this.sdk;e&&(this.system(e),this.network(e))}system(e){const t=this,{env:s}=this.sdk;e.getSystemInfo&&e.getSystemInfo({success(e){const i=Math.ceil(e.screenWidth),r=Math.ceil(e.screenHeight),n={device_brand:e.brand,device_model:e.model,os_version:e.system,os_name:e.platform,platform:e.platform,resolution:`${i}x${r}`,screen_width:i,screen_height:r};t.overlap(e,n),s.set(n)}})}network(e){const t=this,{env:s,types:i}=this.sdk;e.getNetworkType&&e.getNetworkType({success(e){const r={access:e.networkType,is_connected:void 0!==e.networkAvailable?!!e.networkAvailable:"none"!==e.networkType};t.sdk.emit(i.Network,{origin:s.get("is_connected"),current:r.is_connected}),s.set(r)},fail(){if(t.timer>0)return;t.timer=setTimeout((()=>{t.network(e)}),50)}})}onChange(){const{target:e,env:t,types:s}=this.sdk;null==e?void 0:e.onNetworkStatusChange((e=>{this.sdk.emit(s.Network,{origin:t.get("is_connected"),current:null==e?void 0:e.isConnected}),t.set({access:null==e?void 0:e.networkType,is_connected:null==e?void 0:e.isConnected})}))}overlap(e,t){t.language=e.language,t.mp_platform_app_version=e.version,t.mp_platform_basic_version=e.SDKVersion}}F.pluginName="official:device";class B extends F{boost(){super.boost(),this.sdk.env.set(Object.assign({sdk_lib:"qg_common",custom_platform:"quickGame",mp_platform:4},"undefined"!=typeof qg||"undefined"!=typeof cc?{is_connected:!0}:{}))}overlap(e,t){super.overlap(e,t),t.os_version=e.system||e.osVersionName,t.os_name=e.platform||e.platformVersionName}}O.useAdapterLog(E),O.useAdapterRequest(M),O.useAdapterStorage(H),O.usePlugin(class extends B{static init(e){const t=T();e.platform=t.is?t.target:null}boost(){super.boost(),this.which=T(),this.sdk.target=this.which.target,this.sdk.whichIs=this.which.is}}),O.usePlugin(e),O.usePlugin(t),O.usePlugin(s),O.usePlugin(i),O.usePlugin(r),O.usePlugin(n),O.usePlugin(o),O.usePlugin(a);export{O as default};
