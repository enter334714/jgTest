class t{constructor(){this.key="start_rangers_data_check",this.buffer=[],this.test=!1,this.testRequestNumber=0,this.interval=1e3,this.needOn=!1,this.onHandler=()=>{}}apply(t,s){this.sdk=t,this.options=s;const{types:e}=this.sdk;this.sdk.once(e.AppOpen,(()=>{try{if(this.host=this.sdk.target,this.host.getLaunchOptionsSync){const t=this.host.getLaunchOptionsSync(),{query:s}=t;this.verify(s).then((()=>{this.needOn=!0,this.onHandler=t=>{this.submit(t)},this.sdk.on(e.Event,this.onHandler)}))}}catch(t){}})),this.sdk.on(e.AppClose,(()=>{this.needOn&&(this.userInfo=null,this.sdk.off(e.Event,this.onHandler),this.onHandler=()=>{},this.needOn=!1)}))}check(t){var s;return null!==(s=null==t?void 0:t[this.key])&&void 0!==s?s:""}verify(t){const{adapter:s}=this.sdk;let e;const i=new Promise((t=>{e=t})),r=t=>{e(!0),this.userInfo=t||{nickName:"未知",avatarUrl:""},s.log(`verify open ${JSON.stringify(this.userInfo)}`),this.login()},n=this.check(t);s.log(`verify ${n}`);const o=this;if(n){try{const t=(t=>{const s=s=>{return(e=t,e.split("").map((t=>t.charCodeAt(0)))).reduce(((t,s)=>t^s),s);var e};return t=>t.match(/.{1,2}/g).map((t=>parseInt(t,16))).map(s).map((t=>String.fromCharCode(t))).join("")})("logverify")(n);t&&/^https?:\/\//.test(t)&&(this.domain=t),s.log(`verify domain ${t}`)}catch(t){}o.host.getSetting({success(t){s.log("getSetting success"),t.authSetting["scope.userInfo"]?(s.log("getSetting scope.userInfo success"),o.host.getUserInfo?o.host.getUserInfo({success(t){s.log("getUserInfo success");const{nickName:e,avatarUrl:i}=t.userInfo;r({nickName:e,avatarUrl:i})},fail(){s.log("getUserInfo fail"),r()}}):o.host.getOpenUserInfo&&o.host.getOpenUserInfo({success(t){s.log("getUserInfo success");try{const s=JSON.parse(t.response).response,{nickName:e,avatar:i}=s;r({nickName:e,avatarUrl:i})}catch(t){}},fail(){s.log("getUserInfo fail"),r()}})):(s.log("getSetting scope.userInfo fail"),r())},fail(){s.log("getSetting fail"),r()}})}return i}submit(t){try{this.pushBuffer(JSON.parse(JSON.stringify(t)))}catch(t){}}login(){if(!this.domain)return;const{header:t}=this.prepareHeader();this.sdk.adapter.request({url:`${this.domain}/simulator/limited_mobile/try_link`,method:"POST",data:Object.assign(Object.assign({header:Object.assign(Object.assign({},t||{}),{aid:t.app_id})},this.userInfo?{nick_name:this.userInfo.nickName}:{}),{host_version:(t.custom||{}).mp_platform_app_version||"",sync_id:this.syncId||""})}).then((t=>{try{const{data:{data:{retry:s,sync_id:e,token:i}}}=t;if(this.syncId=e,this.token=i,this.test&&this.testRequestNumber>3)return this.report(),void 0;0===s||(1===s?this.loginLoop():2===s&&this.report())}catch(t){this.loginLoop()}})).catch((()=>{this.loginLoop()}))}loginLoop(){this.test&&this.testRequestNumber++,setTimeout((()=>{this.login()}),this.interval)}report(){if(!this.domain)return;const{header:t}=this.prepareHeader(),s=this.buffer;this.buffer=[],this.sdk.adapter.request({url:`${this.domain}/simulator/limited_mobile/log`,method:"POST",data:{header:Object.assign(Object.assign({},t||{}),{aid:t.app_id}),token:this.token||"",event_v3:s||[]}}).then((t=>{try{const{data:{data:{keep:s}}}=t;!0===s?this.reportLoop():this.reset()}catch(t){this.reportLoop()}})).catch((()=>{this.reportLoop()}))}reportLoop(){setTimeout((()=>{this.report()}),this.interval)}pushBuffer(t){(Array.isArray(t)?[...t]:[t]).forEach((t=>{if("string"==typeof t.params)try{t.params=JSON.parse(t.params)}catch(t){}this.buffer.push(t)}))}prepareHeader(){const{env:t}=this.sdk,{user:s,header:e}=t.get();return JSON.parse(JSON.stringify({user:s,header:e}))}reset(){this.buffer=[],this.syncId="",this.token=""}}t.pluginName="official:verify";export{t as default};
