!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).$$LOGSDK_PLUGIN_VERIFY=e()}(this,(function(){"use strict";function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function e(t){return function(t){if(Array.isArray(t))return n(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return n(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var r=function(){function n(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.key="start_rangers_data_check",this.buffer=[],this.test=!1,this.testRequestNumber=0,this.interval=1e3,this.needOn=!1,this.onHandler=function(){}}var r,i,o;return r=n,(i=[{key:"apply",value:function(t,e){var n=this;this.sdk=t,this.options=e;var r=this.sdk.types;this.sdk.once(r.AppOpen,(function(){try{if(n.host=n.sdk.target,n.host.getLaunchOptionsSync){var t=n.host.getLaunchOptionsSync().query;n.verify(t).then((function(){n.needOn=!0,n.onHandler=function(t){n.submit(t)},n.sdk.on(r.Event,n.onHandler)}))}}catch(t){}})),this.sdk.on(r.AppClose,(function(){n.needOn&&(n.userInfo=null,n.sdk.off(r.Event,n.onHandler),n.onHandler=function(){},n.needOn=!1)}))}},{key:"check",value:function(t){var e;return null!==(e=null==t?void 0:t[this.key])&&void 0!==e?e:""}},{key:"verify",value:function(t){var e,n=this,r=this.sdk.adapter,i=new Promise((function(t){e=t})),o=function(t){e(!0),n.userInfo=t||{nickName:"未知",avatarUrl:""},r.log("verify open ".concat(JSON.stringify(n.userInfo))),n.login()},a=this.check(t);r.log("verify ".concat(a));var s,u,c=this;if(a){try{var f=(s="logverify",u=function(t){return(e=s,e.split("").map((function(t){return t.charCodeAt(0)}))).reduce((function(t,e){return t^e}),t);var e},function(t){return t.match(/.{1,2}/g).map((function(t){return parseInt(t,16)})).map(u).map((function(t){return String.fromCharCode(t)})).join("")})(a);f&&/^https?:\/\//.test(f)&&(this.domain=f),r.log("verify domain ".concat(f))}catch(t){}c.host.getSetting({success:function(t){r.log("getSetting success"),t.authSetting["scope.userInfo"]?(r.log("getSetting scope.userInfo success"),c.host.getUserInfo?c.host.getUserInfo({success:function(t){r.log("getUserInfo success");var e=t.userInfo,n=e.nickName,i=e.avatarUrl;o({nickName:n,avatarUrl:i})},fail:function(){r.log("getUserInfo fail"),o()}}):c.host.getOpenUserInfo&&c.host.getOpenUserInfo({success:function(t){r.log("getUserInfo success");try{var e=JSON.parse(t.response).response,n=e.nickName,i=e.avatar;o({nickName:n,avatarUrl:i})}catch(t){}},fail:function(){r.log("getUserInfo fail"),o()}})):(r.log("getSetting scope.userInfo fail"),o())},fail:function(){r.log("getSetting fail"),o()}})}return i}},{key:"submit",value:function(t){try{this.pushBuffer(JSON.parse(JSON.stringify(t)))}catch(t){}}},{key:"login",value:function(){var t=this;if(!this.domain)return;var e=this.prepareHeader().header;this.sdk.adapter.request({url:"".concat(this.domain,"/simulator/limited_mobile/try_link"),method:"POST",data:Object.assign(Object.assign({header:Object.assign(Object.assign({},e||{}),{aid:e.app_id})},this.userInfo?{nick_name:this.userInfo.nickName}:{}),{host_version:(e.custom||{}).mp_platform_app_version||"",sync_id:this.syncId||""})}).then((function(e){try{var n=e.data.data,r=n.retry,i=n.sync_id,o=n.token;if(t.syncId=i,t.token=o,t.test&&t.testRequestNumber>3)return t.report(),void 0;0===r||(1===r?t.loginLoop():2===r&&t.report())}catch(e){t.loginLoop()}})).catch((function(){t.loginLoop()}))}},{key:"loginLoop",value:function(){var t=this;this.test&&this.testRequestNumber++,setTimeout((function(){t.login()}),this.interval)}},{key:"report",value:function(){var t=this;if(!this.domain)return;var e=this.prepareHeader().header,n=this.buffer;this.buffer=[],this.sdk.adapter.request({url:"".concat(this.domain,"/simulator/limited_mobile/log"),method:"POST",data:{header:Object.assign(Object.assign({},e||{}),{aid:e.app_id}),token:this.token||"",event_v3:n||[]}}).then((function(e){try{!0===e.data.data.keep?t.reportLoop():t.reset()}catch(e){t.reportLoop()}})).catch((function(){t.reportLoop()}))}},{key:"reportLoop",value:function(){var t=this;setTimeout((function(){t.report()}),this.interval)}},{key:"pushBuffer",value:function(t){var n=this;(Array.isArray(t)?e(t):[t]).forEach((function(t){if("string"==typeof t.params)try{t.params=JSON.parse(t.params)}catch(t){}n.buffer.push(t)}))}},{key:"prepareHeader",value:function(){var t=this.sdk.env.get(),e=t.user,n=t.header;return JSON.parse(JSON.stringify({user:e,header:n}))}},{key:"reset",value:function(){this.buffer=[],this.syncId="",this.token=""}}])&&t(r.prototype,i),o&&t(r,o),r,n}();return r.pluginName="official:verify",r}));
