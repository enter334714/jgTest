const t=()=>+new Date,e=t=>{let e=t;try{e=decodeURIComponent(t)}catch(t){}return e};var s;!function(t){t[t.Undefined=0]="Undefined",t[t.Start=1]="Start",t[t.End=2]="End"}(s||(s={}));class i{constructor(){this.key="utm",this.utmed=s.Undefined,this.reload=!1}apply(t,e){this.sdk=t,this.options=e;const{types:i}=this.sdk;this.sdk.on(i.LaunchInfo,(t=>{var e,i;if(this.utmed===s.Start)return;this.utmed===s.End&&(this.reload=!0),this.utmed=s.Start,this.parseDefault(null!==(e=null==t?void 0:t.query)&&void 0!==e?e:{}),this.parseMore(null!==(i=null==t?void 0:t.query)&&void 0!==i?i:{})})),this.sdk.on(i.AppHide,(()=>{this.utmed=s.End}))}parseDefault(t={}){let s=!1;const i=Object.keys(t).reduce(((i,n)=>(this.sdk.UtmType.includes(n)&&(s=!0,i[n]=e(t[n])),i)),{});s&&this.sdk.env.set(i)}parseMore(t={}){const{tr_token:s="",surl_token:i="",scene:n=""}=t||{};let h=s||i;if(n){const t=(t=>{const e={};return t&&t.split("&").forEach((t=>{if(t){const s=t.split("=");s[0]&&(e[s[0]]=s[1]||"")}})),e})(e(`${n}`));t.tr_token&&(h=t.tr_token),this.sdk.set("scene_extra_query",t)}if(!h)return this.dispatch(),void 0;const d=()=>{this.reload?this.sdk.emit(this.sdk.types.CancelPause):this.dispatch()};this.reload&&this.sdk.emit(this.sdk.types.Pause),this.storageGet(h).then((t=>{t?(this.sdk.env.set(t.utms||{}),d()):this.fetch(h).then((()=>d())).catch((()=>d()))})).catch((()=>{this.fetch(h).then((()=>d())).catch((()=>d()))}))}storageGet(e){const s=this.sdk.getKey(this.key),{adapter:i}=this.sdk;return i.get(s).then((n=>{const h=t(),d=[];if(Object.keys(n).forEach((t=>{n[t]&&n[t].timestamp+864e7<h&&d.push(t)})),d.length>0&&(d.forEach((t=>{delete n[t]})),i.set(s,n)),n&&n[e])return n[e];return null}))}storageSet(e,s){const i=this.sdk.getKey(this.key),{adapter:n}=this.sdk;n.get(i).then((h=>{h||(h={}),h[e]={utms:s,timestamp:t()},n.set(i,h)}))}fetch(t){const{adapter:e,option:s,env:i,UtmType:n}=this.sdk;return e.request({url:`${s.get("domain")}/service/2/mp_campaigns`,method:"GET",data:{tr_token:t},timeout:3e3}).then((s=>{const{data:{code:h=-1,data:d={},message:a=""}={}}=s||{};if(0===h){if(this.sdk.isObject(d)){let e=!1;const s=Object.keys(d).reduce(((t,i)=>(n.includes(i)&&(e=!0,s[i]=d[i]),t)),{});e&&i.set(s),this.storageSet(t,s)}}else 40002===h&&this.storageSet(t,{});0!==h&&e.log(a||"")}))}dispatch(){this.sdk.emit(this.sdk.types.LaunchComplete)}}i.pluginName="official:utm";export{i as default};
