"use strict";var adbCommander=require("adb-commander"),chromeLauncher=require("chrome-simple-launcher"),path=require("path"),portfinder=require("portfinder"),request=require("request"),LOCAL_HOST="127.0.0.1",MIWEBVIEW_DEVTOOLS_PORT_REGEX=/((?:hybrid_)|(?:miui_))?webview_devtools_remote_(\d+)/,NETSTAT_STATUS_LISTENING="LISTENING",BROWSER_STRING="Browser",TITLE_STRING="title",WEBSOCKET_DEBUGGER_URL_STRING="webSocketDebuggerUrl",CHROME_INSPECTOR_URL="https://devtools.inf.miui.com/inspector/",CHROME_BUNDLED_INSPECTOR_URL="chrome-devtools://devtools/bundled/inspector.html",CHROME_INSPECTOR_QUERY="remoteFrontend=true&dockSide=undocked",useDesktopbundled=!1,printOnly=!1;function getInspectablePageListURL(e){return"http://".concat(LOCAL_HOST,":").concat(e,"/json/list")}function getInspectableVersionURL(e){return"http://".concat(LOCAL_HOST,":").concat(e,"/json/version")}function getInspectorUrl(e){if(e){if(useDesktopbundled)return CHROME_BUNDLED_INSPECTOR_URL;return e=61<e.split(".")[0]?"71.0.3578.132":"61.0.3163.128","".concat(CHROME_INSPECTOR_URL).concat(e,"/inspector.html")}}function forwardPort(o,e,t){portfinder.basePort=e,portfinder.getPortPromise().then(function(r){var e="tcp:".concat(r," localabstract:").concat(t);return console.log(e),adbCommander.exeCommand("adb -s ".concat(o," forward tcp:").concat(r," localabstract:").concat(t)).then(function(e){e.result;if(e.err)return console.log("Port forward already setup."),void getAvailablePages(r);console.log("Setup port forawrd."),getAvailablePages(r)})}).catch(function(){console.error("Can not find valid port forward.")})}function getAvailablePages(e){var t=getInspectablePageListURL(e),e=getInspectableVersionURL(e);request(e,function(e,r){if(e)return console.log("Error request version information"+e);r=JSON.parse(r.body)[BROWSER_STRING];if(!r)return console.log("Error, can't get chrome version.");var o=getInspectorUrl(r=r.split("/")[1]);request(t,function(e,r){return e?console.log("Error request inspectable pages: "+e):void JSON.parse(r.body).map(function(e){var r=e[TITLE_STRING],e=e[WEBSOCKET_DEBUGGER_URL_STRING];e&&(e=e.replace("ws://","ws="),e="".concat(o,"?").concat(CHROME_INSPECTOR_QUERY,"&").concat(e),console.log("Page: "+r),console.log("    Debugger URL: "+e),printOnly||chromeLauncher.launch(e).then(function(){console.log("Debugger URL opened in Chrome.")}))})})})}function getDebuggerUrl(){adbCommander.deviceList().then(function(e,r){if(!r){e=e.deviceList;if(0===e.length)throw new Error("No Device attached to PC.");return Promise.all(e.map(function(n){return new Promise(function(r,o){adbCommander.exeCommand("adb shell netstat -anl").then(function(e){var r=e.result;e.err;if(!r)throw new Error("No network connections.");r.trim().split("\n").map(function(e){var o,t;-1===e.search(NETSTAT_STATUS_LISTENING)||(o=e.match(MIWEBVIEW_DEVTOOLS_PORT_REGEX))&&(t=o[2],adbCommander.exeCommand("adb -s ".concat(n," shell ps ").concat(t)).then(function(e){var r=e.result,r=(e.err,r.trim().split("\n")[1]);r&&r.match(/com.miui.hybrid:Launcher(\d+)/)&&forwardPort(n,t,o[0])}))})}).then(function(e){return r(e)}).catch(function(e){return o(e)})})}))}console.error("fail to execute adb devices")}).then(function(){console.log("Debugger setup.")}).catch(function(e){console.error("Error in generating debugger URL:",e.stack)})}module.exports=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};e.useDesktopbundled&&(useDesktopbundled=!0),e.printOnly&&(printOnly=!0),adbCommander.exeCommand("adb forward --remove-all").then(function(e,r){r&&console.error("Error clear port forward"),getDebuggerUrl()})};