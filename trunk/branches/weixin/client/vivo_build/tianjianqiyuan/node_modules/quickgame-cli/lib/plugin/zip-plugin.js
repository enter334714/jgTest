"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_dayjs=_interopRequireDefault(require("dayjs")),_utils=require("../utils"),_rpks=require("../subpackages/rpks");function resolveFiles(e,t){e=(0,_utils.lsdirdeep)(e);return e.includes(_rpks.DIGEST_ZIP_PATH)?(console.warning("检测到存在快游戏保留文件: ".concat(_rpks.DIGEST_ZIP_PATH)),!1):e=(0,_utils.sortFilesBy)(e,t)}function ZipPlugin(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.options=Object.assign({priorities:["manifest.json","main.js"]},e)}function generateDistFile(e,t,i,a){var r="".concat(t.name,".").concat(t.sign,".").concat(a),s=_path.default.join(t.output,r);_fs.default.writeFileSync(s,e),_utils.colorconsole.log("### App Loader ### dist目录签名并生成".concat(a,"文件：").concat(r)),!i&&t.copyRpk&&(i=(0,_dayjs.default)().format("YYYYMMDDhhmmss"),i="".concat(t.name,"_").concat(t.sign,"_").concat(t.versionCode,"_").concat(i,".").concat(a),t=_path.default.join(t.output,i),_fs.default.writeFileSync(t,e),_utils.colorconsole.log("### App Loader ### 复制".concat(a,"文件(").concat(r,")为文件(").concat(i,")")))}ZipPlugin.prototype.apply=function(n){var c,u=this.options,e=u.projectPath,l={debug:{privatekey:_path.default.join(e,"sign/debug","private.pem"),certificate:_path.default.join(e,"sign/debug","certificate.pem")},release:{privatekey:_path.default.join(e,"sign/release","private.pem"),certificate:_path.default.join(e,"sign/release","certificate.pem")}}[u.sign];!u.disableSubpackages&&u.subpackages&&0<u.subpackages.length&&(c=u.subpackages),n.hooks.afterEmit.tapAsync("ZipPlugin",function(e,a){if(!l)return _utils.colorconsole.log("### App Loader ### 无签名配置项, 放弃打包: "+u.sign),void a();var t=l.privatekey,i=l.certificate;if(!_fs.default.existsSync(t))return _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+t),void a();if(!_fs.default.existsSync(i))return _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+i),void a();t=_fs.default.readFileSync(t),i=_fs.default.readFileSync(i);var r,s,o=resolveFiles(u.pathBuild,u.priorities);!1!==o?(r=(s=(0,_rpks.createPackagesDefinition)(c)).fullPackage,s=s.subPackages,(0,_rpks.allocateResourceToPackages)(o,u.pathBuild,r,s),(0,_rpks.signZipPkgs)(u.name,t,i,r,s,u.disableStreamPack).then(function(e){var t=e.rpksBuffer,i=e.rpkBuffer;_fs.default.mkdir(u.output,function(){generateDistFile(t||i,u,n.watchMode,"rpk"),a()})})):a()})},module.exports=ZipPlugin;