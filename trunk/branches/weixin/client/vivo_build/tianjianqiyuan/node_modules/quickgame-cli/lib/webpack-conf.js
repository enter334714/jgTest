"use strict";var projectPath,manifestJson,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_del=_interopRequireDefault(require("del")),_zipPlugin=_interopRequireDefault(require("./plugin/zip-plugin")),_resourcePlugin=_interopRequireDefault(require("./plugin/resource-plugin")),_notifyPlugin=_interopRequireDefault(require("./plugin/notify-plugin")),_utils=require("./utils"),excludeDir=[".DS_Store","Thumbs.db",".idea","build","dist","sign","node_modules"],MAIN_PKG_NAME="base",RPKS_SUPPORT_VERSION_FROM=1040;function checkConfig(e,t,o){_fs.default.existsSync(o)?validateManifest(e,t):_utils.colorconsole.error("项目 ".concat(o," 下找不到入口文件 main.js"))}function validateManifest(e,t){t.icon||_utils.colorconsole.error("manifest.json 中未配置图标icon"),t.package||_utils.colorconsole.error("manifest.json 未定义包名(package)");t=t.subpackages;!e.disableSubpackages&&t&&1<t.length&&validateManifestSubpackages(t)}function useStrictMode(e){var t,o=_path.default.join(projectPath,"package.json");_fs.default.existsSync(o)?(t=JSON.parse(_fs.default.readFileSync(o)),e?t.babel&&(delete t.babel,_fs.default.writeFileSync(o,JSON.stringify(t,null,"\t")),console.info('编译代码进行严格模式声明："use strict"')):t.babel||(t.babel={plugins:["babel-plugin-transform-remove-strict-mode"]},_fs.default.writeFileSync(o,JSON.stringify(t,null,"\t")))):console.info("请查看 ".concat(o," 路径下是否存在package.json文件"))}function findUxFilesByManifest(e,t){var o=[];o.push({resource:"main.js"});var a=t.subpackages;return t&&a&&a.forEach(function(e){o.push(e)}),o}function collectFiles(e,a){var n=_path.default.resolve(projectPath,e),s=new RegExp("(".concat(excludeDir.join("|"),")"));_fs.default.readdirSync(n).forEach(function(e){var t,o;e.match(s)||(t=_path.default.resolve(n,e),(o=_fs.default.statSync(t)).isFile()&&".js"===_path.default.extname(e)&&!e.match(/cocos.*/g)?(t=_path.default.relative(projectPath,t).replace(/\\/,"/"),a.push({resource:t})):o.isDirectory()&&collectFiles(t,a))})}function buildWebpackEntries(e){var n,s={};return e.forEach(function(e){var t,o=e.resource||e.root,a=_path.default.extname(o),e=o.replace(a,"");n=a?(t=o.replace(a,""),_path.default.join(projectPath,t)):(/\.js$/.test(t=o)?t=o:/\/$/.test(o)?(t=o+"main.js",e=o+"main"):_utils.colorconsole.throw("manifest.json中的文件路劲配置存在问题".concat(o)),_path.default.join(projectPath,t)),s[e]=n}),s}function getJson(e){var t;return _fs.default.existsSync(e)&&(t=JSON.parse(_fs.default.readFileSync(e))),t||{}}function validateManifestSubpackages(e){var o,a,n,s,r=[],i=[];e.forEach(function(e,t){o=e.name,a=e.resource||e.root,n=a&&_path.default.join(projectPath,a),s=t+1,o?o===MAIN_PKG_NAME?_utils.colorconsole.throw("第".concat(s,"分包的名字'").concat(o,"'是主包保留名，请修改")):-1<r.indexOf(o)?_utils.colorconsole.throw("第".concat(s,"分包的名字'").concat(o,"'已存在，请修改")):r.push(o):_utils.colorconsole.throw("第".concat(s,"分包的名字不能为空，请添加")),a?-1<i.indexOf(a)?_utils.colorconsole.throw("第".concat(s,"分包的资源'").concat(a,"'已被使用，请修改")):_fs.default.existsSync(n)||_utils.colorconsole.throw("第".concat(s,"分包的资源'").concat(a,"', 文件目录'").concat(n,"'不存在，请修改")):_utils.colorconsole.throw("第".concat(s,"分包的资源名不能为空，请添加"))});e=manifestJson.minPlatformVersion;parseInt(e)<RPKS_SUPPORT_VERSION_FROM&&_utils.colorconsole.warn("项目已配置分包，若想使用分包功能，请确保平台版本 >= ".concat(RPKS_SUPPORT_VERSION_FROM))}module.exports=function(e,t){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";projectPath=o||process.cwd();var a=_path.default.resolve(projectPath,"build"),n=_path.default.resolve(projectPath,"dist"),s=_path.default.resolve(projectPath,"manifest.json"),r={appPackageName:(manifestJson=getJson(s)).package},i=_path.default.join(projectPath,"main.js");checkConfig(e,manifestJson,i);var c=buildWebpackEntries(findUxFilesByManifest(e.cocosWxGame,manifestJson));e.server||_del.default.sync([n,a]),useStrictMode(e.strictMode);var l="production"===t,u=l?"release":"debug",f=l?"none":"source-map",s=e.watch||!1,i=manifestJson.subpackages,l={mode:t,entry:c,output:{path:a,filename:"[name].js"},context:o||_path.default.resolve(__dirname),module:{rules:[]},watch:s,watchOptions:{ignored:/node_modules/},devtool:f,resolve:{modules:["./","node_modules"]},node:{global:!1,url:!0,process:!1,fs:"empty",Buffer:!1},resolveLoader:{modules:[_path.default.resolve(__dirname,"./loaders"),"node_modules"]},plugins:[new _zipPlugin.default({name:manifestJson.package,versionCode:manifestJson.versionCode,projectPath:projectPath,output:n,pathBuild:a,sign:u,priorities:["manifest.json","main.js"],subpackages:i,copyRpk:e.copyRpk,disableStreamPack:e.disableStreamPack,disableSubpackages:e.disableSubpackages}),new _resourcePlugin.default({pathBuild:a,sign:l,projectPath:projectPath,ignoreDir:e.ignore,cocosWxGame:e.cocosWxGame,includeFileExt:e.includeFileExt})],externals:[function(e,t,o){if(t.match(/@\w+(.\w+)+/g))return o(null,'$require$("@module/'.concat(t.slice(1),'")'));o()}]};return e.jestMode||l.plugins.push(new _notifyPlugin.default),e.cocosWxGame&&l.module.rules.push({parser:{system:!1}},{test:/\.js$/,use:{loader:"resolveRequire"}}),{webpackConf:l,exOptions:r}};